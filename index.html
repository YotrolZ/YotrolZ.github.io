<!DOCTYPE html>
<html lang="en">
  <head><meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>


<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">

<link rel="alternate" href="/atom.xml" title="YotrolZ" type="application/atom+xml"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=2.11.0" />
<link rel="canonical" href="http://yotrolz.com/"/>

<link rel="stylesheet" type="text/css" href="/lib/fancybox/jquery.fancybox.css" />
<link rel="stylesheet" type="text/css" href="/css/style.css?v=2.11.0" />

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-138610487-3"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-138610487-3');
</script><script id="baidu_push">
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>
<script>
  window.config = {"leancloud":{"app_id":null,"app_key":null},"toc":true,"fancybox":true,"pjax":"","latex":false};
</script>

    <title>YotrolZ</title>
  <meta name="generator" content="Hexo 5.2.0"></head>

  <body><div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/." class="logo">YotrolZ</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>

<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list"><a href="/">
        <li class="mobile-menu-item">Home
          </li>
      </a><a href="/archives/">
        <li class="mobile-menu-item">Archives
          </li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags
          </li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories
          </li>
      </a></ul>
</nav>
<div class="container" id="mobile-panel">
      <header id="header" class="header"><div class="logo-wrapper">
  <a href="/." class="logo">YotrolZ</a>
</div>

<nav class="site-navbar"><ul id="menu" class="menu"><li class="menu-item">
          <a class="menu-item-link" href="/">
            Home
            </a>
        </li>
      <li class="menu-item">
          <a class="menu-item-link" href="/archives/">
            Archives
            </a>
        </li>
      <li class="menu-item">
          <a class="menu-item-link" href="/tags/">
            Tags
            </a>
        </li>
      <li class="menu-item">
          <a class="menu-item-link" href="/categories/">
            Categories
            </a>
        </li>
      </ul></nav>
</header>

      <main id="main" class="main">
        <div class="content-wrapper">
          <div id="content" class="content"><section id="posts" class="posts"><article class="post">
    <header class="post-header">
      <h1 class="post-title"><a class="post-link" href="/posts/993b4752/">再说iOS中的Class</a>
        </h1>

      <div class="post-meta">
        <span class="post-time">
          2021-02-25
        </span></div>
    </header>

    <div class="post-content"><p>OBJC源码地址：<a target="_blank" rel="noopener" href="https://opensource.apple.com/tarballs/objc4/">https://opensource.apple.com/tarballs/objc4/</a></p>
<h2 id="objc-class"><a href="#objc-class" class="headerlink" title="objc_class"></a>objc_class</h2><p>说起iOS中的Class, 网上一大推的文章，那必定会提到<code>objc_class</code>,你是否见过如下代码：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> objc_class &#123;</span><br><span class="line">    Class _Nonnull isa  OBJC_ISA_AVAILABILITY;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !__OBJC2__</span></span><br><span class="line">    Class _Nullable super_class                              OBJC2_UNAVAILABLE;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> * _Nonnull name                               OBJC2_UNAVAILABLE;</span><br><span class="line">    <span class="keyword">long</span> version                                             OBJC2_UNAVAILABLE;</span><br><span class="line">    <span class="keyword">long</span> info                                                OBJC2_UNAVAILABLE;</span><br><span class="line">    <span class="keyword">long</span> instance_size                                       OBJC2_UNAVAILABLE;</span><br><span class="line">    <span class="keyword">struct</span> objc_ivar_list * _Nullable ivars                  OBJC2_UNAVAILABLE;</span><br><span class="line">    <span class="keyword">struct</span> objc_method_list * _Nullable * _Nullable methodLists                    OBJC2_UNAVAILABLE;</span><br><span class="line">    <span class="keyword">struct</span> objc_cache * _Nonnull cache                       OBJC2_UNAVAILABLE;</span><br><span class="line">    <span class="keyword">struct</span> objc_protocol_list * _Nullable protocols          OBJC2_UNAVAILABLE;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">&#125; OBJC2_UNAVAILABLE;</span><br><span class="line"><span class="comment">/* Use `Class` instead of `struct objc_class *` */</span></span><br></pre></td></tr></table></figure>

<h3 id="OBJC2-UNAVAILABLE和OBJC2"><a href="#OBJC2-UNAVAILABLE和OBJC2" class="headerlink" title="OBJC2_UNAVAILABLE和OBJC2"></a>OBJC2_UNAVAILABLE和<strong>OBJC2</strong></h3><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Define __OBJC2__ for the benefit of our asm files.</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> __OBJC2__</span></span><br><span class="line"><span class="meta">#   <span class="meta-keyword">if</span> TARGET_OS_OSX  &amp;&amp;  !TARGET_OS_IOSMAC  &amp;&amp;  __i386__</span></span><br><span class="line">        <span class="comment">// old ABI</span></span><br><span class="line"><span class="meta">#   <span class="meta-keyword">else</span></span></span><br><span class="line"><span class="meta">#       <span class="meta-keyword">define</span> __OBJC2__ 1</span></span><br><span class="line"><span class="meta">#   <span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* OBJC2_UNAVAILABLE: unavailable in objc 2.0, deprecated in Leopard */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !defined(OBJC2_UNAVAILABLE)</span></span><br><span class="line"><span class="meta">#   <span class="meta-keyword">if</span> __OBJC2__</span></span><br><span class="line"><span class="meta">#       <span class="meta-keyword">define</span> OBJC2_UNAVAILABLE UNAVAILABLE_ATTRIBUTE</span></span><br><span class="line"><span class="meta">#   <span class="meta-keyword">else</span></span></span><br><span class="line">        <span class="comment">/* plain C code also falls here, but this is close enough */</span></span><br><span class="line"><span class="meta">#       <span class="meta-keyword">define</span> OBJC2_UNAVAILABLE                                       \</span></span><br><span class="line">            __OSX_DEPRECATED(<span class="number">10.5</span>, <span class="number">10.5</span>, <span class="string">&quot;not available in __OBJC2__&quot;</span>) \</span><br><span class="line">            __IOS_DEPRECATED(<span class="number">2.0</span>, <span class="number">2.0</span>, <span class="string">&quot;not available in __OBJC2__&quot;</span>)   \</span><br><span class="line">            __TVOS_UNAVAILABLE __WATCHOS_UNAVAILABLE __BRIDGEOS_UNAVAILABLE</span><br><span class="line"><span class="meta">#   <span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<ul>
<li>在2006年7月苹果全球开发者会议中，Apple宣布了“Objective-C 2.0”的发布，其增加了“现代的垃圾收集，语法改进，运行时性能改进，以及64位支持”。</li>
<li>2007年10月发布的Mac OS X v10.5中包含了Objective-C 2.0的编译器。</li>
</ul>
<p>由此可见：上述<code>objc_class</code>代码在Objective-C 2.0中<code>已经过期</code>了;</p>
<h2 id="objc-object"><a href="#objc-object" class="headerlink" title="objc_object"></a>objc_object</h2><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !OBJC_TYPES_DEFINED</span></span><br><span class="line"><span class="comment">/// An opaque type that represents an Objective-C class.</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> objc_class *Class;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// Represents an instance of a class.</span></span><br><span class="line"><span class="keyword">struct</span> objc_object &#123;</span><br><span class="line">    Class _Nonnull isa  OBJC_ISA_AVAILABILITY;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// A pointer to an instance of a class.</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> objc_object *<span class="keyword">id</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>


<h2 id="OBJC-TYPES-DEFINED和OBJC-ISA-AVAILABILITY"><a href="#OBJC-TYPES-DEFINED和OBJC-ISA-AVAILABILITY" class="headerlink" title="OBJC_TYPES_DEFINED和OBJC_ISA_AVAILABILITY"></a>OBJC_TYPES_DEFINED和OBJC_ISA_AVAILABILITY</h2><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// objc-private.h 41行</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> OBJC_TYPES_DEFINED 1</span></span><br></pre></td></tr></table></figure>

<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* OBJC_ISA_AVAILABILITY: `isa` will be deprecated or unavailable </span></span><br><span class="line"><span class="comment"> * in the future */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !defined(OBJC_ISA_AVAILABILITY)</span></span><br><span class="line"><span class="meta">#   <span class="meta-keyword">if</span> __OBJC2__</span></span><br><span class="line"><span class="meta">#       <span class="meta-keyword">define</span> OBJC_ISA_AVAILABILITY  __attribute__((deprecated))</span></span><br><span class="line"><span class="meta">#   <span class="meta-keyword">else</span></span></span><br><span class="line"><span class="meta">#       <span class="meta-keyword">define</span> OBJC_ISA_AVAILABILITY  <span class="comment">/* still available */</span></span></span><br><span class="line"><span class="meta">#   <span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>由此可见：上述<code>objc_object</code>中的代码也是<code>无效的</code></p>
<p>了解了上述说明后，我们再次看Runtime源码，就要排除部分代码的干扰了</p>
<h2 id="再说-objc-class"><a href="#再说-objc-class" class="headerlink" title="再说 objc_class"></a>再说 objc_class</h2><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// objc-runtime-new.h 1111行</span></span><br><span class="line"><span class="keyword">struct</span> objc_class : objc_object &#123;</span><br><span class="line">    <span class="comment">// Class ISA;</span></span><br><span class="line">    Class superclass;</span><br><span class="line">    cache_t cache;             <span class="comment">// formerly cache pointer and vtable</span></span><br><span class="line">    class_data_bits_t bits;    <span class="comment">// class_rw_t * plus custom rr/alloc flags</span></span><br><span class="line"></span><br><span class="line">    class_rw_t *data() &#123; </span><br><span class="line">        <span class="keyword">return</span> bits.data();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">void</span> setData(class_rw_t *newData) &#123;</span><br><span class="line">        bits.setData(newData);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> setInfo(uint32_t set) &#123;</span><br><span class="line">        assert(isFuture()  ||  isRealized());</span><br><span class="line">        data()-&gt;setFlags(set);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> clearInfo(uint32_t clear) &#123;</span><br><span class="line">        assert(isFuture()  ||  isRealized());</span><br><span class="line">        data()-&gt;clearFlags(clear);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// set and clear must not overlap</span></span><br><span class="line">    <span class="keyword">void</span> changeInfo(uint32_t set, uint32_t clear) &#123;</span><br><span class="line">        assert(isFuture()  ||  isRealized());</span><br><span class="line">        assert((set &amp; clear) == <span class="number">0</span>);</span><br><span class="line">        data()-&gt;changeFlags(set, clear);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">bool</span> hasCustomRR() &#123;</span><br><span class="line">        <span class="keyword">return</span> ! bits.hasDefaultRR();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">void</span> setHasDefaultRR() &#123;</span><br><span class="line">        assert(isInitializing());</span><br><span class="line">        bits.setHasDefaultRR();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">void</span> setHasCustomRR(<span class="keyword">bool</span> inherited = <span class="literal">false</span>);</span><br><span class="line">    <span class="keyword">void</span> printCustomRR(<span class="keyword">bool</span> inherited);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">bool</span> hasCustomAWZ() &#123;</span><br><span class="line">        <span class="keyword">return</span> ! bits.hasDefaultAWZ();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">void</span> setHasDefaultAWZ() &#123;</span><br><span class="line">        assert(isInitializing());</span><br><span class="line">        bits.setHasDefaultAWZ();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">void</span> setHasCustomAWZ(<span class="keyword">bool</span> inherited = <span class="literal">false</span>);</span><br><span class="line">    <span class="keyword">void</span> printCustomAWZ(<span class="keyword">bool</span> inherited);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">bool</span> instancesRequireRawIsa() &#123;</span><br><span class="line">        <span class="keyword">return</span> bits.instancesRequireRawIsa();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">void</span> setInstancesRequireRawIsa(<span class="keyword">bool</span> inherited = <span class="literal">false</span>);</span><br><span class="line">    <span class="keyword">void</span> printInstancesRequireRawIsa(<span class="keyword">bool</span> inherited);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">bool</span> canAllocNonpointer() &#123;</span><br><span class="line">        assert(!isFuture());</span><br><span class="line">        <span class="keyword">return</span> !instancesRequireRawIsa();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">bool</span> canAllocFast() &#123;</span><br><span class="line">        assert(!isFuture());</span><br><span class="line">        <span class="keyword">return</span> bits.canAllocFast();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">bool</span> hasCxxCtor() &#123;</span><br><span class="line">        <span class="comment">// addSubclass() propagates this flag from the superclass.</span></span><br><span class="line">        assert(isRealized());</span><br><span class="line">        <span class="keyword">return</span> bits.hasCxxCtor();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">void</span> setHasCxxCtor() &#123; </span><br><span class="line">        bits.setHasCxxCtor();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">bool</span> hasCxxDtor() &#123;</span><br><span class="line">        <span class="comment">// addSubclass() propagates this flag from the superclass.</span></span><br><span class="line">        assert(isRealized());</span><br><span class="line">        <span class="keyword">return</span> bits.hasCxxDtor();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">void</span> setHasCxxDtor() &#123; </span><br><span class="line">        bits.setHasCxxDtor();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">bool</span> isSwiftStable() &#123;</span><br><span class="line">        <span class="keyword">return</span> bits.isSwiftStable();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">bool</span> isSwiftLegacy() &#123;</span><br><span class="line">        <span class="keyword">return</span> bits.isSwiftLegacy();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">bool</span> isAnySwift() &#123;</span><br><span class="line">        <span class="keyword">return</span> bits.isAnySwift();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Return YES if the class&#x27;s ivars are managed by ARC, </span></span><br><span class="line">    <span class="comment">// or the class is MRC but has ARC-style weak ivars.</span></span><br><span class="line">    <span class="keyword">bool</span> hasAutomaticIvars() &#123;</span><br><span class="line">        <span class="keyword">return</span> data()-&gt;ro-&gt;flags &amp; (RO_IS_ARC | RO_HAS_WEAK_WITHOUT_ARC);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Return YES if the class&#x27;s ivars are managed by ARC.</span></span><br><span class="line">    <span class="keyword">bool</span> isARC() &#123;</span><br><span class="line">        <span class="keyword">return</span> data()-&gt;ro-&gt;flags &amp; RO_IS_ARC;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> SUPPORT_NONPOINTER_ISA</span></span><br><span class="line">    <span class="comment">// Tracked in non-pointer isas; not tracked otherwise</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">    <span class="keyword">bool</span> instancesHaveAssociatedObjects() &#123;</span><br><span class="line">        <span class="comment">// this may be an unrealized future class in the CF-bridged case</span></span><br><span class="line">        assert(isFuture()  ||  isRealized());</span><br><span class="line">        <span class="keyword">return</span> data()-&gt;flags &amp; RW_INSTANCES_HAVE_ASSOCIATED_OBJECTS;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> setInstancesHaveAssociatedObjects() &#123;</span><br><span class="line">        <span class="comment">// this may be an unrealized future class in the CF-bridged case</span></span><br><span class="line">        assert(isFuture()  ||  isRealized());</span><br><span class="line">        setInfo(RW_INSTANCES_HAVE_ASSOCIATED_OBJECTS);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">bool</span> shouldGrowCache() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> setShouldGrowCache(<span class="keyword">bool</span>) &#123;</span><br><span class="line">        <span class="comment">// fixme good or bad for memory use?</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">bool</span> isInitializing() &#123;</span><br><span class="line">        <span class="keyword">return</span> getMeta()-&gt;data()-&gt;flags &amp; RW_INITIALIZING;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> setInitializing() &#123;</span><br><span class="line">        assert(!isMetaClass());</span><br><span class="line">        ISA()-&gt;setInfo(RW_INITIALIZING);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">bool</span> isInitialized() &#123;</span><br><span class="line">        <span class="keyword">return</span> getMeta()-&gt;data()-&gt;flags &amp; RW_INITIALIZED;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> setInitialized();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">bool</span> isLoadable() &#123;</span><br><span class="line">        assert(isRealized());</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;  <span class="comment">// any class registered for +load is definitely loadable</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    IMP getLoadMethod();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Locking: To prevent concurrent realization, hold runtimeLock.</span></span><br><span class="line">    <span class="keyword">bool</span> isRealized() &#123;</span><br><span class="line">        <span class="keyword">return</span> data()-&gt;flags &amp; RW_REALIZED;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Returns true if this is an unrealized future class.</span></span><br><span class="line">    <span class="comment">// Locking: To prevent concurrent realization, hold runtimeLock.</span></span><br><span class="line">    <span class="keyword">bool</span> isFuture() &#123; </span><br><span class="line">        <span class="keyword">return</span> data()-&gt;flags &amp; RW_FUTURE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">bool</span> isMetaClass() &#123;</span><br><span class="line">        assert(<span class="keyword">this</span>);</span><br><span class="line">        assert(isRealized());</span><br><span class="line">        <span class="keyword">return</span> data()-&gt;ro-&gt;flags &amp; RO_META;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// NOT identical to this-&gt;ISA when this is a metaclass</span></span><br><span class="line">    Class getMeta() &#123;</span><br><span class="line">        <span class="keyword">if</span> (isMetaClass()) <span class="keyword">return</span> (Class)<span class="keyword">this</span>;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">return</span> <span class="keyword">this</span>-&gt;ISA();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">bool</span> isRootClass() &#123;</span><br><span class="line">        <span class="keyword">return</span> superclass == <span class="literal">nil</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">bool</span> isRootMetaclass() &#123;</span><br><span class="line">        <span class="keyword">return</span> ISA() == (Class)<span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *mangledName() &#123; </span><br><span class="line">        <span class="comment">// fixme can&#x27;t assert locks here</span></span><br><span class="line">        assert(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (isRealized()  ||  isFuture()) &#123;</span><br><span class="line">            <span class="keyword">return</span> data()-&gt;ro-&gt;name;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> ((<span class="keyword">const</span> class_ro_t *)data())-&gt;name;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *demangledName(<span class="keyword">bool</span> realize = <span class="literal">false</span>);</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *nameForLogging();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// May be unaligned depending on class&#x27;s ivars.</span></span><br><span class="line">    uint32_t unalignedInstanceStart() &#123;</span><br><span class="line">        assert(isRealized());</span><br><span class="line">        <span class="keyword">return</span> data()-&gt;ro-&gt;instanceStart;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Class&#x27;s instance start rounded up to a pointer-size boundary.</span></span><br><span class="line">    <span class="comment">// This is used for ARC layout bitmaps.</span></span><br><span class="line">    uint32_t alignedInstanceStart() &#123;</span><br><span class="line">        <span class="keyword">return</span> word_align(unalignedInstanceStart());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// May be unaligned depending on class&#x27;s ivars.</span></span><br><span class="line">    uint32_t unalignedInstanceSize() &#123;</span><br><span class="line">        assert(isRealized());</span><br><span class="line">        <span class="keyword">return</span> data()-&gt;ro-&gt;instanceSize;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Class&#x27;s ivar size rounded up to a pointer-size boundary.</span></span><br><span class="line">    uint32_t alignedInstanceSize() &#123;</span><br><span class="line">        <span class="keyword">return</span> word_align(unalignedInstanceSize());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    size_t instanceSize(size_t extraBytes) &#123;</span><br><span class="line">        size_t size = alignedInstanceSize() + extraBytes;</span><br><span class="line">        <span class="comment">// CF requires all objects be at least 16 bytes.</span></span><br><span class="line">        <span class="keyword">if</span> (size &lt; <span class="number">16</span>) size = <span class="number">16</span>;</span><br><span class="line">        <span class="keyword">return</span> size;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> setInstanceSize(uint32_t newSize) &#123;</span><br><span class="line">        assert(isRealized());</span><br><span class="line">        <span class="keyword">if</span> (newSize != data()-&gt;ro-&gt;instanceSize) &#123;</span><br><span class="line">            assert(data()-&gt;flags &amp; RW_COPIED_RO);</span><br><span class="line">            *const_cast&lt;uint32_t *&gt;(&amp;data()-&gt;ro-&gt;instanceSize) = newSize;</span><br><span class="line">        &#125;</span><br><span class="line">        bits.setFastInstanceSize(newSize);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> chooseClassArrayIndex();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> setClassArrayIndex(<span class="keyword">unsigned</span> Idx) &#123;</span><br><span class="line">        bits.setClassArrayIndex(Idx);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">unsigned</span> classArrayIndex() &#123;</span><br><span class="line">        <span class="keyword">return</span> bits.classArrayIndex();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="objc-object-1"><a href="#objc-object-1" class="headerlink" title="objc_object"></a>objc_object</h2><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> objc_object &#123;</span><br><span class="line">private:</span><br><span class="line">    isa_t isa;</span><br><span class="line"></span><br><span class="line">public:</span><br><span class="line">    <span class="comment">// isa相关方法</span></span><br><span class="line">    <span class="comment">// ISA() assumes this is NOT a tagged pointer object</span></span><br><span class="line">    Class ISA();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// getIsa() allows this to be a tagged pointer object</span></span><br><span class="line">    Class getIsa();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// initIsa() should be used to init the isa of new objects only.</span></span><br><span class="line">    <span class="comment">// If this object already has an isa, use changeIsa() for correctness.</span></span><br><span class="line">    <span class="comment">// initInstanceIsa(): objects with no custom RR/AWZ</span></span><br><span class="line">    <span class="comment">// initClassIsa(): class objects</span></span><br><span class="line">    <span class="comment">// initProtocolIsa(): protocol objects</span></span><br><span class="line">    <span class="comment">// initIsa(): other objects</span></span><br><span class="line">    <span class="keyword">void</span> initIsa(Class cls <span class="comment">/*nonpointer=false*/</span>);</span><br><span class="line">    <span class="keyword">void</span> initClassIsa(Class cls <span class="comment">/*nonpointer=maybe*/</span>);</span><br><span class="line">    <span class="keyword">void</span> initProtocolIsa(Class cls <span class="comment">/*nonpointer=maybe*/</span>);</span><br><span class="line">    <span class="keyword">void</span> initInstanceIsa(Class cls, <span class="keyword">bool</span> hasCxxDtor);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// changeIsa() should be used to change the isa of existing objects.</span></span><br><span class="line">    <span class="comment">// If this is a new object, use initIsa() for performance.</span></span><br><span class="line">    Class changeIsa(Class newCls);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">bool</span> hasNonpointerIsa();</span><br><span class="line">    <span class="keyword">bool</span> isTaggedPointer();</span><br><span class="line">    <span class="keyword">bool</span> isBasicTaggedPointer();</span><br><span class="line">    <span class="keyword">bool</span> isExtTaggedPointer();</span><br><span class="line">    <span class="keyword">bool</span> isClass();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 关联对象相关方法</span></span><br><span class="line">    <span class="comment">// object may have associated objects?</span></span><br><span class="line">    <span class="keyword">bool</span> hasAssociatedObjects();</span><br><span class="line">    <span class="keyword">void</span> setHasAssociatedObjects();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 弱引用相关方法</span></span><br><span class="line">    <span class="comment">// object may be weakly referenced?</span></span><br><span class="line">    <span class="keyword">bool</span> isWeaklyReferenced();</span><br><span class="line">    <span class="keyword">void</span> setWeaklyReferenced_nolock();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// object may have -.cxx_destruct implementation?</span></span><br><span class="line">    <span class="keyword">bool</span> hasCxxDtor();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 内存管理相关方法</span></span><br><span class="line">    <span class="comment">// Optimized calls to retain/release methods</span></span><br><span class="line">    <span class="keyword">id</span> <span class="keyword">retain</span>();</span><br><span class="line">    <span class="keyword">void</span> release();</span><br><span class="line">    <span class="keyword">id</span> autorelease();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Implementations of retain/release methods</span></span><br><span class="line">    <span class="keyword">id</span> rootRetain();</span><br><span class="line">    <span class="keyword">bool</span> rootRelease();</span><br><span class="line">    <span class="keyword">id</span> rootAutorelease();</span><br><span class="line">    <span class="keyword">bool</span> rootTryRetain();</span><br><span class="line">    <span class="keyword">bool</span> rootReleaseShouldDealloc();</span><br><span class="line">    uintptr_t rootRetainCount();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Implementation of dealloc methods</span></span><br><span class="line">    <span class="keyword">bool</span> rootIsDeallocating();</span><br><span class="line">    <span class="keyword">void</span> clearDeallocating();</span><br><span class="line">    <span class="keyword">void</span> rootDealloc();</span><br><span class="line"></span><br><span class="line">private:</span><br><span class="line">    <span class="keyword">void</span> initIsa(Class newCls, <span class="keyword">bool</span> nonpointer, <span class="keyword">bool</span> hasCxxDtor);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Slow paths for inline control</span></span><br><span class="line">    <span class="keyword">id</span> rootAutorelease2();</span><br><span class="line">    <span class="keyword">bool</span> overrelease_error();</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> SUPPORT_NONPOINTER_ISA</span></span><br><span class="line">    <span class="comment">// Unified retain count manipulation for nonpointer isa</span></span><br><span class="line">    <span class="keyword">id</span> rootRetain(<span class="keyword">bool</span> tryRetain, <span class="keyword">bool</span> handleOverflow);</span><br><span class="line">    <span class="keyword">bool</span> rootRelease(<span class="keyword">bool</span> performDealloc, <span class="keyword">bool</span> handleUnderflow);</span><br><span class="line">    <span class="keyword">id</span> rootRetain_overflow(<span class="keyword">bool</span> tryRetain);</span><br><span class="line">    <span class="keyword">bool</span> rootRelease_underflow(<span class="keyword">bool</span> performDealloc);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> clearDeallocating_slow();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Side table retain count overflow for nonpointer isa</span></span><br><span class="line">    <span class="keyword">void</span> sidetable_lock();</span><br><span class="line">    <span class="keyword">void</span> sidetable_unlock();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> sidetable_moveExtraRC_nolock(size_t extra_rc, <span class="keyword">bool</span> isDeallocating, <span class="keyword">bool</span> weaklyReferenced);</span><br><span class="line">    <span class="keyword">bool</span> sidetable_addExtraRC_nolock(size_t delta_rc);</span><br><span class="line">    size_t sidetable_subExtraRC_nolock(size_t delta_rc);</span><br><span class="line">    size_t sidetable_getExtraRC_nolock();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Side-table-only retain count</span></span><br><span class="line">    <span class="keyword">bool</span> sidetable_isDeallocating();</span><br><span class="line">    <span class="keyword">void</span> sidetable_clearDeallocating();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">bool</span> sidetable_isWeaklyReferenced();</span><br><span class="line">    <span class="keyword">void</span> sidetable_setWeaklyReferenced_nolock();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">id</span> sidetable_retain();</span><br><span class="line">    <span class="keyword">id</span> sidetable_retain_slow(SideTable&amp; table);</span><br><span class="line"></span><br><span class="line">    uintptr_t sidetable_release(<span class="keyword">bool</span> performDealloc = <span class="literal">true</span>);</span><br><span class="line">    uintptr_t sidetable_release_slow(SideTable&amp; table, <span class="keyword">bool</span> performDealloc = <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">bool</span> sidetable_tryRetain();</span><br><span class="line"></span><br><span class="line">    uintptr_t sidetable_retainCount();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> DEBUG</span></span><br><span class="line">    <span class="keyword">bool</span> sidetable_present();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>


        </div></article>
      <article class="post">
    <header class="post-header">
      <h1 class="post-title"><a class="post-link" href="/posts/687bc3c9/">iOS 程序启动与dyld加载</a>
        </h1>

      <div class="post-meta">
        <span class="post-time">
          2020-03-04
        </span></div>
    </header>

    <div class="post-content"><p>众所周知：我们iOS程序的入口是<code>main.m</code>中的<code>main()</code>函数</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// main.m</span></span><br><span class="line"><span class="meta">#import <span class="meta-string">&lt;UIKit/UIKit.h&gt;</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">&quot;AppDelegate.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">char</span> * argv[]) &#123;</span><br><span class="line">    <span class="built_in">NSString</span> * appDelegateClassName;</span><br><span class="line">    <span class="keyword">@autoreleasepool</span> &#123;</span><br><span class="line">        appDelegateClassName = <span class="built_in">NSStringFromClass</span>([AppDelegate <span class="keyword">class</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">UIApplicationMain</span>(argc, argv, <span class="literal">nil</span>, appDelegateClassName);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>那如果我们在main函数中打上断点</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// mian.m</span></span><br><span class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">char</span> * argv[]) &#123;</span><br><span class="line">    <span class="built_in">NSString</span> * appDelegateClassName; <span class="comment">// ⬅️ 断点①</span></span><br><span class="line">    <span class="keyword">@autoreleasepool</span> &#123;</span><br><span class="line">        <span class="comment">// Setup code that might create autoreleased objects goes here.</span></span><br><span class="line">        appDelegateClassName = <span class="built_in">NSStringFromClass</span>([AppDelegate <span class="keyword">class</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">UIApplicationMain</span>(argc, argv, <span class="literal">nil</span>, appDelegateClassName);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// AppDelegate.m</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">AppDelegate</span></span></span><br><span class="line"></span><br><span class="line">+ (<span class="keyword">void</span>)load &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;AppDelegate load&quot;</span>); <span class="comment">// ⬅️ 断点②</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">BOOL</span>)application:(<span class="built_in">UIApplication</span> *)application didFinishLaunchingWithOptions:(<span class="built_in">NSDictionary</span> *)launchOptions &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>

<p>此时运行程序，发现我们先卡在了<code>断点②</code>, 我们进入LLDB 输入<code>bt</code></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">(lldb) bt</span><br><span class="line">* thread #1, queue = &#x27;com.apple.main-thread&#x27;, stop reason = breakpoint 2.1</span><br><span class="line">  * frame #<span class="number">0</span>:  <span class="number">0x000000010eb8e0a7</span> dyld`+[AppDelegate load](self=AppDelegate, _cmd=<span class="string">&quot;load&quot;</span>) at AppDelegate.m:<span class="number">17</span>:<span class="number">5</span></span><br><span class="line">    frame #<span class="number">1</span>:  <span class="number">0x00007fff201804e3</span> libobjc.A.dylib`load_images + <span class="number">1442</span></span><br><span class="line">    frame #<span class="number">2</span>:  <span class="number">0x000000010eba1e54</span> dyld_sim`dyld::notifySingle(dyld_image_states, ImageLoader <span class="keyword">const</span>*, ImageLoader::InitializerTimingList*) + <span class="number">425</span></span><br><span class="line">    frame #<span class="number">3</span>:  <span class="number">0x000000010ebb0887</span> dyld_sim`ImageLoader::recursiveInitialization(ImageLoader::LinkContext <span class="keyword">const</span>&amp;, <span class="keyword">unsigned</span> <span class="keyword">int</span>, <span class="keyword">char</span> <span class="keyword">const</span>*, ImageLoader::InitializerTimingList&amp;, ImageLoader::UninitedUpwards&amp;) + <span class="number">437</span></span><br><span class="line">    frame #<span class="number">4</span>:  <span class="number">0x000000010ebaebb0</span> dyld_sim`ImageLoader::processInitializers(ImageLoader::LinkContext <span class="keyword">const</span>&amp;, <span class="keyword">unsigned</span> <span class="keyword">int</span>, ImageLoader::InitializerTimingList&amp;, ImageLoader::UninitedUpwards&amp;) + <span class="number">188</span></span><br><span class="line">    frame #<span class="number">5</span>:  <span class="number">0x000000010ebaec50</span> dyld_sim`ImageLoader::runInitializers(ImageLoader::LinkContext <span class="keyword">const</span>&amp;, ImageLoader::InitializerTimingList&amp;) + <span class="number">82</span></span><br><span class="line">    frame #<span class="number">6</span>:  <span class="number">0x000000010eba22a9</span> dyld_sim`dyld::initializeMainExecutable() + <span class="number">199</span></span><br><span class="line">    frame #<span class="number">7</span>:  <span class="number">0x000000010eba6d50</span> dyld_sim`dyld::_main(macho_header <span class="keyword">const</span>*, <span class="keyword">unsigned</span> <span class="keyword">long</span>, <span class="keyword">int</span>, <span class="keyword">char</span> <span class="keyword">const</span>**, <span class="keyword">char</span> <span class="keyword">const</span>**, <span class="keyword">char</span> <span class="keyword">const</span>**, <span class="keyword">unsigned</span> <span class="keyword">long</span>*) + <span class="number">4431</span></span><br><span class="line">    frame #<span class="number">8</span>:  <span class="number">0x000000010eba11c7</span> dyld_sim`start_sim + <span class="number">122</span></span><br><span class="line">    frame #<span class="number">9</span>:  <span class="number">0x0000000116e7057a</span> dyld`dyld::useSimulatorDyld(<span class="keyword">int</span>, macho_header <span class="keyword">const</span>*, <span class="keyword">char</span> <span class="keyword">const</span>*, <span class="keyword">int</span>, <span class="keyword">char</span> <span class="keyword">const</span>**, <span class="keyword">char</span> <span class="keyword">const</span>**, <span class="keyword">char</span> <span class="keyword">const</span>**, <span class="keyword">unsigned</span> <span class="keyword">long</span>*, <span class="keyword">unsigned</span> <span class="keyword">long</span>*) + <span class="number">2093</span></span><br><span class="line">    frame #<span class="number">10</span>: <span class="number">0x0000000116e6ddf3</span> dyld`dyld::_main(macho_header <span class="keyword">const</span>*, <span class="keyword">unsigned</span> <span class="keyword">long</span>, <span class="keyword">int</span>, <span class="keyword">char</span> <span class="keyword">const</span>**, <span class="keyword">char</span> <span class="keyword">const</span>**, <span class="keyword">char</span> <span class="keyword">const</span>**, <span class="keyword">unsigned</span> <span class="keyword">long</span>*) + <span class="number">1199</span></span><br><span class="line">    frame #<span class="number">11</span>: <span class="number">0x0000000116e6822b</span> dyld`dyldbootstrap::start(dyld3::MachOLoaded <span class="keyword">const</span>*, <span class="keyword">int</span>, <span class="keyword">char</span> <span class="keyword">const</span>**, dyld3::MachOLoaded <span class="keyword">const</span>*, <span class="keyword">unsigned</span> <span class="keyword">long</span>*) + <span class="number">457</span></span><br><span class="line">    frame #<span class="number">12</span>: <span class="number">0x0000000116e68025</span> dyld`_dyld_start + <span class="number">37</span></span><br><span class="line">(lldb) </span><br></pre></td></tr></table></figure>

<p>由此可见，在我们的main()函数之前，执行了一系列的操作，比如加载类(调用 <code>+load()</code>)等，一大推的<code>dyld</code>的字眼，我们下面就介绍一下这个神秘的<code>dyld</code></p>
<h2 id="dyld-简介"><a href="#dyld-简介" class="headerlink" title="dyld 简介"></a>dyld 简介</h2><ul>
<li><p>dyld(The dynamic link editor)动态链接编辑器，是操作系统的重要组成部分，在 macOS 系统中，dyld 位于 <code>Macintosh HD/usr/lib/dyld</code>。 </p>
</li>
<li><p>dyld 源码是开源的，位于 <a target="_blank" rel="noopener" href="https://opensource.apple.com/tarballs/dyld/">https://opensource.apple.com/tarballs/dyld/</a></p>
</li>
</ul>
<h2 id="dyld-执行流程"><a href="#dyld-执行流程" class="headerlink" title="dyld 执行流程"></a>dyld 执行流程</h2><p>根据文头<code>LLDB bt</code> 信息得知：dyld 的入口是 <code>_dyld_start</code></p>
<h3 id="dyld-start"><a href="#dyld-start" class="headerlink" title="_dyld_start"></a>_dyld_start</h3><p>以 <code>arm64</code> 为例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">#if __arm64__</span><br><span class="line">	.text</span><br><span class="line">	.align 2</span><br><span class="line">	.globl __dyld_start</span><br><span class="line">__dyld_start:</span><br><span class="line">	mov 	x28, sp</span><br><span class="line">	and     sp, x28, #~15		&#x2F;&#x2F; force 16-byte alignment of stack</span><br><span class="line">	mov	x0, #0</span><br><span class="line">	mov	x1, #0</span><br><span class="line">	stp	x1, x0, [sp, #-16]!	&#x2F;&#x2F; make aligned terminating frame</span><br><span class="line">	mov	fp, sp			&#x2F;&#x2F; set up fp to point to terminating frame</span><br><span class="line">	sub	sp, sp, #16             &#x2F;&#x2F; make room for local variables</span><br><span class="line">#if __LP64__</span><br><span class="line">	ldr     x0, [x28]               &#x2F;&#x2F; get app&#39;s mh into x0</span><br><span class="line">	ldr     x1, [x28, #8]           &#x2F;&#x2F; get argc into x1 (kernel passes 32-bit int argc as 64-bits on stack to keep alignment)</span><br><span class="line">	add     x2, x28, #16            &#x2F;&#x2F; get argv into x2</span><br><span class="line">#else</span><br><span class="line">	ldr     w0, [x28]               &#x2F;&#x2F; get app&#39;s mh into x0</span><br><span class="line">	ldr     w1, [x28, #4]           &#x2F;&#x2F; get argc into x1 (kernel passes 32-bit int argc as 64-bits on stack to keep alignment)</span><br><span class="line">	add     w2, w28, #8             &#x2F;&#x2F; get argv into x2</span><br><span class="line">#endif</span><br><span class="line">	adrp	x3,___dso_handle@page</span><br><span class="line">	add 	x3,x3,___dso_handle@pageoff &#x2F;&#x2F; get dyld&#39;s mh in to x4</span><br><span class="line">	mov	x4,sp                   &#x2F;&#x2F; x5 has &amp;startGlue</span><br><span class="line"></span><br><span class="line">	&#x2F;&#x2F; call dyldbootstrap::start(app_mh, argc, argv, dyld_mh, &amp;startGlue)</span><br><span class="line">	&#x2F;&#x2F; 根据 LLDB bt 及上述注释，这里调用了 dyldbootstrap::start</span><br><span class="line">	bl	__ZN13dyldbootstrap5startEPKN5dyld311MachOLoadedEiPPKcS3_Pm</span><br><span class="line">	mov	x16,x0                  &#x2F;&#x2F; save entry point address in x16</span><br><span class="line"></span><br><span class="line">	&#x2F;&#x2F; 省略部分代码...</span><br><span class="line"></span><br><span class="line">#endif &#x2F;&#x2F; __arm64__</span><br></pre></td></tr></table></figure>

<h3 id="dyldbootstrap-start"><a href="#dyldbootstrap-start" class="headerlink" title="dyldbootstrap::start"></a>dyldbootstrap::start</h3><p>位于 命名空间 <code>namespace dyldbootstrap</code> 下的 start 方法</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  This is code to bootstrap dyld.  This work in normally done for a program by dyld and crt.</span></span><br><span class="line"><span class="comment">//  In dyld we have to do this manually.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="function"><span class="keyword">uintptr_t</span> <span class="title">start</span><span class="params">(<span class="keyword">const</span> dyld3::MachOLoaded* appsMachHeader, <span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span>* argv[],</span></span></span><br><span class="line"><span class="function"><span class="params">				<span class="keyword">const</span> dyld3::MachOLoaded* dyldsMachHeader, <span class="keyword">uintptr_t</span>* startGlue)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// Emit kdebug tracepoint to indicate dyld bootstrap has started &lt;rdar://46878536&gt;</span></span><br><span class="line">    dyld3::kdebug_trace_dyld_marker(DBG_DYLD_TIMING_BOOTSTRAP_START, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// if kernel had to slide dyld, we need to fix up load sensitive locations</span></span><br><span class="line">    <span class="comment">// we have to do this before using any global variables</span></span><br><span class="line">    <span class="comment">// 地址恢复</span></span><br><span class="line">    rebaseDyld(dyldsMachHeader);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// kernel sets up env pointer to be just past end of agv array</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>** envp = &amp;argv[argc+<span class="number">1</span>];</span><br><span class="line">	</span><br><span class="line">    <span class="comment">// kernel sets up apple pointer to be just past end of envp array</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>** apple = envp;</span><br><span class="line">    <span class="keyword">while</span>(*apple != <span class="literal">NULL</span>) &#123; ++apple; &#125;</span><br><span class="line">    ++apple;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// set up random value for stack canary</span></span><br><span class="line">    __guard_setup(apple);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* DYLD_INITIALIZER_SUPPORT 的定义</span></span><br><span class="line"><span class="comment">// currently dyld has no initializers, but if some come back, set this to non-zero</span></span><br><span class="line"><span class="comment">#define DYLD_INITIALIZER_SUPPORT  0 </span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> DYLD_INITIALIZER_SUPPORT</span></span><br><span class="line">    <span class="comment">// run all C++ initializers inside dyld</span></span><br><span class="line">    runDyldInitializers(argc, argv, envp, apple);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// now that we are done bootstrapping dyld, call dyld&#x27;s main</span></span><br><span class="line">    <span class="keyword">uintptr_t</span> appsSlide = appsMachHeader-&gt;getSlide();</span><br><span class="line">    <span class="keyword">return</span> dyld::_main((macho_header*)appsMachHeader, appsSlide, argc, argv, envp, apple, startGlue);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="dyld-main"><a href="#dyld-main" class="headerlink" title="dyld::_main"></a>dyld::_main</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">intptr_t</span></span><br><span class="line">_main(<span class="keyword">const</span> macho_header* mainExecutableMH, <span class="keyword">uintptr_t</span> mainExecutableSlide,</span><br><span class="line">		<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span>* argv[], <span class="keyword">const</span> <span class="keyword">char</span>* envp[], <span class="keyword">const</span> <span class="keyword">char</span>* apple[], </span><br><span class="line">		<span class="keyword">uintptr_t</span>* startGlue)</span><br><span class="line">&#123;</span><br><span class="line">	......</span><br><span class="line"></span><br><span class="line">	<span class="keyword">uintptr_t</span> result = <span class="number">0</span>;</span><br><span class="line">	sMainExecutableMachHeader = mainExecutableMH;</span><br><span class="line">	sMainExecutableSlide = mainExecutableSlide;</span><br><span class="line"></span><br><span class="line">	......</span><br><span class="line"></span><br><span class="line">	CRSetCrashLogMessage(<span class="string">&quot;dyld: launch started&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 设置上下文等信息</span></span><br><span class="line">	setContext(mainExecutableMH, argc, argv, envp, apple);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	......</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="comment">// 检查环境变量</span></span><br><span class="line">	checkEnvironmentVariables(envp);</span><br><span class="line">	defaultUninitializedFallbackPaths(envp);</span><br><span class="line">	<span class="comment">// 根据环境变量进行打印输出</span></span><br><span class="line">	<span class="keyword">if</span> ( sEnv.DYLD_PRINT_OPTS )</span><br><span class="line">		printOptions(argv);</span><br><span class="line">	<span class="keyword">if</span> ( sEnv.DYLD_PRINT_ENV ) </span><br><span class="line">		printEnvironmentVariables(envp);</span><br><span class="line"></span><br><span class="line">	......</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 加载 shared cache</span></span><br><span class="line">	<span class="comment">// load shared cache</span></span><br><span class="line">	checkSharedRegionDisable((dyld3::MachOLoaded*)mainExecutableMH, mainExecutableSlide);</span><br><span class="line">	<span class="keyword">if</span> ( gLinkContext.sharedRegionMode != ImageLoader::kDontUseSharedRegion ) &#123;</span><br><span class="line">		mapSharedCache();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	......</span><br><span class="line"></span><br><span class="line">	<span class="comment">// install gdb notifier</span></span><br><span class="line">	stateToHandlers(dyld_image_state_dependents_mapped, sBatchHandlers)-&gt;push_back(notifyGDB);</span><br><span class="line">	stateToHandlers(dyld_image_state_mapped, sSingleHandlers)-&gt;push_back(updateAllImages);</span><br><span class="line">	<span class="comment">// make initial allocations large enough that it is unlikely to need to be re-alloced</span></span><br><span class="line">	sImageRoots.reserve(<span class="number">16</span>);</span><br><span class="line">	sAddImageCallbacks.reserve(<span class="number">4</span>);</span><br><span class="line">	sRemoveImageCallbacks.reserve(<span class="number">4</span>);</span><br><span class="line">	sAddLoadImageCallbacks.reserve(<span class="number">4</span>);</span><br><span class="line">	sImageFilesNeedingTermination.reserve(<span class="number">16</span>);</span><br><span class="line">	sImageFilesNeedingDOFUnregistration.reserve(<span class="number">8</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		<span class="comment">// 将dyld本身添加到UUID列表</span></span><br><span class="line">		<span class="comment">// add dyld itself to UUID list</span></span><br><span class="line">		addDyldImageToUUIDList();</span><br><span class="line"></span><br><span class="line">		......</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 实例化主程序</span></span><br><span class="line">		<span class="comment">// instantiate ImageLoader for main executable</span></span><br><span class="line">		sMainExecutable = instantiateFromLoadedImage(mainExecutableMH, mainExecutableSlide, sExecPath);</span><br><span class="line">		gLinkContext.mainExecutable = sMainExecutable;</span><br><span class="line">		gLinkContext.mainExecutableCodeSigned = hasCodeSignatureLoadCommand(mainExecutableMH);</span><br><span class="line"></span><br><span class="line">		......</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 加载 inserted libraries</span></span><br><span class="line">		<span class="comment">// load any inserted libraries</span></span><br><span class="line">		<span class="keyword">if</span>	( sEnv.DYLD_INSERT_LIBRARIES != <span class="literal">NULL</span> ) &#123;</span><br><span class="line">			<span class="keyword">for</span> (<span class="keyword">const</span> <span class="keyword">char</span>* <span class="keyword">const</span>* lib = sEnv.DYLD_INSERT_LIBRARIES; *lib != <span class="literal">NULL</span>; ++lib) </span><br><span class="line">				loadInsertedDylib(*lib);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// record count of inserted libraries so that a flat search will look at </span></span><br><span class="line">		<span class="comment">// inserted libraries, then main, then others.</span></span><br><span class="line">		sInsertedDylibCount = sAllImages.size()<span class="number">-1</span>;</span><br><span class="line">		</span><br><span class="line">		<span class="comment">// 链接主程序</span></span><br><span class="line">		<span class="comment">// link main executable</span></span><br><span class="line">		gLinkContext.linkingMainExecutable = <span class="literal">true</span>;</span><br><span class="line">		link(sMainExecutable, sEnv.DYLD_BIND_AT_LAUNCH, <span class="literal">true</span>, ImageLoader::RPathChain(<span class="literal">NULL</span>, <span class="literal">NULL</span>), <span class="number">-1</span>);</span><br><span class="line">		sMainExecutable-&gt;setNeverUnloadRecursive();</span><br><span class="line">		<span class="keyword">if</span> ( sMainExecutable-&gt;forceFlat() ) &#123;</span><br><span class="line">			gLinkContext.bindFlat = <span class="literal">true</span>;</span><br><span class="line">			gLinkContext.prebindUsage = ImageLoader::kUseNoPrebinding;</span><br><span class="line">		&#125;</span><br><span class="line">    </span><br><span class="line">		<span class="comment">// 链接 inserted libraries</span></span><br><span class="line">		<span class="comment">// link any inserted libraries</span></span><br><span class="line">		<span class="comment">// do this after linking main executable so that any dylibs pulled in by inserted </span></span><br><span class="line">		<span class="comment">// dylibs (e.g. libSystem) will not be in front of dylibs the program uses</span></span><br><span class="line">		<span class="keyword">if</span> ( sInsertedDylibCount &gt; <span class="number">0</span> ) &#123;</span><br><span class="line">			<span class="keyword">for</span>(<span class="keyword">unsigned</span> <span class="keyword">int</span> i=<span class="number">0</span>; i &lt; sInsertedDylibCount; ++i) &#123;</span><br><span class="line">				ImageLoader* image = sAllImages[i+<span class="number">1</span>];</span><br><span class="line">				link(image, sEnv.DYLD_BIND_AT_LAUNCH, <span class="literal">true</span>, ImageLoader::RPathChain(<span class="literal">NULL</span>, <span class="literal">NULL</span>), <span class="number">-1</span>);</span><br><span class="line">				image-&gt;setNeverUnloadRecursive();</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> ( gLinkContext.allowInterposing ) &#123;</span><br><span class="line">				<span class="comment">// only INSERTED libraries can interpose</span></span><br><span class="line">				<span class="comment">// register interposing info after all inserted libraries are bound so chaining works</span></span><br><span class="line">				<span class="keyword">for</span>(<span class="keyword">unsigned</span> <span class="keyword">int</span> i=<span class="number">0</span>; i &lt; sInsertedDylibCount; ++i) &#123;</span><br><span class="line">					ImageLoader* image = sAllImages[i+<span class="number">1</span>];</span><br><span class="line">					image-&gt;registerInterposing(gLinkContext);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> ( gLinkContext.allowInterposing ) &#123;</span><br><span class="line">			<span class="comment">// &lt;rdar://problem/19315404&gt; dyld should support interposition even without DYLD_INSERT_LIBRARIES</span></span><br><span class="line">			<span class="keyword">for</span> (<span class="keyword">long</span> i=sInsertedDylibCount+<span class="number">1</span>; i &lt; sAllImages.size(); ++i) &#123;</span><br><span class="line">				ImageLoader* image = sAllImages[i];</span><br><span class="line">				<span class="keyword">if</span> ( image-&gt;inSharedCache() )</span><br><span class="line">					<span class="keyword">continue</span>;</span><br><span class="line">				image-&gt;registerInterposing(gLinkContext);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	</span><br><span class="line">		......</span><br><span class="line"></span><br><span class="line">		<span class="comment">// apply interposing to initial set of images</span></span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; i &lt; sImageRoots.size(); ++i) &#123;</span><br><span class="line">			sImageRoots[i]-&gt;applyInterposing(gLinkContext);</span><br><span class="line">		&#125;</span><br><span class="line">		ImageLoader::applyInterposingToDyldCache(gLinkContext);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Bind and notify for the main executable now that interposing has been registered</span></span><br><span class="line">		<span class="keyword">uint64_t</span> bindMainExecutableStartTime = mach_absolute_time();</span><br><span class="line">		sMainExecutable-&gt;recursiveBindWithAccounting(gLinkContext, sEnv.DYLD_BIND_AT_LAUNCH, <span class="literal">true</span>);</span><br><span class="line">		<span class="keyword">uint64_t</span> bindMainExecutableEndTime = mach_absolute_time();</span><br><span class="line">		ImageLoaderMachO::fgTotalBindTime += bindMainExecutableEndTime - bindMainExecutableStartTime;</span><br><span class="line">		gLinkContext.notifyBatch(dyld_image_state_bound, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Bind and notify for the inserted images now interposing has been registered</span></span><br><span class="line">		<span class="keyword">if</span> ( sInsertedDylibCount &gt; <span class="number">0</span> ) &#123;</span><br><span class="line">			<span class="keyword">for</span>(<span class="keyword">unsigned</span> <span class="keyword">int</span> i=<span class="number">0</span>; i &lt; sInsertedDylibCount; ++i) &#123;</span><br><span class="line">				ImageLoader* image = sAllImages[i+<span class="number">1</span>];</span><br><span class="line">				image-&gt;recursiveBind(gLinkContext, sEnv.DYLD_BIND_AT_LAUNCH, <span class="literal">true</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="comment">// &lt;rdar://problem/12186933&gt; do weak binding only after all inserted images linked</span></span><br><span class="line">		sMainExecutable-&gt;weakBind(gLinkContext);</span><br><span class="line">		gLinkContext.linkingMainExecutable = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">		sMainExecutable-&gt;recursiveMakeDataReadOnly(gLinkContext);</span><br><span class="line"></span><br><span class="line">		CRSetCrashLogMessage(<span class="string">&quot;dyld: launch, running initializers&quot;</span>);</span><br><span class="line">		</span><br><span class="line">		<span class="comment">// 运行所有初始化程序(🔔🔔🔔这个方法相当的重要❗️❗️❗️)</span></span><br><span class="line">		<span class="comment">// run all initializers</span></span><br><span class="line">		initializeMainExecutable();</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 通知一些监视进程该进程将要进入main()</span></span><br><span class="line">		<span class="comment">// notify any montoring proccesses that this process is about to enter main()</span></span><br><span class="line">		notifyMonitoringDyldMain();</span><br><span class="line"></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">// 查找主程序的入口</span></span><br><span class="line">			<span class="comment">// find entry point for main executable</span></span><br><span class="line">			result = (<span class="keyword">uintptr_t</span>)sMainExecutable-&gt;getEntryFromLC_MAIN();</span><br><span class="line">			<span class="keyword">if</span> ( result != <span class="number">0</span> ) &#123;</span><br><span class="line">				<span class="comment">// main executable uses LC_MAIN, we need to use helper in libdyld to call into main()</span></span><br><span class="line">				<span class="keyword">if</span> ( (gLibSystemHelpers != <span class="literal">NULL</span>) &amp;&amp; (gLibSystemHelpers-&gt;version &gt;= <span class="number">9</span>) )</span><br><span class="line">					*startGlue = (<span class="keyword">uintptr_t</span>)gLibSystemHelpers-&gt;startGlueToCallExit;</span><br><span class="line">				<span class="keyword">else</span></span><br><span class="line">					halt(<span class="string">&quot;libdyld.dylib support not present for LC_MAIN&quot;</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> &#123;</span><br><span class="line">				<span class="comment">// main executable uses LC_UNIXTHREAD, dyld needs to let &quot;start&quot; in program set up for main()</span></span><br><span class="line">				result = (<span class="keyword">uintptr_t</span>)sMainExecutable-&gt;getEntryFromLC_UNIXTHREAD();</span><br><span class="line">				*startGlue = <span class="number">0</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">catch</span>(<span class="keyword">const</span> <span class="keyword">char</span>* message) &#123;</span><br><span class="line">		syncAllImages();</span><br><span class="line">		halt(message);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">catch</span>(...) &#123;</span><br><span class="line">		dyld::<span class="built_in">log</span>(<span class="string">&quot;dyld: launch failed\n&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>设置上下文等信息</li>
<li>检查环境变量</li>
<li>加载 shared cache</li>
<li>将dyld本身添加到UUID列表</li>
<li>实例化主程序</li>
<li>链接主程序</li>
<li>链接 inserted libraries</li>
<li>运行所有初始化程序</li>
<li>通知一些监视进程该进程将要进入main()</li>
<li>查找主程序的入口</li>
</ul>

        </div></article>
      <article class="post">
    <header class="post-header">
      <h1 class="post-title"><a class="post-link" href="/posts/ba9af90f/">YYCache源码学习</a>
        </h1>

      <div class="post-meta">
        <span class="post-time">
          2019-10-19
        </span></div>
    </header>

    <div class="post-content"><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">YYCache</span> : <span class="title">NSObject</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">copy</span>, <span class="keyword">readonly</span>) <span class="built_in">NSString</span> *name;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">strong</span>, <span class="keyword">readonly</span>) YYMemoryCache *memoryCache;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">strong</span>, <span class="keyword">readonly</span>) YYDiskCache *diskCache;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">nullable</span> <span class="keyword">instancetype</span>)initWithName:(<span class="built_in">NSString</span> *)name;</span><br><span class="line">- (<span class="keyword">nullable</span> <span class="keyword">instancetype</span>)initWithPath:(<span class="built_in">NSString</span> *)path <span class="built_in">NS_DESIGNATED_INITIALIZER</span>;</span><br><span class="line">+ (<span class="keyword">nullable</span> <span class="keyword">instancetype</span>)cacheWithName:(<span class="built_in">NSString</span> *)name;</span><br><span class="line">+ (<span class="keyword">nullable</span> <span class="keyword">instancetype</span>)cacheWithPath:(<span class="built_in">NSString</span> *)path;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">instancetype</span>)init UNAVAILABLE_ATTRIBUTE;</span><br><span class="line">+ (<span class="keyword">instancetype</span>)new UNAVAILABLE_ATTRIBUTE;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> mark - Access Methods</span></span><br><span class="line"><span class="comment">// 是否包含某个缓存对象</span></span><br><span class="line">- (<span class="built_in">BOOL</span>)containsObjectForKey:(<span class="built_in">NSString</span> *)key;</span><br><span class="line">- (<span class="keyword">void</span>)containsObjectForKey:(<span class="built_in">NSString</span> *)key withBlock:(<span class="keyword">nullable</span> <span class="keyword">void</span>(^)(<span class="built_in">NSString</span> *key, <span class="built_in">BOOL</span> contains))block;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取缓存对象</span></span><br><span class="line">- (<span class="keyword">nullable</span> <span class="keyword">id</span>&lt;<span class="built_in">NSCoding</span>&gt;)objectForKey:(<span class="built_in">NSString</span> *)key;</span><br><span class="line">- (<span class="keyword">void</span>)objectForKey:(<span class="built_in">NSString</span> *)key withBlock:(<span class="keyword">nullable</span> <span class="keyword">void</span>(^)(<span class="built_in">NSString</span> *key, <span class="keyword">id</span>&lt;<span class="built_in">NSCoding</span>&gt; object))block;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 保存缓存对象</span></span><br><span class="line">- (<span class="keyword">void</span>)setObject:(<span class="keyword">nullable</span> <span class="keyword">id</span>&lt;<span class="built_in">NSCoding</span>&gt;)object forKey:(<span class="built_in">NSString</span> *)key;</span><br><span class="line">- (<span class="keyword">void</span>)setObject:(<span class="keyword">nullable</span> <span class="keyword">id</span>&lt;<span class="built_in">NSCoding</span>&gt;)object forKey:(<span class="built_in">NSString</span> *)key withBlock:(<span class="keyword">nullable</span> <span class="keyword">void</span>(^)(<span class="keyword">void</span>))block;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 删除某个缓存对象</span></span><br><span class="line">- (<span class="keyword">void</span>)removeObjectForKey:(<span class="built_in">NSString</span> *)key;</span><br><span class="line">- (<span class="keyword">void</span>)removeObjectForKey:(<span class="built_in">NSString</span> *)key withBlock:(<span class="keyword">nullable</span> <span class="keyword">void</span>(^)(<span class="built_in">NSString</span> *key))block;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 删除所有缓存对象</span></span><br><span class="line">- (<span class="keyword">void</span>)removeAllObjects;</span><br><span class="line">- (<span class="keyword">void</span>)removeAllObjectsWithBlock:(<span class="keyword">void</span>(^)(<span class="keyword">void</span>))block;</span><br><span class="line">- (<span class="keyword">void</span>)removeAllObjectsWithProgressBlock:(<span class="keyword">nullable</span> <span class="keyword">void</span>(^)(<span class="keyword">int</span> removedCount, <span class="keyword">int</span> totalCount))progress</span><br><span class="line">                                 endBlock:(<span class="keyword">nullable</span> <span class="keyword">void</span>(^)(<span class="built_in">BOOL</span> error))end;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>

        </div></article>
      <article class="post">
    <header class="post-header">
      <h1 class="post-title"><a class="post-link" href="/posts/d115d42e/">iOS Block底层原理</a>
        </h1>

      <div class="post-meta">
        <span class="post-time">
          2019-08-29
        </span></div>
    </header>

    <div class="post-content"><h2 id="Block的底层结构"><a href="#Block的底层结构" class="headerlink" title="Block的底层结构"></a>Block的底层结构</h2><ul>
<li>最普通的Block</li>
<li>带<code>参数</code>的Block</li>
<li>访问了外部<code>auto变量</code>的Block</li>
<li>访问了外部<code>static变量</code>的Block</li>
<li>访问了<code>全局变量</code>的Block</li>
</ul>
          <div class="read-more">
            <a href="/posts/d115d42e/" class="read-more-link">Read more..</a>
          </div>
        </div></article>
      <article class="post">
    <header class="post-header">
      <h1 class="post-title"><a class="post-link" href="/posts/7f2a4d1e/">iOS 自动释放池(autoreleasepool)</a>
        </h1>

      <div class="post-meta">
        <span class="post-time">
          2019-08-26
        </span><span class="post-category">
            <a href="/categories/iOS/">iOS</a>
            </span>
        </div>
    </header>

    <div class="post-content"><h2 id="AutoreleasePool简介"><a href="#AutoreleasePool简介" class="headerlink" title="AutoreleasePool简介"></a>AutoreleasePool简介</h2><ul>
<li><a target="_blank" rel="noopener" href="https://developer.apple.com/documentation/foundation/nsautoreleasepool">Apple官方说明</a>：一个用来支持引用计数内存管理系统的对象；</li>
</ul>
          <div class="read-more">
            <a href="/posts/7f2a4d1e/" class="read-more-link">Read more..</a>
          </div>
        </div></article>
      <article class="post">
    <header class="post-header">
      <h1 class="post-title"><a class="post-link" href="/posts/638a6f77/">iOS 分类(Categoty)</a>
        </h1>

      <div class="post-meta">
        <span class="post-time">
          2019-08-25
        </span><span class="post-category">
            <a href="/categories/iOS/">iOS</a>
            </span>
        </div>
    </header>

    <div class="post-content"><h2 id="Categoty-底层结构"><a href="#Categoty-底层结构" class="headerlink" title="Categoty 底层结构"></a>Categoty 底层结构</h2><p>在<code>objc-runtime-new.h</code>中有定义</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> category_t &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *name;</span><br><span class="line">    classref_t cls;</span><br><span class="line">    <span class="keyword">struct</span> method_list_t *instanceMethods;</span><br><span class="line">    <span class="keyword">struct</span> method_list_t *classMethods;</span><br><span class="line">    <span class="keyword">struct</span> protocol_list_t *protocols;</span><br><span class="line">    <span class="keyword">struct</span> property_list_t *instanceProperties;</span><br><span class="line">    <span class="comment">// Fields below this point are not always present on disk.</span></span><br><span class="line">    <span class="keyword">struct</span> property_list_t *_classProperties;</span><br><span class="line"></span><br><span class="line">    method_list_t *methodsForMeta(<span class="keyword">bool</span> isMeta) &#123;</span><br><span class="line">        <span class="keyword">if</span> (isMeta) <span class="keyword">return</span> classMethods;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">return</span> instanceMethods;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    property_list_t *propertiesForMeta(<span class="keyword">bool</span> isMeta, <span class="keyword">struct</span> header_info *hi);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
          <div class="read-more">
            <a href="/posts/638a6f77/" class="read-more-link">Read more..</a>
          </div>
        </div></article>
      <article class="post">
    <header class="post-header">
      <h1 class="post-title"><a class="post-link" href="/posts/97624e89/">nuxt按需引入element-UI及自定义主题</a>
        </h1>

      <div class="post-meta">
        <span class="post-time">
          2019-08-16
        </span><span class="post-category">
            <a href="/categories/nuxt/">nuxt</a>
            <a href="/categories/nuxt/vue/">vue</a>
            </span>
        </div>
    </header>

    <div class="post-content"><p>nuxt按需引入element-UI及自定义主题</p>
          <div class="read-more">
            <a href="/posts/97624e89/" class="read-more-link">Read more..</a>
          </div>
        </div></article>
      <article class="post">
    <header class="post-header">
      <h1 class="post-title"><a class="post-link" href="/posts/a1b1e2bc/">self和super关键字</a>
        </h1>

      <div class="post-meta">
        <span class="post-time">
          2019-02-25
        </span></div>
    </header>

    <div class="post-content"><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">ViewController</span> ()</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">ViewController</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</span><br><span class="line">    [<span class="keyword">super</span> viewDidLoad];</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;self:%@&quot;</span>, <span class="built_in">NSStringFromClass</span>([<span class="keyword">self</span> <span class="keyword">class</span>]));</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;super:%@&quot;</span>, <span class="built_in">NSStringFromClass</span>([<span class="keyword">super</span> <span class="keyword">class</span>]));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/* 打印结果：</span></span><br><span class="line"><span class="comment">self:ViewController</span></span><br><span class="line"><span class="comment">super:ViewController</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>分析</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xcrun -sdk iphoneos clang -arch arm64 -rewrite-objc ViewController.m -o ViewController.cpp</span><br></pre></td></tr></table></figure>

<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 核心代码如下</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// NSStringFromClass([self class])</span></span><br><span class="line"><span class="built_in">NSStringFromClass</span>(</span><br><span class="line">  objc_msgSend(</span><br><span class="line">    (<span class="keyword">id</span>)<span class="keyword">self</span>, </span><br><span class="line">    sel_registerName(<span class="string">&quot;class&quot;</span>)</span><br><span class="line">  )</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// NSStringFromClass([super class])</span></span><br><span class="line"><span class="built_in">NSStringFromClass</span>(</span><br><span class="line">  objc_msgSendSuper(</span><br><span class="line">    &#123;</span><br><span class="line">      (<span class="keyword">id</span>)<span class="keyword">self</span>, </span><br><span class="line">      (<span class="keyword">id</span>)class_getSuperclass(objc_getClass(<span class="string">&quot;ViewController&quot;</span>))</span><br><span class="line">    &#125;, </span><br><span class="line">    sel_registerName(<span class="string">&quot;class&quot;</span>)</span><br><span class="line">  )</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>看一下<code>objc_msgSend</code>的定义：</p>
<h2 id="objc-msgSend"><a href="#objc-msgSend" class="headerlink" title="objc_msgSend"></a><a target="_blank" rel="noopener" href="https://developer.apple.com/documentation/objectivec/1456712-objc_msgsend">objc_msgSend</a></h2><ul>
<li>Sends a message with a simple return value to an instance of a class.</li>
<li>Declaration<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> objc_msgSend(<span class="keyword">void</span>);</span><br></pre></td></tr></table></figure></li>
<li>Parameters<ul>
<li>self<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">A pointer that points to the instance of the class that is to receive the message.</span><br><span class="line">译：指向要接收消息的类的实例的指针。</span><br></pre></td></tr></table></figure></li>
<li>op<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">The selector of the method that handles the message.</span><br><span class="line">译：处理消息的方法的选择器。</span><br></pre></td></tr></table></figure>


</li>
</ul>
</li>
</ul>
<ul>
<li>…<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">A variable argument list containing the arguments to the method.</span><br><span class="line">译：包含该方法参数的可变参数列表。</span><br></pre></td></tr></table></figure>

</li>
</ul>
<ul>
<li>Return Value<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">The return value of the method.</span><br><span class="line">译：方法的返回值。</span><br></pre></td></tr></table></figure>


</li>
</ul>
<h2 id="objc-msgSendSuper"><a href="#objc-msgSendSuper" class="headerlink" title="objc_msgSendSuper"></a><a target="_blank" rel="noopener" href="https://developer.apple.com/documentation/objectivec/1456716-objc_msgsendsuper">objc_msgSendSuper</a></h2><ul>
<li>Sends a message with a simple return value to the superclass of an instance of a class.</li>
<li>Declaration<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> objc_msgSendSuper(<span class="keyword">void</span>);</span><br></pre></td></tr></table></figure></li>
<li>Parameters<ul>
<li>self<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">A pointer to an objc_super data structure. Pass values identifying the context the message was sent to, including the instance of the class that is to receive the message and the superclass at which to start searching for the method implementation.</span><br><span class="line">译：指向结构体objc_super的指针。传递用于标识消息发送到的上下文的值，包括将接收消息的类的实例以及从其开始搜索方法实现的父类。</span><br></pre></td></tr></table></figure></li>
<li>op<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">A pointer of type SEL. Pass the selector of the method that will handle the message.</span><br><span class="line">译：类型的指针SEL。传递将处理消息的方法的选择器。</span><br></pre></td></tr></table></figure>


</li>
</ul>
</li>
</ul>
<ul>
<li>…<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">A variable argument list containing the arguments to the method.</span><br><span class="line">译：包含该方法参数的可变参数列表。</span><br></pre></td></tr></table></figure>

</li>
</ul>
<ul>
<li>Return Value<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">The return value of the method identified by op.</span><br><span class="line">译：由标识的方法的返回值op。</span><br></pre></td></tr></table></figure>


</li>
</ul>
<p>所以核心代码也就是如下：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 核心代码如下</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// NSStringFromClass([self class])</span></span><br><span class="line"><span class="built_in">NSStringFromClass</span>(</span><br><span class="line">  objc_msgSend(</span><br><span class="line">    (<span class="keyword">id</span>)<span class="keyword">self</span>, <span class="comment">// 指向要接收消息的类的实例的指针</span></span><br><span class="line">    sel_registerName(<span class="string">&quot;class&quot;</span>)</span><br><span class="line">  )</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// NSStringFromClass([super class])</span></span><br><span class="line"><span class="built_in">NSStringFromClass</span>(</span><br><span class="line">  objc_msgSendSuper(</span><br><span class="line">    &#123;</span><br><span class="line">      (<span class="keyword">id</span>)<span class="keyword">self</span>, <span class="comment">// 指向要接收消息的类的实例的指针</span></span><br><span class="line">      (<span class="keyword">id</span>)class_getSuperclass(objc_getClass(<span class="string">&quot;ViewController&quot;</span>))</span><br><span class="line">    &#125;, </span><br><span class="line">    sel_registerName(<span class="string">&quot;class&quot;</span>)</span><br><span class="line">  )</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>由于指向要接收消息的类的实例的指针都是<code>self</code>,所以打印都是<code>ViewController</code></p>
<p>区别：</p>
<p><code>[self class]</code> 从当前类开始找<code>class</code>方法</p>
<p><code>[super class]</code> 从当前累的父类开始找<code>class</code>方法</p>

        </div></article>
      <article class="post">
    <header class="post-header">
      <h1 class="post-title"><a class="post-link" href="/posts/7e500fcd/">iOS设置单个圆角(cornerRadius)和单边阴影(shaodwRadius)</a>
        </h1>

      <div class="post-meta">
        <span class="post-time">
          2019-01-30
        </span></div>
    </header>

    <div class="post-content"><ul>
<li><p>平时开发时总会有一些特殊的UI效果会比较烦人，比如单个边的圆角，单个边的阴影等等，下面我们使用一种很easy的方式来完成</p>
</li>
<li><p>效果如图：<br><img src="https://upload-images.jianshu.io/upload_images/590107-976fffd316e98cb3.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="example"></p>
</li>
<li><p>使用方式：</p>
</li>
<li><p>Installation with CocoaPods：</p>
<ul>
<li><code>pod &#39;YCShadowView&#39;</code></li>
<li><code>#import &lt;YCShadowView/YCShadowView.h&gt;</code> </li>
</ul>
</li>
<li><p>Manual import：</p>
<ul>
<li>Drag the YCShadowView folder to project</li>
<li><code>#import &quot;YCShadowView.h&quot;</code></li>
</ul>
</li>
<li><p>Use</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">YCShadowView *view = [[YCShadowView alloc] initWithFrame:<span class="built_in">CGRectMake</span>(<span class="number">200</span>, <span class="number">250</span>, <span class="number">100</span>, <span class="number">100</span>)];</span><br><span class="line">view.backgroundColor = [<span class="built_in">UIColor</span> whiteColor];</span><br><span class="line">[view yc_shaodwRadius:<span class="number">10</span> shadowColor:[<span class="built_in">UIColor</span> colorWithWhite:<span class="number">0</span> alpha:<span class="number">0.5</span>] shadowOffset:<span class="built_in">CGSizeMake</span>(<span class="number">0</span>, <span class="number">0</span>) byShadowSide:(YCShadowSideRight)];</span><br><span class="line">[view yc_cornerRadius:<span class="number">10</span> byRoundingCorners:(<span class="built_in">UIRectCornerBottomLeft</span>)];</span><br></pre></td></tr></table></figure></li>
<li><p>如有更好的方式来实现或不当之处，留言讨论，感谢~</p>
</li>
<li><p>源码见：<a target="_blank" rel="noopener" href="https://github.com/YotrolZ/YCShadowView">github</a></p>
</li>
</ul>

        </div></article>
      <article class="post">
    <header class="post-header">
      <h1 class="post-title"><a class="post-link" href="/posts/d910df91/">OpenGL_Mac平台搭建OpenGL环境</a>
        </h1>

      <div class="post-meta">
        <span class="post-time">
          2018-03-16
        </span></div>
    </header>

    <div class="post-content"><blockquote>
<p><strong>1、创建一个Mac应用工程</strong></p>
</blockquote>
<ul>
<li>打开Xcode –&gt; Creat a new Xcode project –&gt;  macOS –&gt; Cocoa App</li>
<li><img src="https://upload-images.jianshu.io/upload_images/590107-f8f60fb967683126.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="新建一个Mac应用程序"></li>
</ul>
<blockquote>
<p><strong>2、添加系统库</strong></p>
</blockquote>
<ul>
<li>添加<code>OpenGL.framework</code> 和 <code>GLUT.framework</code>两个系统库</li>
<li><img src="https://upload-images.jianshu.io/upload_images/590107-b4bea138cbde1fbf.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="添加系统库"></li>
</ul>
<blockquote>
<p><strong>3、添加OpenGL工具库，并在Bulid Settings 的 Header Search path 中配置 <code>CLTool.h</code> 和 <code>glew.h</code> 路径</strong></p>
</blockquote>
<ul>
<li>文件(<code>include文件夹</code>和<code>libGLTools.a</code>)可从Demo中获取</li>
<li><img src="https://upload-images.jianshu.io/upload_images/590107-6625ec3d1e626471.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="添加OpenGL工具库"></li>
<li><img src="https://upload-images.jianshu.io/upload_images/590107-3e3dd9dcd3778f1e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="在Bulid Settings 的 Header Search path 中配置CLTool.h和glew.h的路径"></li>
</ul>
<blockquote>
<p><strong>4、删除不需要的文件</strong></p>
</blockquote>
<ul>
<li><img src="https://upload-images.jianshu.io/upload_images/590107-facfac519e0718e1.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="删除选中的文件"></li>
</ul>
<blockquote>
<p><strong>5、新建<code>main.cpp</code>文件</strong></p>
</blockquote>
<ul>
<li><p><img src="https://upload-images.jianshu.io/upload_images/590107-1b839764b0a730f0.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="新建文件并选择 C++ File"></p>
</li>
<li><p><img src="https://upload-images.jianshu.io/upload_images/590107-e57a6d78fa3647cc.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="填写文件名称“main”，并取消打钩"></p>
</li>
</ul>
<blockquote>
<p><strong>6、修改main.cpp文件</strong></p>
</blockquote>
<ul>
<li>在main.cpp文件中添加如下代码，先不用搞懂什么意思，后面再做介绍<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">#include &quot;GLTools.h&quot;</span><br><span class="line">#include &lt;GLUT&#x2F;GLUT.h&gt;</span><br><span class="line"></span><br><span class="line">void draw() &#123;</span><br><span class="line">    </span><br><span class="line">    glClear(GL_COLOR_BUFFER_BIT);</span><br><span class="line">    glColor3f(1.0f, 0.0f, 0.0f); </span><br><span class="line"> </span><br><span class="line">    glBegin(GL_POLYGON);</span><br><span class="line">    glVertex2f(-0.5f, 0.0f);</span><br><span class="line">    glVertex2f(0.5f, 0.0f);</span><br><span class="line">    glVertex2f(0.0f, 0.5f);</span><br><span class="line">    glEnd();</span><br><span class="line">    </span><br><span class="line">    glFlush();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">int main(int argc,const char *argv[]) &#123;</span><br><span class="line">    </span><br><span class="line">    glutInit(&amp;argc, (char **)argv);</span><br><span class="line">    glutCreateWindow(&quot;OpenGL环境搭建--显示三角形&quot;);</span><br><span class="line">    glutDisplayFunc(draw);</span><br><span class="line">    glutMainLoop();</span><br><span class="line">    </span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<blockquote>
<p><strong>7、运行程序</strong></p>
</blockquote>
<ul>
<li>如果没有问题的话你应该看到如下图案，至此我们的OpenGL搭建工作也告一段落</li>
<li><img src="https://upload-images.jianshu.io/upload_images/590107-0632d0f5f149a965.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="运行结果"></li>
</ul>

        </div></article>
      <nav class="pagination"><a class="next" href="/page/2/">
        <span class="next-text">Next</span>
        <i class="iconfont icon-right"></i>
      </a>
    </nav></section></div></div>
      </main>

      <footer id="footer" class="footer"><div class="social-links"></div><div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" target="_blank" rel="noopener" href="https://github.com/ahonn/hexo-theme-even">Even</a>
  </span>

  <span class="copyright-year">&copy;2015 - 2021<span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">YotrolZ</span>
  </span>
</div>
</footer>

      <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
      </div>
    </div><script type="text/javascript" src="/lib/jquery/jquery.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox.pack.js"></script>
  <script type="text/javascript" src="/js/src/even.js?v=2.11.0"></script>
</body>
</html>
