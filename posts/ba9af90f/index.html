<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="theme-color" content="#f8f5ec"><meta name="msapplication-navbutton-color" content="#f8f5ec"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec"><meta name="description" content="YYCache源码学习-初始化分析"><link rel="alternate" href="/atom.xml" title="YotrolZ" type="application/atom+xml"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=2.11.0"><link rel="canonical" href="http://yotrolz.com/posts/ba9af90f/"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/yotrolz/yotrolz.github.io@gh/lib/fancybox/jquery.fancybox.css"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/yotrolz/yotrolz.github.io@gh/css/style.css?v=2.11.0"><script async src="https://www.googletagmanager.com/gtag/js?id=UA-138610487-3"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-138610487-3")</script><script id="baidu_push">!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}()</script><script src="//cdn.jsdelivr.net/npm/leancloud-storage@4.10.0/dist/av-min.js"></script><script id="leancloud">AV.init({appId:"mqfPQEKBtui9puAJUkYFY7Jn-MdYXbMMI",appKey:"A6R0T4bEvcBsTU8pB7NhJ6Wl"})</script><script>window.config={leancloud:{show_visits:!1,app_id:"mqfPQEKBtui9puAJUkYFY7Jn-MdYXbMMI",app_key:"A6R0T4bEvcBsTU8pB7NhJ6Wl"},toc:!0,fancybox:!0,pjax:"",latex:!1}</script><title>YYCache源码学习-初始化分析 - YotrolZ</title><meta name="generator" content="Hexo 5.4.1"></head><body><div id="mobile-navbar" class="mobile-navbar"><div class="mobile-header-logo"> <a href="/." class="logo">YotrolZ</a></div><div class="mobile-navbar-icon"><span></span><span></span><span></span></div></div><nav id="mobile-menu" class="mobile-menu slideout-menu"><ul class="mobile-menu-list"><a href="/"><li class="mobile-menu-item">Home</li></a><a href="/archives/"><li class="mobile-menu-item">Archives</li></a><a href="/tags/"><li class="mobile-menu-item">Tags</li></a><a href="/categories/"><li class="mobile-menu-item">Categories</li></a></ul></nav><div class="container" id="mobile-panel"><header id="header" class="header"><div class="logo-wrapper"> <a href="/." class="logo">YotrolZ</a></div><nav class="site-navbar"><ul id="menu" class="menu"><li class="menu-item"> <a class="menu-item-link" href="/">Home</a></li><li class="menu-item"> <a class="menu-item-link" href="/archives/">Archives</a></li><li class="menu-item"> <a class="menu-item-link" href="/tags/">Tags</a></li><li class="menu-item"> <a class="menu-item-link" href="/categories/">Categories</a></li></ul></nav></header><main id="main" class="main"><div class="content-wrapper"><div id="content" class="content"><article class="post"><header class="post-header"><h1 class="post-title">YYCache源码学习-初始化分析</h1><div class="post-meta"> <span class="post-time">2019-10-19</span> <span class="post-visits" style="display:none" data-url="/posts/ba9af90f/" data-title="YYCache源码学习-初始化分析">Visits 0</span></div></header><div class="post-toc" id="post-toc"><h2 class="post-toc-title">Contents</h2><div class="post-toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#YYCache-%E7%AE%80%E4%BB%8B"><span class="toc-text">YYCache 简介</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E7%9B%AE%E5%BD%95"><span class="toc-text">文件目录</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%9B%B8%E5%85%B3API"><span class="toc-text">相关API</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#YYCache-%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-text">YYCache 初始化</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#YYDiskCache-%E7%A3%81%E7%9B%98%E7%BC%93%E5%AD%98"><span class="toc-text">YYDiskCache 磁盘缓存</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#YYDiskCache-%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-text">YYDiskCache 初始化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%8E%E7%BC%93%E5%AD%98%E4%B8%AD%E8%8E%B7%E5%8F%96YYDiskCache%E5%AF%B9%E8%B1%A1"><span class="toc-text">从缓存中获取YYDiskCache对象</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#YYDiskCacheInitGlobal"><span class="toc-text">_YYDiskCacheInitGlobal</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#YYDiskCacheGetGlobal"><span class="toc-text">_YYDiskCacheGetGlobal</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#YYDiskCacheSetGlobal"><span class="toc-text">_YYDiskCacheSetGlobal</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%9C%9F%E6%AD%A3%E7%9A%84%E5%88%9B%E5%BB%BAYYDiskCache%E5%AF%B9%E8%B1%A1"><span class="toc-text">真正的创建YYDiskCache对象</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#YYMemoryCache-%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-text">YYMemoryCache 初始化</span></a></li></ol></div></div><div class="post-content"><h1 id="YYCache-简介"><a href="#YYCache-简介" class="headerlink" title="YYCache 简介"></a>YYCache 简介</h1><p>先来看一下官方介绍</p><ul><li><strong>LRU</strong>: 缓存支持 LRU (least-recently-used) 淘汰算法。</li><li><strong>缓存控制</strong>: 支持多种缓存控制方法：总数量、总大小、存活时间、空闲空间。</li><li><strong>兼容性</strong>: API 基本和 <code>NSCache</code> 保持一致, 所有方法都是<code>线程安全</code>的。</li><li><strong>内存缓存</strong><ul><li><strong>对象释放控制</strong>: 对象的释放(release) 可以配置为同步或异步进行，可以配置在主线程或后台线程进行。</li><li><strong>自动清空</strong>: 当收到内存警告或 App 进入后台时，缓存可以配置为自动清空。</li></ul></li><li><strong>磁盘缓存</strong><ul><li><strong>可定制性</strong>: 磁盘缓存支持自定义的归档解档方法，以支持那些没有实现 NSCoding 协议的对象。</li><li><strong>存储类型控制</strong>: 磁盘缓存支持对每个对象的存储类型 (SQLite/文件) 进行自动或手动控制，以获得更高的存取性能。</li></ul></li></ul><span id="more"></span><h2 id="文件目录"><a href="#文件目录" class="headerlink" title="文件目录"></a>文件目录</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">├── YYCache</span><br><span class="line">    ├── YYCache.h</span><br><span class="line">    ├── YYCache.m</span><br><span class="line">    ├── YYDiskCache.h</span><br><span class="line">    ├── YYDiskCache.m</span><br><span class="line">    ├── YYKVStorage.h</span><br><span class="line">    ├── YYKVStorage.m</span><br><span class="line">    ├── YYMemoryCache.h</span><br><span class="line">    └── YYMemoryCache.m</span><br></pre></td></tr></table></figure><h2 id="相关API"><a href="#相关API" class="headerlink" title="相关API"></a>相关API</h2><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">YYCache</span> : <span class="title">NSObject</span></span></span><br><span class="line"><span class="comment">/// 三个只读属性</span></span><br><span class="line"><span class="comment">//  ① Cache名称</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">copy</span>, <span class="keyword">readonly</span>) <span class="built_in">NSString</span> *name;</span><br><span class="line"><span class="comment">//  ② 内存缓存</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">strong</span>, <span class="keyword">readonly</span>) YYMemoryCache *memoryCache;</span><br><span class="line"><span class="comment">//  ③ 磁盘缓存</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">strong</span>, <span class="keyword">readonly</span>) YYDiskCache *diskCache;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 初始化相关方法</span></span><br><span class="line">- (<span class="keyword">nullable</span> <span class="keyword">instancetype</span>)initWithName:(<span class="built_in">NSString</span> *)name;</span><br><span class="line">- (<span class="keyword">nullable</span> <span class="keyword">instancetype</span>)initWithPath:(<span class="built_in">NSString</span> *)path <span class="built_in">NS_DESIGNATED_INITIALIZER</span>;</span><br><span class="line">+ (<span class="keyword">nullable</span> <span class="keyword">instancetype</span>)cacheWithName:(<span class="built_in">NSString</span> *)name;</span><br><span class="line">+ (<span class="keyword">nullable</span> <span class="keyword">instancetype</span>)cacheWithPath:(<span class="built_in">NSString</span> *)path;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">instancetype</span>)init UNAVAILABLE_ATTRIBUTE;</span><br><span class="line">+ (<span class="keyword">instancetype</span>)new UNAVAILABLE_ATTRIBUTE;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> mark - Access Methods</span></span><br><span class="line"><span class="comment">/// 是否包含某个缓存对象</span></span><br><span class="line">- (<span class="built_in">BOOL</span>)containsObjectForKey:(<span class="built_in">NSString</span> *)key;</span><br><span class="line">- (<span class="keyword">void</span>)containsObjectForKey:(<span class="built_in">NSString</span> *)key withBlock:(<span class="keyword">nullable</span> <span class="keyword">void</span>(^)(<span class="built_in">NSString</span> *key, <span class="built_in">BOOL</span> contains))block;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 获取缓存对象</span></span><br><span class="line">- (<span class="keyword">nullable</span> <span class="keyword">id</span>&lt;<span class="built_in">NSCoding</span>&gt;)objectForKey:(<span class="built_in">NSString</span> *)key;</span><br><span class="line">- (<span class="keyword">void</span>)objectForKey:(<span class="built_in">NSString</span> *)key withBlock:(<span class="keyword">nullable</span> <span class="keyword">void</span>(^)(<span class="built_in">NSString</span> *key, <span class="keyword">id</span>&lt;<span class="built_in">NSCoding</span>&gt; object))block;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 保存缓存对象</span></span><br><span class="line">- (<span class="keyword">void</span>)setObject:(<span class="keyword">nullable</span> <span class="keyword">id</span>&lt;<span class="built_in">NSCoding</span>&gt;)object forKey:(<span class="built_in">NSString</span> *)key;</span><br><span class="line">- (<span class="keyword">void</span>)setObject:(<span class="keyword">nullable</span> <span class="keyword">id</span>&lt;<span class="built_in">NSCoding</span>&gt;)object forKey:(<span class="built_in">NSString</span> *)key withBlock:(<span class="keyword">nullable</span> <span class="keyword">void</span>(^)(<span class="keyword">void</span>))block;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 删除某个缓存对象</span></span><br><span class="line">- (<span class="keyword">void</span>)removeObjectForKey:(<span class="built_in">NSString</span> *)key;</span><br><span class="line">- (<span class="keyword">void</span>)removeObjectForKey:(<span class="built_in">NSString</span> *)key withBlock:(<span class="keyword">nullable</span> <span class="keyword">void</span>(^)(<span class="built_in">NSString</span> *key))block;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 删除所有缓存对象</span></span><br><span class="line">- (<span class="keyword">void</span>)removeAllObjects;</span><br><span class="line">- (<span class="keyword">void</span>)removeAllObjectsWithBlock:(<span class="keyword">void</span>(^)(<span class="keyword">void</span>))block;</span><br><span class="line">- (<span class="keyword">void</span>)removeAllObjectsWithProgressBlock:(<span class="keyword">nullable</span> <span class="keyword">void</span>(^)(<span class="keyword">int</span> removedCount, <span class="keyword">int</span> totalCount))progress</span><br><span class="line">                                 endBlock:(<span class="keyword">nullable</span> <span class="keyword">void</span>(^)(<span class="built_in">BOOL</span> error))end;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure><ul><li><code>YYCache</code> 中 <code>memoryCache</code> 和 <code>diskCache</code> 均为 <code>strong</code> 且 <code>readonly</code>；</li><li>也就是说当我们外界使用<code>YYCache</code>对象的时候，对其内部的 <code>memoryCache</code> 和 <code>diskCache</code> 成员是 <code>强引用</code></li></ul><blockquote><p>知识点: NS_DESIGNATED_INITIALIZER 和 NS_UNAVAILABLE</p></blockquote><p>我们都知道，一个类可能会有多个工厂方法或者初始化方法，当外界调用时，难免会傻傻分不清楚，这个时候就可以使用苹果为开发者提供的两个宏 <code>NS_DESIGNATED_INITIALIZER</code> 和 <code>NS_UNAVAILABLE</code> 来进行描述；</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> NS_DESIGNATED_INITIALIZER __attribute__((objc_designated_initializer))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> UNAVAILABLE_ATTRIBUTE __attribute__((unavailable))</span></span><br></pre></td></tr></table></figure><ul><li><strong>NS_DESIGNATED_INITIALIZER</strong></li></ul><p><a target="_blank" rel="noopener" href="https://developer.apple.com/library/archive/documentation/General/Conceptual/DevPedia-CocoaCore/MultipleInitializers.html">苹果官方文档</a>给出了一个调用顺序，而我们也应该遵守这种调用顺序，以确保无论外部调用者从哪个入口进入，都能够正确的初始化：<br><img src="https://developer.apple.com/library/archive/documentation/General/Conceptual/DevPedia-CocoaCore/Art/multiple_initializers_2x.png"></p><p>如上图所示：无论调用哪种初始化方法，最终都会调用 <code>designed initializer</code>, 具体代码如下：</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">instancetype</span>)initWithTitle:(<span class="built_in">NSString</span> *)title </span><br><span class="line">                         date:(<span class="built_in">NSDate</span> *)date <span class="built_in">NS_DESIGNATED_INITIALIZER</span>;</span><br></pre></td></tr></table></figure><ul><li><strong>NS_UNAVAILABLE</strong><br>使用 <code>NS_UNAVAILABLE</code> 后代表<code>直接禁用</code>，如果使用该方法，编译器就会报错；</li></ul><h1 id="YYCache-初始化"><a href="#YYCache-初始化" class="headerlink" title="YYCache 初始化"></a>YYCache 初始化</h1><p>我们从<code>NS_DESIGNATED_INITIALIZER</code>的初始化方法进行分析:</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">instancetype</span>)initWithPath:(<span class="built_in">NSString</span> *)path &#123;</span><br><span class="line">    <span class="keyword">if</span> (path.length == <span class="number">0</span>) <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ① 初始化磁盘缓存</span></span><br><span class="line">    YYDiskCache *diskCache = [[YYDiskCache alloc] initWithPath:path];</span><br><span class="line">    <span class="keyword">if</span> (!diskCache) <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    <span class="built_in">NSString</span> *name = [path lastPathComponent];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ② 初始化内存缓存</span></span><br><span class="line">    YYMemoryCache *memoryCache = [YYMemoryCache new];</span><br><span class="line">    memoryCache.name = name;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ③ 初始化本身并对内部的三个只读属性进行赋值</span></span><br><span class="line">    <span class="keyword">self</span> = [<span class="keyword">super</span> init];</span><br><span class="line">    _name = name;</span><br><span class="line">    _diskCache = diskCache;</span><br><span class="line">    _memoryCache = memoryCache;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>当然了，如果我们直接使用<code>- (instancetype)initWithName:(NSString *)name</code>进行初始化，可以看一下，默认存储的<code>path</code></p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">instancetype</span>)initWithName:(<span class="built_in">NSString</span> *)name &#123;</span><br><span class="line">    <span class="keyword">if</span> (name.length == <span class="number">0</span>) <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    <span class="built_in">NSString</span> *cacheFolder = [<span class="built_in">NSSearchPathForDirectoriesInDomains</span>(<span class="built_in">NSCachesDirectory</span>, <span class="built_in">NSUserDomainMask</span>, <span class="literal">YES</span>) firstObject];</span><br><span class="line">    <span class="built_in">NSString</span> *path = [cacheFolder stringByAppendingPathComponent:name];</span><br><span class="line">    <span class="keyword">return</span> [<span class="keyword">self</span> initWithPath:path];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="YYDiskCache-磁盘缓存"><a href="#YYDiskCache-磁盘缓存" class="headerlink" title="YYDiskCache 磁盘缓存"></a>YYDiskCache 磁盘缓存</h1><h2 id="YYDiskCache-初始化"><a href="#YYDiskCache-初始化" class="headerlink" title="YYDiskCache  初始化"></a>YYDiskCache 初始化</h2><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">YYDiskCache</span> : <span class="title">NSObject</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Cache name</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nullable</span>, <span class="keyword">copy</span>) <span class="built_in">NSString</span> *name;</span><br><span class="line"><span class="comment">// Cache path</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">readonly</span>) <span class="built_in">NSString</span> *path;</span><br><span class="line"><span class="comment">// 磁盘缓存方式的一个阈值，默认是20KB</span></span><br><span class="line"><span class="comment">// 🔔❗️❗️❗️如果要存储的数据大小(以字节为单位)大于该阈值，则将其存储为文件，否则将其存储在sqlite中</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">readonly</span>) <span class="built_in">NSUInteger</span> inlineThreshold;</span><br><span class="line"></span><br><span class="line">······</span><br><span class="line"></span><br><span class="line"><span class="comment">// 初始化 (NS_DESIGNATED_INITIALIZER)</span></span><br><span class="line">- (<span class="keyword">nullable</span> <span class="keyword">instancetype</span>)initWithPath:(<span class="built_in">NSString</span> *)path</span><br><span class="line">                      inlineThreshold:(<span class="built_in">NSUInteger</span>)threshold <span class="built_in">NS_DESIGNATED_INITIALIZER</span>;</span><br><span class="line"></span><br><span class="line">······</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure><p>初始化<code>YYCache</code>时调用了 <code>YYDiskCache</code> 的 <code>initWithPath</code> 方法</p><ul><li><p>这里主要是对 inlineThreshold 阈值进行了初始化(20KB)</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">instancetype</span>)initWithPath:(<span class="built_in">NSString</span> *)path &#123;</span><br><span class="line">  <span class="keyword">return</span> [<span class="keyword">self</span> initWithPath:path inlineThreshold:<span class="number">1024</span> * <span class="number">20</span>]; <span class="comment">// 20KB</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>真正的初始化方法(NS_DESIGNATED_INITIALIZER)</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">instancetype</span>)initWithPath:(<span class="built_in">NSString</span> *)path</span><br><span class="line">            inlineThreshold:(<span class="built_in">NSUInteger</span>)threshold &#123;</span><br><span class="line">    <span class="keyword">self</span> = [<span class="keyword">super</span> init];</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">self</span>) <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ① 根据path利用_YYDiskCacheGetGlobal获取YYDiskCache对象</span></span><br><span class="line">    YYDiskCache *globalCache = _YYDiskCacheGetGlobal(path);</span><br><span class="line">    <span class="comment">// 存在的话直接返回，不需创建</span></span><br><span class="line">    <span class="keyword">if</span> (globalCache) <span class="keyword">return</span> globalCache;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ② 真正的初始化操作</span></span><br><span class="line">    ······ <span class="comment">// 下文分析</span></span><br><span class="line">    </span><br><span class="line">    [[<span class="built_in">NSNotificationCenter</span> defaultCenter] addObserver:<span class="keyword">self</span> selector:<span class="keyword">@selector</span>(_appWillBeTerminated) name:<span class="built_in">UIApplicationWillTerminateNotification</span> object:<span class="literal">nil</span>];</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><h2 id="从缓存中获取YYDiskCache对象"><a href="#从缓存中获取YYDiskCache对象" class="headerlink" title="从缓存中获取YYDiskCache对象"></a>从缓存中获取YYDiskCache对象</h2><p>在上文中我们得知，<code>YYDiskCache</code>在初始化的时候，首先会根据<code>path</code> 调用 <code>_YYDiskCacheGetGlobal</code>来进行查找，如果查到，就直接返回，如果没有找到就执行一系列的初始化操作，然后又调用 <code>_YYDiskCacheSetGlobal</code> 将创建好的<code>YYDiskCache</code> 对象存入，现在我们来分析一下 <code>_YYDiskCacheGetGlobal</code> 和 <code>_YYDiskCacheSetGlobal</code>；</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// weak reference for all instances</span></span><br><span class="line"><span class="type">static</span> NSMapTable *_globalInstances;</span><br><span class="line"><span class="type">static</span> <span class="type">dispatch_semaphore_t</span> _globalInstancesLock;</span><br></pre></td></tr></table></figure><ul><li>定义了一个全局的 <code>NSMapTable</code> 类型的 <code>_globalInstances</code> 和 一个 <code>dispatch_semaphore_t</code> 类型的 <code>_globalInstancesLock</code>;</li><li><code>_globalInstances</code>：存放所有的 <code>YYDiskCache</code> 对象</li><li><code>dispatch_semaphore_t</code>：用来保证<code>线程安全</code></li></ul><h3 id="YYDiskCacheInitGlobal"><a href="#YYDiskCacheInitGlobal" class="headerlink" title="_YYDiskCacheInitGlobal"></a>_YYDiskCacheInitGlobal</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> _YYDiskCacheInitGlobal() &#123;</span><br><span class="line">    <span class="type">static</span> <span class="type">dispatch_once_t</span> onceToken;</span><br><span class="line">    <span class="built_in">dispatch_once</span>(&amp;onceToken, ^&#123;</span><br><span class="line">        _globalInstancesLock = <span class="built_in">dispatch_semaphore_create</span>(<span class="number">1</span>);</span><br><span class="line">        _globalInstances = [[NSMapTable alloc] initWithKeyOptions:NSPointerFunctionsStrongMemory valueOptions:NSPointerFunctionsWeakMemory capacity:<span class="number">0</span>];</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>使用<code>dispatch_once</code>保证只初始化一次；</li><li>🔔❗️❗️❗️ <code>_globalInstances</code> 用来存放所有的 <code>YYDiskCache</code>对象， 使用 <code>NSMapTable</code> + <code>NSPointerFunctionsWeakMemory</code>， <code>弱引用</code> 内部的 <code>YYDiskCache</code>对象；</li></ul><h3 id="YYDiskCacheGetGlobal"><a href="#YYDiskCacheGetGlobal" class="headerlink" title="_YYDiskCacheGetGlobal"></a>_YYDiskCacheGetGlobal</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> YYDiskCache *_YYDiskCacheGetGlobal(NSString *path) &#123;</span><br><span class="line">    <span class="keyword">if</span> (path.length == <span class="number">0</span>) <span class="keyword">return</span> nil;</span><br><span class="line">    _YYDiskCacheInitGlobal();</span><br><span class="line">    <span class="built_in">dispatch_semaphore_wait</span>(_globalInstancesLock, DISPATCH_TIME_FOREVER);</span><br><span class="line">    id cache = [_globalInstances objectForKey:path];</span><br><span class="line">    <span class="built_in">dispatch_semaphore_signal</span>(_globalInstancesLock);</span><br><span class="line">    <span class="keyword">return</span> cache;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>在调用<code>_YYDiskCacheGetGlobal</code>时会调用<code>_YYDiskCacheInitGlobal</code> 进行初始化；</li><li>由于<code>_YYDiskCacheInitGlobal</code>内部使用<code>dispatch_once</code>，可保证只初始化了一次；</li></ul><h3 id="YYDiskCacheSetGlobal"><a href="#YYDiskCacheSetGlobal" class="headerlink" title="_YYDiskCacheSetGlobal"></a>_YYDiskCacheSetGlobal</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> _YYDiskCacheSetGlobal(YYDiskCache *cache) &#123;</span><br><span class="line">    <span class="keyword">if</span> (cache.path.length == <span class="number">0</span>) <span class="keyword">return</span>;</span><br><span class="line">    _YYDiskCacheInitGlobal();</span><br><span class="line">    <span class="built_in">dispatch_semaphore_wait</span>(_globalInstancesLock, DISPATCH_TIME_FOREVER);</span><br><span class="line">    [_globalInstances setObject:cache forKey:cache.path];</span><br><span class="line">    <span class="built_in">dispatch_semaphore_signal</span>(_globalInstancesLock);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>在调用<code>_YYDiskCacheGetGlobal</code>时会调用<code>_YYDiskCacheInitGlobal</code> 进行初始化；</li><li>由于<code>_YYDiskCacheInitGlobal</code>内部使用<code>dispatch_once</code>，可保证只初始化了一次；</li></ul><h2 id="真正的创建YYDiskCache对象"><a href="#真正的创建YYDiskCache对象" class="headerlink" title="真正的创建YYDiskCache对象"></a>真正的创建YYDiskCache对象</h2><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">instancetype</span>)initWithPath:(<span class="built_in">NSString</span> *)path</span><br><span class="line">            inlineThreshold:(<span class="built_in">NSUInteger</span>)threshold &#123;</span><br><span class="line">    <span class="keyword">self</span> = [<span class="keyword">super</span> init];</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">self</span>) <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ① 根据path利用_YYDiskCacheGetGlobal获取YYDiskCache对象</span></span><br><span class="line">    YYDiskCache *globalCache = _YYDiskCacheGetGlobal(path);</span><br><span class="line">    <span class="comment">// 存在的话直接返回，不需创建</span></span><br><span class="line">    <span class="keyword">if</span> (globalCache) <span class="keyword">return</span> globalCache;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ② YYDiskCache 真正的初始化操作</span></span><br><span class="line">    YYKVStorageType type;</span><br><span class="line">    <span class="keyword">if</span> (threshold == <span class="number">0</span>) &#123;</span><br><span class="line">        type = YYKVStorageTypeFile;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (threshold == <span class="built_in">NSUIntegerMax</span>) &#123;</span><br><span class="line">        type = YYKVStorageTypeSQLite;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        type = YYKVStorageTypeMixed;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 真正实现数据存取的对象</span></span><br><span class="line">    YYKVStorage *kv = [[YYKVStorage alloc] initWithPath:path type:type];</span><br><span class="line">    <span class="keyword">if</span> (!kv) <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    </span><br><span class="line">    _kv = kv;</span><br><span class="line">    _path = path;</span><br><span class="line">    <span class="comment">// 使用GCD 信号量 创建了一把锁，保证线程安全</span></span><br><span class="line">    _lock = dispatch_semaphore_create(<span class="number">1</span>);</span><br><span class="line">    <span class="comment">// 创建了一个自定义的并发队列</span></span><br><span class="line">    _queue = dispatch_queue_create(<span class="string">&quot;com.ibireme.cache.disk&quot;</span>, DISPATCH_QUEUE_CONCURRENT);</span><br><span class="line">    _inlineThreshold = threshold;</span><br><span class="line">    _countLimit = <span class="built_in">NSUIntegerMax</span>;</span><br><span class="line">    _costLimit = <span class="built_in">NSUIntegerMax</span>;</span><br><span class="line">    _ageLimit = DBL_MAX;</span><br><span class="line">    _freeDiskSpaceLimit = <span class="number">0</span>;</span><br><span class="line">    _autoTrimInterval = <span class="number">60</span>;</span><br><span class="line">    </span><br><span class="line">    [<span class="keyword">self</span> _trimRecursively];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ③ 存入：_YYDiskCacheSetGlobal</span></span><br><span class="line">    _YYDiskCacheSetGlobal(<span class="keyword">self</span>);</span><br><span class="line">    </span><br><span class="line">    [[<span class="built_in">NSNotificationCenter</span> defaultCenter] addObserver:<span class="keyword">self</span> selector:<span class="keyword">@selector</span>(_appWillBeTerminated) name:<span class="built_in">UIApplicationWillTerminateNotification</span> object:<span class="literal">nil</span>];</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="YYMemoryCache-初始化"><a href="#YYMemoryCache-初始化" class="headerlink" title="YYMemoryCache 初始化"></a>YYMemoryCache 初始化</h1></div><div class="post-copyright"><p class="copyright-item"> <span>Author:</span> <a href="http://yotrolz.com">YotrolZ</a></p><p class="copyright-item"> <span>Link:</span> <a href="http://yotrolz.com/posts/ba9af90f/">http://yotrolz.com/posts/ba9af90f/</a></p><p class="copyright-item"> <span>License:</span> <a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/" target="_blank">知识共享署名-非商业性使用 4.0 国际许可协议</a></p></div><footer class="post-footer"><nav class="post-nav"><a class="prev" href="/posts/5c5f8fb2/"><i class="iconfont icon-left"></i> <span class="prev-text nav-default">YYCache源码学习-磁盘缓存分析</span> <span class="prev-text nav-mobile">Prev</span></a> <a class="next" href="/posts/d115d42e/"><span class="next-text nav-default">图解iOS Block底层原理</span> <span class="prev-text nav-mobile">Next</span><i class="iconfont icon-right"></i></a></nav></footer></article></div><div class="comments" id="comments"></div></div></main><footer id="footer" class="footer"><div class="social-links"></div><div class="copyright"> <span class="power-by">Powered by <a class="hexo-link" target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a></span> <span class="division">|</span> <span class="theme-info">Theme - <a class="theme-link" target="_blank" rel="noopener" href="https://github.com/ahonn/hexo-theme-even">Even</a></span> <span class="copyright-year">&copy;2015 - 2022<span class="heart"><i class="iconfont icon-heart"></i></span> <span class="author">YotrolZ</span></span></div></footer><div class="back-to-top" id="back-to-top"><i class="iconfont icon-up"></i></div></div><script type="text/javascript" src="https://cdn.jsdelivr.net/gh/yotrolz/yotrolz.github.io@gh/lib/jquery/jquery.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/gh/yotrolz/yotrolz.github.io@gh/lib/slideout/slideout.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/gh/yotrolz/yotrolz.github.io@gh/lib/fancybox/jquery.fancybox.pack.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/gh/yotrolz/yotrolz.github.io@gh/js/src/even.js?v=2.11.0"></script></body></html>