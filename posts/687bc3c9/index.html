<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="theme-color" content="#f8f5ec"><meta name="msapplication-navbutton-color" content="#f8f5ec"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec"><meta name="description" content="iOS 程序启动与dyld加载"><link rel="alternate" href="/atom.xml" title="YotrolZ" type="application/atom+xml"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=2.11.0"><link rel="canonical" href="http://yotrolz.com/posts/687bc3c9/"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/yotrolz/yotrolz.github.io@gh/lib/fancybox/jquery.fancybox.css"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/yotrolz/yotrolz.github.io@gh/css/style.css?v=2.11.0"><script async src="https://www.googletagmanager.com/gtag/js?id=UA-138610487-3"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-138610487-3")</script><script id="baidu_push">!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}()</script><script src="//cdn.jsdelivr.net/npm/leancloud-storage@4.10.0/dist/av-min.js"></script><script id="leancloud">AV.init({appId:"mqfPQEKBtui9puAJUkYFY7Jn-MdYXbMMI",appKey:"A6R0T4bEvcBsTU8pB7NhJ6Wl"})</script><script>window.config={leancloud:{show_visits:!1,app_id:"mqfPQEKBtui9puAJUkYFY7Jn-MdYXbMMI",app_key:"A6R0T4bEvcBsTU8pB7NhJ6Wl"},toc:!0,fancybox:!0,pjax:"",latex:!1}</script><title>iOS 程序启动与dyld加载 - YotrolZ</title><meta name="generator" content="Hexo 5.4.1"></head><body><div id="mobile-navbar" class="mobile-navbar"><div class="mobile-header-logo"> <a href="/." class="logo">YotrolZ</a></div><div class="mobile-navbar-icon"><span></span><span></span><span></span></div></div><nav id="mobile-menu" class="mobile-menu slideout-menu"><ul class="mobile-menu-list"><a href="/"><li class="mobile-menu-item">Home</li></a><a href="/archives/"><li class="mobile-menu-item">Archives</li></a><a href="/tags/"><li class="mobile-menu-item">Tags</li></a><a href="/categories/"><li class="mobile-menu-item">Categories</li></a></ul></nav><div class="container" id="mobile-panel"><header id="header" class="header"><div class="logo-wrapper"> <a href="/." class="logo">YotrolZ</a></div><nav class="site-navbar"><ul id="menu" class="menu"><li class="menu-item"> <a class="menu-item-link" href="/">Home</a></li><li class="menu-item"> <a class="menu-item-link" href="/archives/">Archives</a></li><li class="menu-item"> <a class="menu-item-link" href="/tags/">Tags</a></li><li class="menu-item"> <a class="menu-item-link" href="/categories/">Categories</a></li></ul></nav></header><main id="main" class="main"><div class="content-wrapper"><div id="content" class="content"><article class="post"><header class="post-header"><h1 class="post-title">iOS 程序启动与dyld加载</h1><div class="post-meta"> <span class="post-time">2020-03-04</span> <span class="post-visits" style="display:none" data-url="/posts/687bc3c9/" data-title="iOS 程序启动与dyld加载">Visits 0</span></div></header><div class="post-toc" id="post-toc"><h2 class="post-toc-title">Contents</h2><div class="post-toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#dyld-%E7%AE%80%E4%BB%8B"><span class="toc-text">dyld 简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#dyld-%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B"><span class="toc-text">dyld 执行流程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#dyld-start"><span class="toc-text">_dyld_start</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#dyldbootstrap-start"><span class="toc-text">dyldbootstrap::start</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#dyld-main"><span class="toc-text">dyld::_main</span></a></li></ol></li></ol></div></div><div class="post-content"><p>众所周知：我们iOS程序的入口是<code>main.m</code>中的<code>main()</code>函数</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// main.m</span></span><br><span class="line"><span class="meta">#import <span class="string">&lt;UIKit/UIKit.h&gt;</span></span></span><br><span class="line"><span class="meta">#import <span class="string">&quot;AppDelegate.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">char</span> * argv[]) &#123;</span><br><span class="line">    <span class="built_in">NSString</span> * appDelegateClassName;</span><br><span class="line">    <span class="keyword">@autoreleasepool</span> &#123;</span><br><span class="line">        appDelegateClassName = <span class="built_in">NSStringFromClass</span>([AppDelegate <span class="keyword">class</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">UIApplicationMain</span>(argc, argv, <span class="literal">nil</span>, appDelegateClassName);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><span id="more"></span><p>那如果我们在main函数中打上断点</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// mian.m</span></span><br><span class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">char</span> * argv[]) &#123;</span><br><span class="line">    <span class="built_in">NSString</span> * appDelegateClassName; <span class="comment">// ⬅️ 断点①</span></span><br><span class="line">    <span class="keyword">@autoreleasepool</span> &#123;</span><br><span class="line">        <span class="comment">// Setup code that might create autoreleased objects goes here.</span></span><br><span class="line">        appDelegateClassName = <span class="built_in">NSStringFromClass</span>([AppDelegate <span class="keyword">class</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">UIApplicationMain</span>(argc, argv, <span class="literal">nil</span>, appDelegateClassName);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// AppDelegate.m</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">AppDelegate</span></span></span><br><span class="line"></span><br><span class="line">+ (<span class="keyword">void</span>)load &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;AppDelegate load&quot;</span>); <span class="comment">// ⬅️ 断点②</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">BOOL</span>)application:(<span class="built_in">UIApplication</span> *)application didFinishLaunchingWithOptions:(<span class="built_in">NSDictionary</span> *)launchOptions &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure><p>此时运行程序，发现我们先卡在了<code>断点②</code>, 我们进入LLDB 输入<code>bt</code></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">(lldb) bt</span><br><span class="line">* thread #<span class="number">1</span>, queue = <span class="string">&#x27;com.apple.main-thread&#x27;</span>, stop reason = breakpoint <span class="number">2.1</span></span><br><span class="line">  * frame #<span class="number">0</span>:  <span class="number">0x000000010eb8e0a7</span> dyld`+[AppDelegate load](self=AppDelegate, _cmd=<span class="string">&quot;load&quot;</span>) at AppDelegate.m:<span class="number">17</span>:<span class="number">5</span></span><br><span class="line">    frame #<span class="number">1</span>:  <span class="number">0x00007fff201804e3</span> libobjc.A.dylib`load_images + <span class="number">1442</span></span><br><span class="line">    frame #<span class="number">2</span>:  <span class="number">0x000000010eba1e54</span> dyld_sim`dyld::<span class="built_in">notifySingle</span>(dyld_image_states, ImageLoader <span class="type">const</span>*, ImageLoader::InitializerTimingList*) + <span class="number">425</span></span><br><span class="line">    frame #<span class="number">3</span>:  <span class="number">0x000000010ebb0887</span> dyld_sim`ImageLoader::<span class="built_in">recursiveInitialization</span>(ImageLoader::LinkContext <span class="type">const</span>&amp;, <span class="type">unsigned</span> <span class="type">int</span>, <span class="type">char</span> <span class="type">const</span>*, ImageLoader::InitializerTimingList&amp;, ImageLoader::UninitedUpwards&amp;) + <span class="number">437</span></span><br><span class="line">    frame #<span class="number">4</span>:  <span class="number">0x000000010ebaebb0</span> dyld_sim`ImageLoader::<span class="built_in">processInitializers</span>(ImageLoader::LinkContext <span class="type">const</span>&amp;, <span class="type">unsigned</span> <span class="type">int</span>, ImageLoader::InitializerTimingList&amp;, ImageLoader::UninitedUpwards&amp;) + <span class="number">188</span></span><br><span class="line">    frame #<span class="number">5</span>:  <span class="number">0x000000010ebaec50</span> dyld_sim`ImageLoader::<span class="built_in">runInitializers</span>(ImageLoader::LinkContext <span class="type">const</span>&amp;, ImageLoader::InitializerTimingList&amp;) + <span class="number">82</span></span><br><span class="line">    frame #<span class="number">6</span>:  <span class="number">0x000000010eba22a9</span> dyld_sim`dyld::<span class="built_in">initializeMainExecutable</span>() + <span class="number">199</span></span><br><span class="line">    frame #<span class="number">7</span>:  <span class="number">0x000000010eba6d50</span> dyld_sim`dyld::_main(macho_header <span class="type">const</span>*, <span class="type">unsigned</span> <span class="type">long</span>, <span class="type">int</span>, <span class="type">char</span> <span class="type">const</span>**, <span class="type">char</span> <span class="type">const</span>**, <span class="type">char</span> <span class="type">const</span>**, <span class="type">unsigned</span> <span class="type">long</span>*) + <span class="number">4431</span></span><br><span class="line">    frame #<span class="number">8</span>:  <span class="number">0x000000010eba11c7</span> dyld_sim`start_sim + <span class="number">122</span></span><br><span class="line">    frame #<span class="number">9</span>:  <span class="number">0x0000000116e7057a</span> dyld`dyld::<span class="built_in">useSimulatorDyld</span>(<span class="type">int</span>, macho_header <span class="type">const</span>*, <span class="type">char</span> <span class="type">const</span>*, <span class="type">int</span>, <span class="type">char</span> <span class="type">const</span>**, <span class="type">char</span> <span class="type">const</span>**, <span class="type">char</span> <span class="type">const</span>**, <span class="type">unsigned</span> <span class="type">long</span>*, <span class="type">unsigned</span> <span class="type">long</span>*) + <span class="number">2093</span></span><br><span class="line">    frame #<span class="number">10</span>: <span class="number">0x0000000116e6ddf3</span> dyld`dyld::_main(macho_header <span class="type">const</span>*, <span class="type">unsigned</span> <span class="type">long</span>, <span class="type">int</span>, <span class="type">char</span> <span class="type">const</span>**, <span class="type">char</span> <span class="type">const</span>**, <span class="type">char</span> <span class="type">const</span>**, <span class="type">unsigned</span> <span class="type">long</span>*) + <span class="number">1199</span></span><br><span class="line">    frame #<span class="number">11</span>: <span class="number">0x0000000116e6822b</span> dyld`dyldbootstrap::<span class="built_in">start</span>(dyld3::MachOLoaded <span class="type">const</span>*, <span class="type">int</span>, <span class="type">char</span> <span class="type">const</span>**, dyld3::MachOLoaded <span class="type">const</span>*, <span class="type">unsigned</span> <span class="type">long</span>*) + <span class="number">457</span></span><br><span class="line">    frame #<span class="number">12</span>: <span class="number">0x0000000116e68025</span> dyld`_dyld_start + <span class="number">37</span></span><br><span class="line">(lldb) </span><br></pre></td></tr></table></figure><p>由此可见，在我们的main()函数之前，执行了一系列的操作，比如加载类(调用 <code>+load()</code>)等，一大推的<code>dyld</code>的字眼，我们下面就介绍一下这个神秘的<code>dyld</code></p><h2 id="dyld-简介"><a href="#dyld-简介" class="headerlink" title="dyld 简介"></a>dyld 简介</h2><ul><li><p><code>dyld(The Dynamic Linker/Loader)</code>动态链接(加载)器，是操作系统的重要组成部分，在 macOS 系统中，dyld 位于 <code>Macintosh HD/usr/lib/dyld</code>。</p></li><li><p>dyld 源码是开源的，位于 <a target="_blank" rel="noopener" href="https://opensource.apple.com/tarballs/dyld/">https://opensource.apple.com/tarballs/dyld/</a></p></li></ul><h2 id="dyld-执行流程"><a href="#dyld-执行流程" class="headerlink" title="dyld 执行流程"></a>dyld 执行流程</h2><p>根据文头<code>LLDB bt</code> 信息得知：dyld 的入口是 <code>_dyld_start</code></p><h3 id="dyld-start"><a href="#dyld-start" class="headerlink" title="_dyld_start"></a>_dyld_start</h3><p>以 <code>arm64</code> 为例：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">#if __arm64__</span><br><span class="line">	.text</span><br><span class="line">	.align 2</span><br><span class="line">	.globl __dyld_start</span><br><span class="line">__dyld_start:</span><br><span class="line">	mov 	x28, sp</span><br><span class="line">	and     sp, x28, #~15		// force 16-byte alignment of stack</span><br><span class="line">	mov	x0, #0</span><br><span class="line">	mov	x1, #0</span><br><span class="line">	stp	x1, x0, [sp, #-16]!	// make aligned terminating frame</span><br><span class="line">	mov	fp, sp			// set up fp to point to terminating frame</span><br><span class="line">	sub	sp, sp, #16             // make room for local variables</span><br><span class="line">#if __LP64__</span><br><span class="line">	ldr     x0, [x28]               // get app&#x27;s mh into x0</span><br><span class="line">	ldr     x1, [x28, #8]           // get argc into x1 (kernel passes 32-bit int argc as 64-bits on stack to keep alignment)</span><br><span class="line">	add     x2, x28, #16            // get argv into x2</span><br><span class="line">#else</span><br><span class="line">	ldr     w0, [x28]               // get app&#x27;s mh into x0</span><br><span class="line">	ldr     w1, [x28, #4]           // get argc into x1 (kernel passes 32-bit int argc as 64-bits on stack to keep alignment)</span><br><span class="line">	add     w2, w28, #8             // get argv into x2</span><br><span class="line">#endif</span><br><span class="line">	adrp	x3,___dso_handle@page</span><br><span class="line">	add 	x3,x3,___dso_handle@pageoff // get dyld&#x27;s mh in to x4</span><br><span class="line">	mov	x4,sp                   // x5 has &amp;startGlue</span><br><span class="line"></span><br><span class="line">	// call dyldbootstrap::start(app_mh, argc, argv, dyld_mh, &amp;startGlue)</span><br><span class="line">	// 根据 LLDB bt 及上述注释，这里调用了 dyldbootstrap::start</span><br><span class="line">	bl	__ZN13dyldbootstrap5startEPKN5dyld311MachOLoadedEiPPKcS3_Pm</span><br><span class="line">	mov	x16,x0                  // save entry point address in x16</span><br><span class="line"></span><br><span class="line">	// 省略部分代码...</span><br><span class="line"></span><br><span class="line">#endif // __arm64__</span><br></pre></td></tr></table></figure><h3 id="dyldbootstrap-start"><a href="#dyldbootstrap-start" class="headerlink" title="dyldbootstrap::start"></a>dyldbootstrap::start</h3><p>位于 命名空间 <code>namespace dyldbootstrap</code> 下的 start 方法</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  This is code to bootstrap dyld.  This work in normally done for a program by dyld and crt.</span></span><br><span class="line"><span class="comment">//  In dyld we have to do this manually.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="function"><span class="type">uintptr_t</span> <span class="title">start</span><span class="params">(<span class="type">const</span> dyld3::MachOLoaded* appsMachHeader, <span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span>* argv[],</span></span></span><br><span class="line"><span class="params"><span class="function">				<span class="type">const</span> dyld3::MachOLoaded* dyldsMachHeader, <span class="type">uintptr_t</span>* startGlue)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// Emit kdebug tracepoint to indicate dyld bootstrap has started &lt;rdar://46878536&gt;</span></span><br><span class="line">    dyld3::<span class="built_in">kdebug_trace_dyld_marker</span>(DBG_DYLD_TIMING_BOOTSTRAP_START, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// if kernel had to slide dyld, we need to fix up load sensitive locations</span></span><br><span class="line">    <span class="comment">// we have to do this before using any global variables</span></span><br><span class="line">    <span class="comment">// 地址恢复</span></span><br><span class="line">    <span class="built_in">rebaseDyld</span>(dyldsMachHeader);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// kernel sets up env pointer to be just past end of agv array</span></span><br><span class="line">    <span class="type">const</span> <span class="type">char</span>** envp = &amp;argv[argc+<span class="number">1</span>];</span><br><span class="line">	</span><br><span class="line">    <span class="comment">// kernel sets up apple pointer to be just past end of envp array</span></span><br><span class="line">    <span class="type">const</span> <span class="type">char</span>** apple = envp;</span><br><span class="line">    <span class="keyword">while</span>(*apple != <span class="literal">NULL</span>) &#123; ++apple; &#125;</span><br><span class="line">    ++apple;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// set up random value for stack canary</span></span><br><span class="line">    __guard_setup(apple);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* DYLD_INITIALIZER_SUPPORT 的定义</span></span><br><span class="line"><span class="comment">// currently dyld has no initializers, but if some come back, set this to non-zero</span></span><br><span class="line"><span class="comment">#define DYLD_INITIALIZER_SUPPORT  0 </span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> DYLD_INITIALIZER_SUPPORT</span></span><br><span class="line">    <span class="comment">// run all C++ initializers inside dyld</span></span><br><span class="line">    <span class="built_in">runDyldInitializers</span>(argc, argv, envp, apple);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// now that we are done bootstrapping dyld, call dyld&#x27;s main</span></span><br><span class="line">    <span class="type">uintptr_t</span> appsSlide = appsMachHeader-&gt;<span class="built_in">getSlide</span>();</span><br><span class="line">    <span class="keyword">return</span> dyld::_main((macho_header*)appsMachHeader, appsSlide, argc, argv, envp, apple, startGlue);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="dyld-main"><a href="#dyld-main" class="headerlink" title="dyld::_main"></a>dyld::_main</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">intptr_t</span></span><br><span class="line">_main(<span class="type">const</span> macho_header* mainExecutableMH, <span class="type">uintptr_t</span> mainExecutableSlide,</span><br><span class="line">		<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span>* argv[], <span class="type">const</span> <span class="type">char</span>* envp[], <span class="type">const</span> <span class="type">char</span>* apple[], </span><br><span class="line">		<span class="type">uintptr_t</span>* startGlue)</span><br><span class="line">&#123;</span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    <span class="type">uintptr_t</span> result = <span class="number">0</span>;</span><br><span class="line">    sMainExecutableMachHeader = mainExecutableMH;</span><br><span class="line">    sMainExecutableSlide = mainExecutableSlide;</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    <span class="built_in">CRSetCrashLogMessage</span>(<span class="string">&quot;dyld: launch started&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置上下文等信息</span></span><br><span class="line">    <span class="built_in">setContext</span>(mainExecutableMH, argc, argv, envp, apple);</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 检查环境变量</span></span><br><span class="line">    <span class="built_in">checkEnvironmentVariables</span>(envp);</span><br><span class="line">    <span class="built_in">defaultUninitializedFallbackPaths</span>(envp);</span><br><span class="line">    <span class="comment">// 根据环境变量进行打印输出</span></span><br><span class="line">    <span class="keyword">if</span> ( sEnv.DYLD_PRINT_OPTS )</span><br><span class="line">      <span class="built_in">printOptions</span>(argv);</span><br><span class="line">    <span class="keyword">if</span> ( sEnv.DYLD_PRINT_ENV ) </span><br><span class="line">      <span class="built_in">printEnvironmentVariables</span>(envp);</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 加载 shared cache</span></span><br><span class="line">    <span class="comment">// load shared cache</span></span><br><span class="line">    <span class="built_in">checkSharedRegionDisable</span>((dyld3::MachOLoaded*)mainExecutableMH, mainExecutableSlide);</span><br><span class="line">    <span class="keyword">if</span> ( gLinkContext.sharedRegionMode != ImageLoader::kDontUseSharedRegion ) &#123;</span><br><span class="line">      <span class="built_in">mapSharedCache</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 主要用于判别 dyld2 还是 dyld3</span></span><br><span class="line">    <span class="comment">// If we haven&#x27;t got a closure mode yet, then check the environment and cache type</span></span><br><span class="line">    <span class="keyword">if</span> ( sClosureMode == ClosureMode::Unset ) &#123;</span><br><span class="line">        <span class="comment">// First test to see if we forced in dyld2 via a kernel boot-arg</span></span><br><span class="line">        <span class="keyword">if</span> ( dyld3::BootArgs::forceDyld2() ) &#123;</span><br><span class="line">            sClosureMode = ClosureMode::Off;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> ( <span class="built_in">inDenyList</span>(sExecPath) ) &#123;</span><br><span class="line">            sClosureMode = ClosureMode::Off;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> ( sEnv.hasOverride ) &#123;</span><br><span class="line">            sClosureMode = ClosureMode::Off;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> ( dyld3::BootArgs::forceDyld3() ) &#123;</span><br><span class="line">            sClosureMode = ClosureMode::On;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            sClosureMode = <span class="built_in">getPlatformDefaultClosureMode</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> !TARGET_OS_SIMULATOR</span></span><br><span class="line">    <span class="keyword">if</span> ( sClosureMode == ClosureMode::Off ) &#123;</span><br><span class="line">        <span class="keyword">if</span> ( gLinkContext.verboseWarnings )</span><br><span class="line">          dyld::<span class="built_in">log</span>(<span class="string">&quot;dyld: not using closure because of DYLD_USE_CLOSURES or -force_dyld2=1 override\n&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        </span><br><span class="line">        ......</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 关于 dyld3 closure 的部分</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 首先从 cache 中检查 closure</span></span><br><span class="line">        <span class="comment">// check for closure in cache first</span></span><br><span class="line">        <span class="keyword">if</span> ( sSharedCacheLoadInfo.loadAddress != <span class="literal">nullptr</span> ) &#123;</span><br><span class="line">            mainClosure = sSharedCacheLoadInfo.loadAddress-&gt;<span class="built_in">findClosure</span>(sExecPath);</span><br><span class="line">            <span class="keyword">if</span> ( gLinkContext.verboseWarnings &amp;&amp; (mainClosure != <span class="literal">nullptr</span>) )</span><br><span class="line">                dyld::<span class="built_in">log</span>(<span class="string">&quot;dyld: found closure %p (size=%lu) in dyld shared cache\n&quot;</span>, mainClosure, mainClosure-&gt;<span class="built_in">size</span>());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// We only want to try build a closure at runtime if its an iOS third party binary, or a macOS binary from the shared cache</span></span><br><span class="line">        <span class="type">bool</span> allowClosureRebuilds = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">if</span> ( sClosureMode == ClosureMode::On ) &#123;</span><br><span class="line">          allowClosureRebuilds = <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> ( (sClosureMode == ClosureMode::PreBuiltOnly) &amp;&amp; (mainClosure != <span class="literal">nullptr</span>) ) &#123;</span><br><span class="line">          allowClosureRebuilds = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ( (mainClosure != <span class="literal">nullptr</span>) &amp;&amp; !<span class="built_in">closureValid</span>(mainClosure, mainFileInfo, mainExecutableCDHash, <span class="literal">true</span>, envp) )</span><br><span class="line">          mainClosure = <span class="literal">nullptr</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 如果在cache中找不到有效的closure，我们就新建一个</span></span><br><span class="line">        <span class="comment">// If we didn&#x27;t find a valid cache closure then try build a new one</span></span><br><span class="line">        <span class="keyword">if</span> ( (mainClosure == <span class="literal">nullptr</span>) &amp;&amp; allowClosureRebuilds ) &#123;</span><br><span class="line">            <span class="comment">// 在cache中查找 closure</span></span><br><span class="line">            <span class="comment">// if forcing closures, and no closure in cache, or it is invalid, check for cached closure</span></span><br><span class="line">            <span class="keyword">if</span> ( !sForceInvalidSharedCacheClosureFormat )</span><br><span class="line">                mainClosure = <span class="built_in">findCachedLaunchClosure</span>(mainExecutableCDHash, mainFileInfo, envp);</span><br><span class="line">            <span class="keyword">if</span> ( mainClosure == <span class="literal">nullptr</span> ) &#123;</span><br><span class="line">                <span class="comment">// cache 中没有找到 --&gt; 创建新的 closure</span></span><br><span class="line">                <span class="comment">// if  no cached closure found, build new one</span></span><br><span class="line">                mainClosure = <span class="built_in">buildLaunchClosure</span>(mainExecutableCDHash, mainFileInfo, envp);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// exit dyld after closure is built, without running program</span></span><br><span class="line">        <span class="keyword">if</span> ( sJustBuildClosure )</span><br><span class="line">          _exit(EXIT_SUCCESS);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 尝试使用 launch closure</span></span><br><span class="line">        <span class="comment">// try using launch closure</span></span><br><span class="line">        <span class="keyword">if</span> ( mainClosure != <span class="literal">nullptr</span> ) &#123;</span><br><span class="line">            <span class="built_in">CRSetCrashLogMessage</span>(<span class="string">&quot;dyld3: launch started&quot;</span>);</span><br><span class="line">            <span class="type">bool</span> launched = <span class="built_in">launchWithClosure</span>(mainClosure, sSharedCacheLoadInfo.loadAddress, (dyld3::MachOLoaded*)mainExecutableMH,</span><br><span class="line">                            mainExecutableSlide, argc, argv, envp, apple, &amp;result, startGlue);</span><br><span class="line">            <span class="keyword">if</span> ( !launched &amp;&amp; allowClosureRebuilds ) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">/* </span></span><br><span class="line"><span class="comment">                * 如果closure已经过期，就新建一个</span></span><br><span class="line"><span class="comment">                * buildLaunchClosure 内部会将新建的 closure 保存到硬盘，便于下一次能快速启动</span></span><br><span class="line"><span class="comment">                * buildLaunchClosure 内部官方注释：try to atomically save closure to disk to speed up next launch</span></span><br><span class="line"><span class="comment">                */</span></span><br><span class="line">                <span class="comment">// closure is out of date, build new one</span></span><br><span class="line">                mainClosure = <span class="built_in">buildLaunchClosure</span>(mainExecutableCDHash, mainFileInfo, envp);</span><br><span class="line">                <span class="keyword">if</span> ( mainClosure != <span class="literal">nullptr</span> ) &#123;</span><br><span class="line">                launched = <span class="built_in">launchWithClosure</span>(mainClosure, sSharedCacheLoadInfo.loadAddress, (dyld3::MachOLoaded*)mainExecutableMH,</span><br><span class="line">                                mainExecutableSlide, argc, argv, envp, apple, &amp;result, startGlue);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> ( launched ) &#123;</span><br><span class="line">                gLinkContext.startedInitializingMainExecutable = <span class="literal">true</span>;</span><br><span class="line">        <span class="meta">#<span class="keyword">if</span> __has_feature(ptrauth_calls)</span></span><br><span class="line">                <span class="comment">// start() calls the result pointer as a function pointer so we need to sign it.</span></span><br><span class="line">                result = (<span class="type">uintptr_t</span>)__builtin_ptrauth_sign_unauthenticated((<span class="type">void</span>*)result, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">        <span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">                <span class="keyword">if</span> (sSkipMain)</span><br><span class="line">                    result = (<span class="type">uintptr_t</span>)&amp;fake_main;</span><br><span class="line">                <span class="keyword">return</span> result;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> ( gLinkContext.verboseWarnings ) &#123;</span><br><span class="line">                    dyld::<span class="built_in">log</span>(<span class="string">&quot;dyld: unable to use closure %p\n&quot;</span>, mainClosure);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// TARGET_OS_SIMULATOR</span></span></span><br><span class="line">	<span class="comment">// could not use closure info, launch old way</span></span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    <span class="comment">// install gdb notifier</span></span><br><span class="line">    <span class="built_in">stateToHandlers</span>(dyld_image_state_dependents_mapped, sBatchHandlers)-&gt;<span class="built_in">push_back</span>(notifyGDB);</span><br><span class="line">    <span class="built_in">stateToHandlers</span>(dyld_image_state_mapped, sSingleHandlers)-&gt;<span class="built_in">push_back</span>(updateAllImages);</span><br><span class="line">    <span class="comment">// make initial allocations large enough that it is unlikely to need to be re-alloced</span></span><br><span class="line">    sImageRoots.<span class="built_in">reserve</span>(<span class="number">16</span>);</span><br><span class="line">    sAddImageCallbacks.<span class="built_in">reserve</span>(<span class="number">4</span>);</span><br><span class="line">    sRemoveImageCallbacks.<span class="built_in">reserve</span>(<span class="number">4</span>);</span><br><span class="line">    sAddLoadImageCallbacks.<span class="built_in">reserve</span>(<span class="number">4</span>);</span><br><span class="line">    sImageFilesNeedingTermination.<span class="built_in">reserve</span>(<span class="number">16</span>);</span><br><span class="line">    sImageFilesNeedingDOFUnregistration.<span class="built_in">reserve</span>(<span class="number">8</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 将dyld本身添加到UUID列表</span></span><br><span class="line">        <span class="comment">// add dyld itself to UUID list</span></span><br><span class="line">        <span class="built_in">addDyldImageToUUIDList</span>();</span><br><span class="line"></span><br><span class="line">        ......</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 实例化主程序ImageLoader</span></span><br><span class="line">        <span class="comment">// instantiate ImageLoader for main executable</span></span><br><span class="line">        sMainExecutable = <span class="built_in">instantiateFromLoadedImage</span>(mainExecutableMH, mainExecutableSlide, sExecPath);</span><br><span class="line">        gLinkContext.mainExecutable = sMainExecutable;</span><br><span class="line">        gLinkContext.mainExecutableCodeSigned = <span class="built_in">hasCodeSignatureLoadCommand</span>(mainExecutableMH);</span><br><span class="line"></span><br><span class="line">        ......</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 加载 inserted libraries</span></span><br><span class="line">        <span class="comment">// load any inserted libraries</span></span><br><span class="line">        <span class="keyword">if</span> ( sEnv.DYLD_INSERT_LIBRARIES != <span class="literal">NULL</span> ) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">const</span> <span class="type">char</span>* <span class="type">const</span>* lib = sEnv.DYLD_INSERT_LIBRARIES; *lib != <span class="literal">NULL</span>; ++lib) </span><br><span class="line">                <span class="built_in">loadInsertedDylib</span>(*lib);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// record count of inserted libraries so that a flat search will look at </span></span><br><span class="line">        <span class="comment">// inserted libraries, then main, then others.</span></span><br><span class="line">        sInsertedDylibCount = sAllImages.<span class="built_in">size</span>()<span class="number">-1</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 链接主程序</span></span><br><span class="line">        <span class="comment">// link main executable</span></span><br><span class="line">        gLinkContext.linkingMainExecutable = <span class="literal">true</span>;</span><br><span class="line">        <span class="built_in">link</span>(sMainExecutable, sEnv.DYLD_BIND_AT_LAUNCH, <span class="literal">true</span>, ImageLoader::<span class="built_in">RPathChain</span>(<span class="literal">NULL</span>, <span class="literal">NULL</span>), <span class="number">-1</span>);</span><br><span class="line">        sMainExecutable-&gt;<span class="built_in">setNeverUnloadRecursive</span>();</span><br><span class="line">        <span class="keyword">if</span> ( sMainExecutable-&gt;forceFlat() ) &#123;</span><br><span class="line">            gLinkContext.bindFlat = <span class="literal">true</span>;</span><br><span class="line">            gLinkContext.prebindUsage = ImageLoader::kUseNoPrebinding;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 链接 inserted libraries</span></span><br><span class="line">        <span class="comment">// link any inserted libraries</span></span><br><span class="line">        <span class="comment">// do this after linking main executable so that any dylibs pulled in by inserted </span></span><br><span class="line">        <span class="comment">// dylibs (e.g. libSystem) will not be in front of dylibs the program uses</span></span><br><span class="line">        <span class="keyword">if</span> ( sInsertedDylibCount &gt; <span class="number">0</span> ) &#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="type">unsigned</span> <span class="type">int</span> i=<span class="number">0</span>; i &lt; sInsertedDylibCount; ++i) &#123;</span><br><span class="line">                ImageLoader* image = sAllImages[i+<span class="number">1</span>];</span><br><span class="line">                <span class="built_in">link</span>(image, sEnv.DYLD_BIND_AT_LAUNCH, <span class="literal">true</span>, ImageLoader::<span class="built_in">RPathChain</span>(<span class="literal">NULL</span>, <span class="literal">NULL</span>), <span class="number">-1</span>);</span><br><span class="line">                image-&gt;<span class="built_in">setNeverUnloadRecursive</span>();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> ( gLinkContext.allowInterposing ) &#123;</span><br><span class="line">                <span class="comment">// only INSERTED libraries can interpose</span></span><br><span class="line">                <span class="comment">// register interposing info after all inserted libraries are bound so chaining works</span></span><br><span class="line">                <span class="keyword">for</span>(<span class="type">unsigned</span> <span class="type">int</span> i=<span class="number">0</span>; i &lt; sInsertedDylibCount; ++i) &#123;</span><br><span class="line">                    ImageLoader* image = sAllImages[i+<span class="number">1</span>];</span><br><span class="line">                    image-&gt;<span class="built_in">registerInterposing</span>(gLinkContext);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ( gLinkContext.allowInterposing ) &#123;</span><br><span class="line">            <span class="comment">// &lt;rdar://problem/19315404&gt; dyld should support interposition even without DYLD_INSERT_LIBRARIES</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="type">long</span> i=sInsertedDylibCount+<span class="number">1</span>; i &lt; sAllImages.<span class="built_in">size</span>(); ++i) &#123;</span><br><span class="line">                ImageLoader* image = sAllImages[i];</span><br><span class="line">                <span class="keyword">if</span> ( image-&gt;<span class="built_in">inSharedCache</span>() )</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                image-&gt;<span class="built_in">registerInterposing</span>(gLinkContext);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ......</span><br><span class="line"></span><br><span class="line">        <span class="comment">// apply interposing to initial set of images</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>; i &lt; sImageRoots.<span class="built_in">size</span>(); ++i) &#123;</span><br><span class="line">            sImageRoots[i]-&gt;<span class="built_in">applyInterposing</span>(gLinkContext);</span><br><span class="line">        &#125;</span><br><span class="line">        ImageLoader::<span class="built_in">applyInterposingToDyldCache</span>(gLinkContext);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Bind and notify for the main executable now that interposing has been registered</span></span><br><span class="line">        <span class="type">uint64_t</span> bindMainExecutableStartTime = <span class="built_in">mach_absolute_time</span>();</span><br><span class="line">        sMainExecutable-&gt;<span class="built_in">recursiveBindWithAccounting</span>(gLinkContext, sEnv.DYLD_BIND_AT_LAUNCH, <span class="literal">true</span>);</span><br><span class="line">        <span class="type">uint64_t</span> bindMainExecutableEndTime = <span class="built_in">mach_absolute_time</span>();</span><br><span class="line">        ImageLoaderMachO::fgTotalBindTime += bindMainExecutableEndTime - bindMainExecutableStartTime;</span><br><span class="line">        gLinkContext.<span class="built_in">notifyBatch</span>(dyld_image_state_bound, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Bind and notify for the inserted images now interposing has been registered</span></span><br><span class="line">        <span class="keyword">if</span> ( sInsertedDylibCount &gt; <span class="number">0</span> ) &#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="type">unsigned</span> <span class="type">int</span> i=<span class="number">0</span>; i &lt; sInsertedDylibCount; ++i) &#123;</span><br><span class="line">                ImageLoader* image = sAllImages[i+<span class="number">1</span>];</span><br><span class="line">                image-&gt;<span class="built_in">recursiveBind</span>(gLinkContext, sEnv.DYLD_BIND_AT_LAUNCH, <span class="literal">true</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// &lt;rdar://problem/12186933&gt; do weak binding only after all inserted images linked</span></span><br><span class="line">        sMainExecutable-&gt;<span class="built_in">weakBind</span>(gLinkContext);</span><br><span class="line">        gLinkContext.linkingMainExecutable = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        sMainExecutable-&gt;<span class="built_in">recursiveMakeDataReadOnly</span>(gLinkContext);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">CRSetCrashLogMessage</span>(<span class="string">&quot;dyld: launch, running initializers&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 运行所有初始化程序(🔔🔔🔔这个方法相当的重要❗️❗️❗️)</span></span><br><span class="line">        <span class="comment">// run all initializers</span></span><br><span class="line">        <span class="built_in">initializeMainExecutable</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 通知一些监视进程该进程将要进入main()</span></span><br><span class="line">        <span class="comment">// notify any montoring proccesses that this process is about to enter main()</span></span><br><span class="line">        <span class="built_in">notifyMonitoringDyldMain</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 查找主程序的入口</span></span><br><span class="line">        <span class="comment">// find entry point for main executable</span></span><br><span class="line">        result = (<span class="type">uintptr_t</span>)sMainExecutable-&gt;<span class="built_in">getEntryFromLC_MAIN</span>();</span><br><span class="line">        <span class="keyword">if</span> ( result != <span class="number">0</span> ) &#123;</span><br><span class="line">            <span class="comment">// main executable uses LC_MAIN, we need to use helper in libdyld to call into main()</span></span><br><span class="line">            <span class="keyword">if</span> ( (gLibSystemHelpers != <span class="literal">NULL</span>) &amp;&amp; (gLibSystemHelpers-&gt;version &gt;= <span class="number">9</span>) )</span><br><span class="line">                *startGlue = (<span class="type">uintptr_t</span>)gLibSystemHelpers-&gt;startGlueToCallExit;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                <span class="built_in">halt</span>(<span class="string">&quot;libdyld.dylib support not present for LC_MAIN&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// main executable uses LC_UNIXTHREAD, dyld needs to let &quot;start&quot; in program set up for main()</span></span><br><span class="line">            result = (<span class="type">uintptr_t</span>)sMainExecutable-&gt;<span class="built_in">getEntryFromLC_UNIXTHREAD</span>();</span><br><span class="line">            *startGlue = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">catch</span>(<span class="type">const</span> <span class="type">char</span>* message) &#123;</span><br><span class="line">		<span class="built_in">syncAllImages</span>();</span><br><span class="line">		<span class="built_in">halt</span>(message);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">catch</span>(...) &#123;</span><br><span class="line">		dyld::<span class="built_in">log</span>(<span class="string">&quot;dyld: launch failed\n&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><ul><li>设置上下文等信息 <code>setContext()</code></li><li>检查环境变量 <code>checkEnvironmentVariables()</code></li><li>加载共享缓存 <code>mapSharedCache()</code></li><li>将dyld本身添加到UUID列表 <code>addDyldImageToUUIDList()</code></li><li>实例化主程序 ImageLoader <code>instantiateFromLoadedImage</code></li><li>主程序签名相关 <code>hasCodeSignatureLoadCommand</code></li><li>链接主程序 <code>link()</code></li><li>链接 inserted libraries <code>link()</code></li><li>运行所有初始化程序 <code>initializeMainExecutable()</code></li><li>通知一些监视进程该进程将要进入main() <code>notifyMonitoringDyldMain()</code></li><li>查找主程序的入口 <code>getEntryFromLC_MAIN()</code></li></ul></div><div class="post-copyright"><p class="copyright-item"> <span>Author:</span> <a href="http://yotrolz.com">YotrolZ</a></p><p class="copyright-item"> <span>Link:</span> <a href="http://yotrolz.com/posts/687bc3c9/">http://yotrolz.com/posts/687bc3c9/</a></p><p class="copyright-item"> <span>License:</span> <a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/" target="_blank">知识共享署名-非商业性使用 4.0 国际许可协议</a></p></div><footer class="post-footer"><nav class="post-nav"><a class="prev" href="/posts/82d040e4/"><i class="iconfont icon-left"></i> <span class="prev-text nav-default">DYLD_PRINT_STATISTICS</span> <span class="prev-text nav-mobile">Prev</span></a> <a class="next" href="/posts/176b7c9e/"><span class="next-text nav-default">图片渲染内存消耗</span> <span class="prev-text nav-mobile">Next</span><i class="iconfont icon-right"></i></a></nav></footer></article></div><div class="comments" id="comments"></div></div></main><footer id="footer" class="footer"><div class="social-links"></div><div class="copyright"> <span class="power-by">Powered by <a class="hexo-link" target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a></span> <span class="division">|</span> <span class="theme-info">Theme - <a class="theme-link" target="_blank" rel="noopener" href="https://github.com/ahonn/hexo-theme-even">Even</a></span> <span class="copyright-year">&copy;2015 - 2022<span class="heart"><i class="iconfont icon-heart"></i></span> <span class="author">YotrolZ</span></span></div></footer><div class="back-to-top" id="back-to-top"><i class="iconfont icon-up"></i></div></div><script type="text/javascript" src="https://cdn.jsdelivr.net/gh/yotrolz/yotrolz.github.io@gh/lib/jquery/jquery.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/gh/yotrolz/yotrolz.github.io@gh/lib/slideout/slideout.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/gh/yotrolz/yotrolz.github.io@gh/lib/fancybox/jquery.fancybox.pack.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/gh/yotrolz/yotrolz.github.io@gh/js/src/even.js?v=2.11.0"></script></body></html>