<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="theme-color" content="#f8f5ec"><meta name="msapplication-navbutton-color" content="#f8f5ec"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec"><meta name="description" content="YYMemoryCache æ˜¯ä¸€ä¸ªå¿«é€Ÿçš„å†…å­˜ç¼“å­˜ï¼Œç”¨äºå­˜å‚¨é”®å€¼å¯¹ã€‚APIå’Œæ€§èƒ½ç±»ä¼¼äº`NSCache`ã€‚æ‰€æœ‰æ–¹æ³•éƒ½æ˜¯`çº¿ç¨‹å®‰å…¨`çš„ï¼›é‡‡ç”¨`LRU`æ¥ç§»é™¤æ•°æ®ï¼›å¯é…ç½®ä¸ºå½“æ”¶åˆ°`å†…å­˜è­¦å‘Š`æˆ–`appè¿›å…¥åå°`æ—¶è‡ªåŠ¨æ¸…é™¤å¯¹è±¡ï¼›è¯»å–æ“ä½œç›¸å…³çš„apiçš„æ—¶é—´å¤æ‚åº¦ä¸ºO(1)ã€‚"><link rel="alternate" href="/atom.xml" title="YotrolZ" type="application/atom+xml"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=2.11.0"><link rel="canonical" href="http://yotrolz.com/posts/ac25c853/"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/yotrolz/yotrolz.github.io@gh/lib/fancybox/jquery.fancybox.css"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/yotrolz/yotrolz.github.io@gh/css/style.css?v=2.11.0"><script async src="https://www.googletagmanager.com/gtag/js?id=UA-138610487-3"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-138610487-3")</script><script id="baidu_push">!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}()</script><script src="//cdn.jsdelivr.net/npm/leancloud-storage@4.10.0/dist/av-min.js"></script><script id="leancloud">AV.init({appId:"mqfPQEKBtui9puAJUkYFY7Jn-MdYXbMMI",appKey:"A6R0T4bEvcBsTU8pB7NhJ6Wl"})</script><script>window.config={leancloud:{show_visits:!1,app_id:"mqfPQEKBtui9puAJUkYFY7Jn-MdYXbMMI",app_key:"A6R0T4bEvcBsTU8pB7NhJ6Wl"},toc:!0,fancybox:!0,pjax:"",latex:!1}</script><title>YYCacheæºç å­¦ä¹ -å†…å­˜ç¼“å­˜åˆ†æ - YotrolZ</title><meta name="generator" content="Hexo 5.4.1"></head><body><div id="mobile-navbar" class="mobile-navbar"><div class="mobile-header-logo"> <a href="/." class="logo">YotrolZ</a></div><div class="mobile-navbar-icon"><span></span><span></span><span></span></div></div><nav id="mobile-menu" class="mobile-menu slideout-menu"><ul class="mobile-menu-list"><a href="/"><li class="mobile-menu-item">Home</li></a><a href="/archives/"><li class="mobile-menu-item">Archives</li></a><a href="/tags/"><li class="mobile-menu-item">Tags</li></a><a href="/categories/"><li class="mobile-menu-item">Categories</li></a></ul></nav><div class="container" id="mobile-panel"><header id="header" class="header"><div class="logo-wrapper"> <a href="/." class="logo">YotrolZ</a></div><nav class="site-navbar"><ul id="menu" class="menu"><li class="menu-item"> <a class="menu-item-link" href="/">Home</a></li><li class="menu-item"> <a class="menu-item-link" href="/archives/">Archives</a></li><li class="menu-item"> <a class="menu-item-link" href="/tags/">Tags</a></li><li class="menu-item"> <a class="menu-item-link" href="/categories/">Categories</a></li></ul></nav></header><main id="main" class="main"><div class="content-wrapper"><div id="content" class="content"><article class="post"><header class="post-header"><h1 class="post-title">YYCacheæºç å­¦ä¹ -å†…å­˜ç¼“å­˜åˆ†æ</h1><div class="post-meta"> <span class="post-time">2019-10-29</span> <span class="post-visits" style="display:none" data-url="/posts/ac25c853/" data-title="YYCacheæºç å­¦ä¹ -å†…å­˜ç¼“å­˜åˆ†æ">Visits 0</span></div></header><div class="post-toc" id="post-toc"><h2 class="post-toc-title">Contents</h2><div class="post-toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#YYMemoryCache-%E7%AE%80%E4%BB%8B"><span class="toc-text">YYMemoryCache ç®€ä»‹</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#YYMemoryCache-%E6%BA%90%E7%A0%81%E6%80%BB%E8%A7%88"><span class="toc-text">YYMemoryCache æºç æ€»è§ˆ</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#YYMemoryCache-%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-text">YYMemoryCache åˆå§‹åŒ–</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#YYMemoryCache-%E5%AE%9A%E6%97%B6%E6%8E%A2%E6%B5%8B%E6%9C%BA%E5%88%B6"><span class="toc-text">YYMemoryCache å®šæ—¶æ¢æµ‹æœºåˆ¶</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#YYLinkedMap-amp-YYLinkedMapNode"><span class="toc-text">_YYLinkedMap &amp; _YYLinkedMapNode</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#YYMemoryCache-LRU"><span class="toc-text">YYMemoryCache LRU</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#trimToCount"><span class="toc-text">trimToCount</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%82%E6%AD%A5%E9%87%8A%E6%94%BE%E5%AF%B9%E8%B1%A1"><span class="toc-text">å¼‚æ­¥é‡Šæ”¾å¯¹è±¡</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#removeTailNode"><span class="toc-text">removeTailNode</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#objectForKey"><span class="toc-text">objectForKey</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#bringNodeToHead"><span class="toc-text">bringNodeToHead</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#YYMemoryCache%E8%AF%BB%E5%8F%96%E6%93%8D%E4%BD%9C%E6%97%B6%E9%97%B4%E5%A4%8D%E6%9D%82%E5%BA%A6O-1"><span class="toc-text">YYMemoryCacheè¯»å–æ“ä½œæ—¶é—´å¤æ‚åº¦O(1)</span></a></li></ol></div></div><div class="post-content"><p>åœ¨<a href="https://yotrolz.com/posts/ba9af90f/">ä¸Šä¸€ç¯‡æ–‡ç« </a>ä¸­ï¼Œæˆ‘ä»¬å¯¹<code>YYCache</code>çš„åˆå§‹åŒ–æ“ä½œäº†åšäº†ç®€å•åˆ†æï¼Œå…·ä½“ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// YYCache.m</span></span><br><span class="line">- (<span class="keyword">instancetype</span>)initWithPath:(<span class="built_in">NSString</span> *)path &#123;</span><br><span class="line">    <span class="keyword">if</span> (path.length == <span class="number">0</span>) <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// â‘  åˆå§‹åŒ–ç£ç›˜ç¼“å­˜</span></span><br><span class="line">    YYDiskCache *diskCache = [[YYDiskCache alloc] initWithPath:path];</span><br><span class="line">    <span class="keyword">if</span> (!diskCache) <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    <span class="built_in">NSString</span> *name = [path lastPathComponent];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// â‘¡ åˆå§‹åŒ–å†…å­˜ç¼“å­˜</span></span><br><span class="line">    YYMemoryCache *memoryCache = [YYMemoryCache new];</span><br><span class="line">    memoryCache.name = name;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// â‘¢ åˆå§‹åŒ–æœ¬èº«å¹¶å¯¹å†…éƒ¨çš„ä¸‰ä¸ªåªè¯»å±æ€§è¿›è¡Œèµ‹å€¼</span></span><br><span class="line">    <span class="keyword">self</span> = [<span class="keyword">super</span> init];</span><br><span class="line">    _name = name;</span><br><span class="line">    _diskCache = diskCache;</span><br><span class="line">    _memoryCache = memoryCache;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>æœ¬ç¯‡æ–‡ç« æˆ‘ä»¬ä»‹ç»ä¸€ä¸‹ <code>YYMemoryCache</code> ç£ç›˜ç¼“å­˜çš„å®ç°</p></blockquote><h1 id="YYMemoryCache-ç®€ä»‹"><a href="#YYMemoryCache-ç®€ä»‹" class="headerlink" title="YYMemoryCache ç®€ä»‹"></a>YYMemoryCache ç®€ä»‹</h1><p>å…ˆæ¥çœ‹ä¸€ä¸‹å®˜æ–¹ä»‹ç»(å¯åœ¨æºç ä¸­æŸ¥é˜…):</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">`YYMemoryCache`æ˜¯ä¸€ç§å¿«é€Ÿçš„`å†…å­˜ç¼“å­˜`ï¼Œç”¨äºå­˜å‚¨`é”®å€¼å¯¹`ã€‚</span><br><span class="line">ä¸NSDictionaryä¸åŒï¼Œkeyæ˜¯retainçš„ï¼Œè€Œä¸æ˜¯copy(å¿…é¡»ç¬¦åˆNSCopyingåè®®)çš„ã€‚</span><br><span class="line">APIå’Œæ€§èƒ½ç±»ä¼¼äº`NSCache`ï¼Œæ‰€æœ‰æ–¹æ³•éƒ½æ˜¯`çº¿ç¨‹å®‰å…¨`çš„ã€‚</span><br><span class="line"></span><br><span class="line">YYMemoryCacheå¯¹è±¡ä¸NSCacheåœ¨ä»¥ä¸‹å‡ ä¸ªæ–¹é¢æœ‰æ‰€ä¸åŒ:</span><br><span class="line">- å®ƒä½¿ç”¨LRU(æœ€è¿‘æœ€å°‘ä½¿ç”¨)åˆ é™¤å¯¹è±¡;NSCacheé©±é€çš„æ–¹æ³•</span><br><span class="line">æ˜¯ä¸ç¡®å®šçš„ã€‚</span><br><span class="line">- å¯é€šè¿‡costã€countã€ageè¿›è¡Œæ§åˆ¶;NSCacheçš„é™åˆ¶å¹¶ä¸ç²¾ç¡®ã€‚</span><br><span class="line">- å¯é…ç½®ä¸ºå½“æ”¶åˆ°å†…å­˜è­¦å‘Šæˆ–appè¿›å…¥åå°æ—¶è‡ªåŠ¨æ¸…é™¤å¯¹è±¡ã€‚</span><br><span class="line"></span><br><span class="line">`YYMemoryCache`ä¸­è¯»å–æ“ä½œç›¸å…³çš„apiçš„æ—¶é—´å¤æ‚åº¦O(1)ã€‚</span><br></pre></td></tr></table></figure><h1 id="YYMemoryCache-æºç æ€»è§ˆ"><a href="#YYMemoryCache-æºç æ€»è§ˆ" class="headerlink" title="YYMemoryCache æºç æ€»è§ˆ"></a>YYMemoryCache æºç æ€»è§ˆ</h1><p><img src="https://cdn.jsdelivr.net/gh/yotrolz/image@master/blog/YYCache/YYMemoryCache.png" alt="YYMemoryCache API"></p><h1 id="YYMemoryCache-åˆå§‹åŒ–"><a href="#YYMemoryCache-åˆå§‹åŒ–" class="headerlink" title="YYMemoryCache åˆå§‹åŒ–"></a>YYMemoryCache åˆå§‹åŒ–</h1><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">YYMemoryCache</span> </span>&#123;</span><br><span class="line">    pthread_mutex_t _lock;</span><br><span class="line">    _YYLinkedMap *_lru;</span><br><span class="line">    <span class="built_in">dispatch_queue_t</span> _queue;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">instancetype</span>)init &#123;</span><br><span class="line">    <span class="keyword">self</span> = <span class="keyword">super</span>.init;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆå§‹åŒ–é”</span></span><br><span class="line">    pthread_mutex_init(&amp;_lock, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åŒå‘é“¾è¡¨ç»“æ„(ä¸‹æ–‡æ·±å…¥åˆ†æ)</span></span><br><span class="line">    _lru = [_YYLinkedMap new];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è‡ªå®šä¹‰çš„ä¸€ä¸ªä¸²è¡Œé˜Ÿåˆ—</span></span><br><span class="line">    _queue = dispatch_queue_create(<span class="string">&quot;com.ibireme.cache.memory&quot;</span>, DISPATCH_QUEUE_SERIAL);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ç¼“å­˜æé™å€¼</span></span><br><span class="line">    _countLimit = <span class="built_in">NSUIntegerMax</span>;</span><br><span class="line">    _costLimit = <span class="built_in">NSUIntegerMax</span>;</span><br><span class="line">    _ageLimit = DBL_MAX;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è‡ªåŠ¨æ£€æŸ¥æ—¶é—´é—´éš”ï¼›é»˜è®¤ï¼š5ç§’</span></span><br><span class="line">    <span class="comment">// ä¸€ä¸ªå†…éƒ¨è®¡æ—¶å™¨ï¼Œæ¥æ£€æŸ¥ç¼“å­˜æ˜¯å¦åˆ°è¾¾æé™ï¼Œå¦‚æœè¾¾åˆ°æé™ï¼Œå°±å¼€å§‹åˆ é™¤æ•°æ®</span></span><br><span class="line">    _autoTrimInterval = <span class="number">5.0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é…ç½®æ˜¯å¦åœ¨å†…å­˜è­¦å‘ŠåŠè¿›å…¥åå°æ—¶æ¸…é™¤æ•°æ®ï¼›é»˜è®¤ï¼šå¼€å¯</span></span><br><span class="line">    _shouldRemoveAllObjectsOnMemoryWarning = <span class="literal">YES</span>;</span><br><span class="line">    _shouldRemoveAllObjectsWhenEnteringBackground = <span class="literal">YES</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ç›‘å¬äº†å†…å­˜è­¦å‘ŠåŠè¿›å…¥åå°çš„ä¸¤ä¸ªé€šçŸ¥</span></span><br><span class="line">    [[<span class="built_in">NSNotificationCenter</span> defaultCenter] addObserver:<span class="keyword">self</span> selector:<span class="keyword">@selector</span>(_appDidReceiveMemoryWarningNotification) name:<span class="built_in">UIApplicationDidReceiveMemoryWarningNotification</span> object:<span class="literal">nil</span>];</span><br><span class="line">    [[<span class="built_in">NSNotificationCenter</span> defaultCenter] addObserver:<span class="keyword">self</span> selector:<span class="keyword">@selector</span>(_appDidEnterBackgroundNotification) name:<span class="built_in">UIApplicationDidEnterBackgroundNotification</span> object:<span class="literal">nil</span>];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// é€’å½’åˆ å‡æ•°æ®(å’Œä¸Šæ–‡çš„ _autoTrimInterval é…åˆä½¿ç”¨)</span></span><br><span class="line">    [<span class="keyword">self</span> _trimRecursively];</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="YYMemoryCache-å®šæ—¶æ¢æµ‹æœºåˆ¶"><a href="#YYMemoryCache-å®šæ—¶æ¢æµ‹æœºåˆ¶" class="headerlink" title="YYMemoryCache å®šæ—¶æ¢æµ‹æœºåˆ¶"></a>YYMemoryCache å®šæ—¶æ¢æµ‹æœºåˆ¶</h1><ul><li><code>YYMemoryCache</code> å†…éƒ¨æœ‰ä¸€ä¸ªå®šæ—¶ä»»åŠ¡ï¼Œç”¨æ¥æ£€æŸ¥ç¼“å­˜æ˜¯å¦åˆ°è¾¾æé™ï¼Œå¦‚æœè¾¾åˆ°æé™ï¼Œå°±å¼€å§‹åˆ é™¤æ•°æ®</li><li>åœ¨<code>YYMemoryCache</code>åˆå§‹åŒ–çš„æ—¶å€™ï¼Œåˆå§‹åŒ–äº† <code>_autoTrimInterval = 5.0;</code> å³ï¼šå®šæ—¶å‘¨æœŸé»˜è®¤ä¸º5ç§’ã€‚</li></ul><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// YYMemoryCache.m</span></span><br><span class="line">- (<span class="keyword">void</span>)_trimRecursively &#123;</span><br><span class="line">    __<span class="keyword">weak</span> <span class="keyword">typeof</span>(<span class="keyword">self</span>) _<span class="keyword">self</span> = <span class="keyword">self</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ğŸ””â—ï¸â—ï¸â—ï¸ ğŸ””â—ï¸â—ï¸â—ï¸</span></span><br><span class="line">    <span class="comment">// dispatch_after: 5ç§’åè°ƒç”¨</span></span><br><span class="line">    dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(_autoTrimInterval * <span class="built_in">NSEC_PER_SEC</span>)), dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_LOW, <span class="number">0</span>), ^&#123;</span><br><span class="line">        __<span class="keyword">strong</span> <span class="keyword">typeof</span>(_<span class="keyword">self</span>) <span class="keyword">self</span> = _<span class="keyword">self</span>;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">self</span>) <span class="keyword">return</span>;</span><br><span class="line">        [<span class="keyword">self</span> _trimInBackground]; <span class="comment">// åˆ å‡æ•°æ®çš„æ“ä½œ</span></span><br><span class="line">        [<span class="keyword">self</span> _trimRecursively];  <span class="comment">// é€’å½’è°ƒç”¨</span></span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ å‡æ•°æ®çš„æ“ä½œ</span></span><br><span class="line">- (<span class="keyword">void</span>)_trimInBackground &#123;</span><br><span class="line">    <span class="built_in">dispatch_async</span>(_queue, ^&#123;</span><br><span class="line">        [<span class="keyword">self</span> _trimToCost:<span class="keyword">self</span>-&gt;_costLimit];</span><br><span class="line">        [<span class="keyword">self</span> _trimToCount:<span class="keyword">self</span>-&gt;_countLimit];</span><br><span class="line">        [<span class="keyword">self</span> _trimToAge:<span class="keyword">self</span>-&gt;_ageLimit];</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>YYMemoryCache</code>å®šæ—¶æ¢æµ‹æœºåˆ¶ï¼š</p><ul><li>é»˜è®¤5ç§’ä¸€æ¬¡æ¢æµ‹ï¼›<code>_autoTrimInterval = 5.0;</code></li><li>ä½¿ç”¨<code>dispatch_after</code> + <code>é€’å½’è°ƒç”¨</code> å®ç°å®šæ—¶æ¢æµ‹ï¼›</li><li><code>dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_LOW, 0)</code>ï¼šä½ä¼˜å…ˆçº§çš„å…¨å±€é˜Ÿåˆ—</li></ul><h1 id="YYLinkedMap-amp-YYLinkedMapNode"><a href="#YYLinkedMap-amp-YYLinkedMapNode" class="headerlink" title="_YYLinkedMap &amp; _YYLinkedMapNode"></a>_YYLinkedMap &amp; _YYLinkedMapNode</h1><p><code>_YYLinkedMap</code> &amp; <code>_YYLinkedMapNode</code>ä¸ºå†…éƒ¨ç§æœ‰ç±»ï¼›</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">_YYLinkedMap</span> : <span class="title">NSObject</span> </span>&#123;</span><br><span class="line">    <span class="keyword">@package</span></span><br><span class="line">    <span class="built_in">CFMutableDictionaryRef</span> _dic; <span class="comment">// do not set object directly</span></span><br><span class="line">    <span class="built_in">NSUInteger</span> _totalCost;</span><br><span class="line">    <span class="built_in">NSUInteger</span> _totalCount;</span><br><span class="line">    _YYLinkedMapNode *_head; <span class="comment">// MRU, do not change it directly</span></span><br><span class="line">    _YYLinkedMapNode *_tail; <span class="comment">// LRU, do not change it directly</span></span><br><span class="line">    <span class="built_in">BOOL</span> _releaseOnMainThread;</span><br><span class="line">    <span class="built_in">BOOL</span> _releaseAsynchronously;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// åœ¨å¤´éƒ¨æ’å…¥ä¸€ä¸ªnodeï¼Œå¹¶æ›´æ–° total cost</span></span><br><span class="line">- (<span class="keyword">void</span>)insertNodeAtHead:(_YYLinkedMapNode *)node;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// å°†nodeç§»åŠ¨åˆ°å¤´éƒ¨(è¿™ä¸ªèŠ‚ç‚¹éœ€è¦å·²ç»å­˜åœ¨äºdicä¸­)</span></span><br><span class="line">- (<span class="keyword">void</span>)bringNodeToHead:(_YYLinkedMapNode *)node;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// ç§»é™¤ä¸€ä¸ªnode(è¿™ä¸ªèŠ‚ç‚¹éœ€è¦å·²ç»å­˜åœ¨äºdicä¸­)</span></span><br><span class="line">- (<span class="keyword">void</span>)removeNode:(_YYLinkedMapNode *)node;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// ç§»é™¤å°¾éƒ¨node(å¦‚æœå­˜åœ¨çš„è¯)</span></span><br><span class="line">- (_YYLinkedMapNode *)removeTailNode;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// ç§»é™¤å…¨éƒ¨nodeï¼Œå¹¶ä¸”åœ¨åå°é˜Ÿåˆ—</span></span><br><span class="line">- (<span class="keyword">void</span>)removeAll;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">_YYLinkedMapNode</span> : <span class="title">NSObject</span> </span>&#123;</span><br><span class="line">    <span class="keyword">@package</span></span><br><span class="line">    __<span class="keyword">unsafe_unretained</span> _YYLinkedMapNode *_prev; <span class="comment">// retained by dic</span></span><br><span class="line">    __<span class="keyword">unsafe_unretained</span> _YYLinkedMapNode *_next; <span class="comment">// retained by dic</span></span><br><span class="line">    <span class="keyword">id</span> _key;</span><br><span class="line">    <span class="keyword">id</span> _value;</span><br><span class="line">    <span class="built_in">NSUInteger</span> _cost;</span><br><span class="line">    <span class="built_in">NSTimeInterval</span> _time;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure><ul><li>ç”±äº <code>_YYLinkedMapNode</code>å¯¹è±¡å·²ç»å­˜åœ¨äº<code>_dic</code>å†…ï¼Œä¸”è¢«<code>retain</code> ,<code>_YYLinkedMapNode</code>å¯¹è±¡å†…éƒ¨çš„<code>_prev</code> å’Œ <code>_next</code> ä½¿ç”¨çš„æ˜¯<code>__unsafe_unretained</code>;</li></ul><p><img src="https://cdn.jsdelivr.net/gh/yotrolz/image@master/blog/YYCache/YYLinkedMap.jpg" alt="_YYLinkedMapNode"></p><h1 id="YYMemoryCache-LRU"><a href="#YYMemoryCache-LRU" class="headerlink" title="YYMemoryCache LRU"></a>YYMemoryCache LRU</h1><p>ä»ä»¥ä¸‹<code>å››ä¸ª</code>APIæ¥è®²è§£ <code>YYMemoryCache</code> <code>LRU</code>;</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)trimToCount:(<span class="built_in">NSUInteger</span>)count;  <span class="comment">// YYMemoryCache</span></span><br><span class="line"></span><br><span class="line">- (_YYLinkedMapNode *)removeTailNode;   <span class="comment">// _YYLinkedMap</span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">nullable</span> <span class="keyword">id</span>)objectForKey:(<span class="keyword">id</span>)key;    <span class="comment">// YYMemoryCache</span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)bringNodeToHead:(_YYLinkedMapNode *)node; <span class="comment">// _YYLinkedMap</span></span><br></pre></td></tr></table></figure><h2 id="trimToCount"><a href="#trimToCount" class="headerlink" title="trimToCount"></a>trimToCount</h2><ul><li>å†…éƒ¨ä¼šè°ƒç”¨<code>removeTailNode</code>, ä¸‹æ–‡åˆ†æ</li></ul><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// YYMemoryCache.m</span></span><br><span class="line">- (<span class="keyword">void</span>)trimToCount:(<span class="built_in">NSUInteger</span>)count &#123;</span><br><span class="line">    <span class="keyword">if</span> (count == <span class="number">0</span>) &#123;</span><br><span class="line">        [<span class="keyword">self</span> removeAllObjects];</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    [<span class="keyword">self</span> _trimToCount:count];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// YYMemoryCache.m</span></span><br><span class="line">- (<span class="keyword">void</span>)_trimToCount:(<span class="built_in">NSUInteger</span>)countLimit &#123;</span><br><span class="line">    <span class="built_in">BOOL</span> finish = <span class="literal">NO</span>;</span><br><span class="line">    pthread_mutex_lock(&amp;_lock);</span><br><span class="line">    <span class="keyword">if</span> (countLimit == <span class="number">0</span>) &#123;</span><br><span class="line">        [_lru removeAll];</span><br><span class="line">        finish = <span class="literal">YES</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (_lru-&gt;_totalCount &lt;= countLimit) &#123;</span><br><span class="line">        finish = <span class="literal">YES</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    pthread_mutex_unlock(&amp;_lock);</span><br><span class="line">    <span class="keyword">if</span> (finish) <span class="keyword">return</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSMutableArray</span> *holder = [<span class="built_in">NSMutableArray</span> new];</span><br><span class="line">    <span class="keyword">while</span> (!finish) &#123;</span><br><span class="line">        <span class="keyword">if</span> (pthread_mutex_trylock(&amp;_lock) == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// å¦‚æœå½“å‰å­˜å‚¨çš„ count è¶…æ ‡ å°±ç§»é™¤å°¾éƒ¨èŠ‚ç‚¹ï¼Œ ç›´åˆ°ç¬¦åˆè¦æ±‚</span></span><br><span class="line">            <span class="keyword">if</span> (_lru-&gt;_totalCount &gt; countLimit) &#123;</span><br><span class="line">                <span class="comment">// ğŸ””â—ï¸â—ï¸â—ï¸ ğŸ””â—ï¸â—ï¸â—ï¸</span></span><br><span class="line">                _YYLinkedMapNode *node = [_lru removeTailNode];</span><br><span class="line">                <span class="keyword">if</span> (node) [holder addObject:node];</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                finish = <span class="literal">YES</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            pthread_mutex_unlock(&amp;_lock);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            usleep(<span class="number">10</span> * <span class="number">1000</span>); <span class="comment">//10 ms</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (holder.count) &#123;</span><br><span class="line">        <span class="built_in">dispatch_queue_t</span> queue = _lru-&gt;_releaseOnMainThread ? dispatch_get_main_queue() : YYMemoryCacheGetReleaseQueue();</span><br><span class="line">        <span class="built_in">dispatch_async</span>(queue, ^&#123;</span><br><span class="line">            [holder count]; <span class="comment">// release in queue</span></span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å¼‚æ­¥é‡Šæ”¾å¯¹è±¡"><a href="#å¼‚æ­¥é‡Šæ”¾å¯¹è±¡" class="headerlink" title="å¼‚æ­¥é‡Šæ”¾å¯¹è±¡"></a>å¼‚æ­¥é‡Šæ”¾å¯¹è±¡</h3><blockquote><p><code>YYMemoryCacheGetReleaseQueue()</code></p></blockquote><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="built_in">dispatch_queue_t</span> YYMemoryCacheGetReleaseQueue() &#123;</span><br><span class="line">    <span class="keyword">return</span> dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_LOW, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>ä½¿ç”¨äº†ä¸€ä¸ª<code>ä½ä¼˜å…ˆçº§(DISPATCH_QUEUE_PRIORITY_LOW)</code> çš„ <code>å…¨å±€å¹¶å‘é˜Ÿåˆ—</code>;</li><li>ä½¿ç”¨ <code>static</code> <code>inline</code> å…³é”®å­—å·²æé«˜æ‰§è¡Œæ•ˆç‡ï¼›</li></ul><blockquote><p>static inline é™æ€å†…è”å‡½æ•°</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">é€šè¿‡å£°æ˜ä¸€ä¸ªå†…è”å‡½æ•°ï¼Œå¯ä»¥æŒ‡ç¤ºGCCæ›´å¿«åœ°è°ƒç”¨è¯¥å‡½æ•°ã€‚</span><br><span class="line">GCCå¯ä»¥åšåˆ°è¿™ä¸€ç‚¹çš„ä¸€ç§æ–¹æ³•æ˜¯å°†è¯¥å‡½æ•°çš„ä»£ç é›†æˆåˆ°å…¶è°ƒç”¨è€…çš„ä»£ç ä¸­ã€‚</span><br><span class="line">è¿™æ ·å¯ä»¥æ¶ˆé™¤å‡½æ•°è°ƒç”¨çš„å¼€é”€ï¼Œä»è€ŒåŠ å¿«æ‰§è¡Œé€Ÿåº¦ã€‚</span><br><span class="line">æ­¤å¤–ï¼Œå¦‚æœä»»ä½•å®é™…å‚æ•°å€¼æ˜¯æ’å®šçš„ï¼Œåˆ™å®ƒä»¬çš„å·²çŸ¥å€¼å¯èƒ½ä¼šåœ¨ç¼–è¯‘æ—¶è¿›è¡Œç®€åŒ–ï¼Œå› æ­¤ä¸å¿…åŒ…æ‹¬æ‰€æœ‰å†…è”å‡½æ•°çš„ä»£ç ã€‚</span><br><span class="line">å¯¹ä»£ç å¤§å°çš„å½±å“éš¾ä»¥é¢„æµ‹ã€‚æ ¹æ®å…·ä½“æƒ…å†µï¼Œä½¿ç”¨å‡½æ•°å†…è”å¯ä»¥ä½¿ç›®æ ‡ä»£ç æ›´å¤§æˆ–æ›´å°ã€‚</span><br></pre></td></tr></table></figure><p><em>å¼•ç”¨è‡ªï¼š<a target="_blank" rel="noopener" href="https://gcc.gnu.org/onlinedocs/gcc/Inline.html">An Inline Function is As Fast As a Macro</a></em></p><blockquote><p>åœ¨<code>iOS ä¿æŒç•Œé¢æµç•…çš„æŠ€å·§</code>æ–‡ç« ä¸­ä½œè€…æåˆ°:</p></blockquote><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">å¯¹è±¡çš„é”€æ¯è™½ç„¶æ¶ˆè€—èµ„æºä¸å¤šï¼Œä½†ç´¯ç§¯èµ·æ¥ä¹Ÿæ˜¯ä¸å®¹å¿½è§†çš„ã€‚</span></span><br><span class="line"><span class="comment">é€šå¸¸å½“å®¹å™¨ç±»æŒæœ‰å¤§é‡å¯¹è±¡æ—¶ï¼Œå…¶é”€æ¯æ—¶çš„èµ„æºæ¶ˆè€—å°±éå¸¸æ˜æ˜¾ã€‚</span></span><br><span class="line"><span class="comment">åŒæ ·çš„ï¼Œå¦‚æœå¯¹è±¡å¯ä»¥æ”¾åˆ°åå°çº¿ç¨‹å»é‡Šæ”¾ï¼Œé‚£å°±æŒªåˆ°åå°çº¿ç¨‹å»ã€‚</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">è¿™é‡Œæœ‰ä¸ªå° Tipï¼š</span></span><br><span class="line"><span class="comment">æŠŠå¯¹è±¡æ•è·åˆ° block ä¸­ï¼Œç„¶åæ‰”åˆ°åå°é˜Ÿåˆ—å»éšä¾¿å‘é€ä¸ªæ¶ˆæ¯ä»¥é¿å…ç¼–è¯‘å™¨è­¦å‘Š</span></span><br><span class="line"><span class="comment">å°±å¯ä»¥è®©å¯¹è±¡åœ¨åå°çº¿ç¨‹é”€æ¯äº†ã€‚</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">NSArray</span> *tmp = <span class="keyword">self</span>.array;</span><br><span class="line"><span class="keyword">self</span>.array = <span class="literal">nil</span>;</span><br><span class="line"><span class="built_in">dispatch_async</span>(queue, ^&#123;</span><br><span class="line">    [tmp <span class="keyword">class</span>];</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h2 id="removeTailNode"><a href="#removeTailNode" class="headerlink" title="removeTailNode"></a>removeTailNode</h2><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// YYMemoryCache.m</span></span><br><span class="line">- (_YYLinkedMapNode *)removeTailNode &#123;</span><br><span class="line">    <span class="keyword">if</span> (!_tail) <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è·å– _tail å°¾éƒ¨èŠ‚ç‚¹</span></span><br><span class="line">    _YYLinkedMapNode *tail = _tail;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ä»CFDictionaryä¸­ç§»é™¤</span></span><br><span class="line">    <span class="built_in">CFDictionaryRemoveValue</span>(_dic, (__bridge <span class="keyword">const</span> <span class="keyword">void</span> *)(_tail-&gt;_key));</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ›´æ–°å®¹é‡ç­‰ä¿¡æ¯</span></span><br><span class="line">    _totalCost -= _tail-&gt;_cost;</span><br><span class="line">    _totalCount--;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é‡æ–°è®¡ç®— _tail å°¾éƒ¨èŠ‚ç‚¹ </span></span><br><span class="line">    <span class="keyword">if</span> (_head == _tail) &#123;</span><br><span class="line">        _head = _tail = <span class="literal">nil</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        _tail = _tail-&gt;_prev;</span><br><span class="line">        _tail-&gt;_next = <span class="literal">nil</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å°† _tail å°¾éƒ¨èŠ‚ç‚¹è¿”å›(æ›´æ–°å‰çš„_tail)</span></span><br><span class="line">    <span class="keyword">return</span> tail;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="objectForKey"><a href="#objectForKey" class="headerlink" title="objectForKey"></a>objectForKey</h2><ul><li>å†…éƒ¨ä¼šè°ƒç”¨<code>bringNodeToHead</code>, ä¸‹æ–‡åˆ†æ</li></ul><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// YYMemoryCache.m</span></span><br><span class="line">- (<span class="keyword">id</span>)objectForKey:(<span class="keyword">id</span>)key &#123;</span><br><span class="line">    <span class="keyword">if</span> (!key) <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é”ï¼šä¿è¯çº¿ç¨‹å®‰å…¨</span></span><br><span class="line">    pthread_mutex_lock(&amp;_lock);</span><br><span class="line">    _YYLinkedMapNode *node = <span class="built_in">CFDictionaryGetValue</span>(_lru-&gt;_dic, (__bridge <span class="keyword">const</span> <span class="keyword">void</span> *)(key));</span><br><span class="line">    <span class="keyword">if</span> (node) &#123;</span><br><span class="line">        <span class="comment">// æ›´æ–° _time</span></span><br><span class="line">        node-&gt;_time = <span class="built_in">CACurrentMediaTime</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ğŸ””â—ï¸â—ï¸â—ï¸ ğŸ””â—ï¸â—ï¸â—ï¸</span></span><br><span class="line">        <span class="comment">// å°†èŠ‚ç‚¹ç§»åŠ¨åˆ°å¤´éƒ¨</span></span><br><span class="line">        [_lru bringNodeToHead:node];</span><br><span class="line">    &#125;</span><br><span class="line">    pthread_mutex_unlock(&amp;_lock);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å°†æ•°æ®è¿”å›</span></span><br><span class="line">    <span class="keyword">return</span> node ? node-&gt;_value : <span class="literal">nil</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="bringNodeToHead"><a href="#bringNodeToHead" class="headerlink" title="bringNodeToHead"></a>bringNodeToHead</h2><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// YYMemoryCache.m</span></span><br><span class="line">- (<span class="keyword">void</span>)bringNodeToHead:(_YYLinkedMapNode *)node &#123;</span><br><span class="line">    <span class="keyword">if</span> (_head == node) <span class="keyword">return</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (_tail == node) &#123;</span><br><span class="line">        _tail = node-&gt;_prev;</span><br><span class="line">        _tail-&gt;_next = <span class="literal">nil</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        node-&gt;_next-&gt;_prev = node-&gt;_prev;</span><br><span class="line">        node-&gt;_prev-&gt;_next = node-&gt;_next;</span><br><span class="line">    &#125;</span><br><span class="line">    node-&gt;_next = _head;</span><br><span class="line">    node-&gt;_prev = <span class="literal">nil</span>;</span><br><span class="line">    _head-&gt;_prev = node;</span><br><span class="line">    _head = node;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="YYMemoryCacheè¯»å–æ“ä½œæ—¶é—´å¤æ‚åº¦O-1"><a href="#YYMemoryCacheè¯»å–æ“ä½œæ—¶é—´å¤æ‚åº¦O-1" class="headerlink" title="YYMemoryCacheè¯»å–æ“ä½œæ—¶é—´å¤æ‚åº¦O(1)"></a>YYMemoryCacheè¯»å–æ“ä½œæ—¶é—´å¤æ‚åº¦O(1)</h1><p>åœ¨å®˜æ–¹çš„æ–‡æ¡£ä¸­ï¼Œæˆ‘ä»¬å¾—çŸ¥ <code>YYMemoryCache</code> è¯»å–æ“ä½œç›¸å…³apiçš„æ—¶é—´å¤æ‚åº¦ä¸º <code>O(1)</code>,é‚£ä¹ˆæ˜¯å¦‚ä½•åšåˆ°çš„å‘¢ï¼Ÿ</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">_YYLinkedMap</span> : <span class="title">NSObject</span> </span>&#123;</span><br><span class="line">    <span class="keyword">@package</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ğŸ””â—ï¸â—ï¸â—ï¸ ğŸ””â—ï¸â—ï¸â—ï¸</span></span><br><span class="line">    <span class="built_in">CFMutableDictionaryRef</span> _dic; <span class="comment">// do not set object directly</span></span><br><span class="line">    <span class="built_in">NSUInteger</span> _totalCost;</span><br><span class="line">    <span class="built_in">NSUInteger</span> _totalCount;</span><br><span class="line">    _YYLinkedMapNode *_head; <span class="comment">// MRU, do not change it directly</span></span><br><span class="line">    _YYLinkedMapNode *_tail; <span class="comment">// LRU, do not change it directly</span></span><br><span class="line">    <span class="built_in">BOOL</span> _releaseOnMainThread;</span><br><span class="line">    <span class="built_in">BOOL</span> _releaseAsynchronously;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶å®å°±æ˜¯è¿™ä¸ª <code>CFMutableDictionaryRef</code> ç±»å‹çš„ <code>_dic</code>;<br><code>CFMutableDictionaryRef</code> æœ¬è´¨æ˜¯ä¸€ä¸ª <code>å“ˆå¸Œç»“æ„</code>;</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">id</span>)objectForKey:(<span class="keyword">id</span>)key &#123;</span><br><span class="line">    <span class="keyword">if</span> (!key) <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    pthread_mutex_lock(&amp;_lock);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ğŸ””â—ï¸â—ï¸â—ï¸ ğŸ””â—ï¸â—ï¸â—ï¸</span></span><br><span class="line">    <span class="comment">// ç›´æ¥ä» CFMutableDictionaryRef ä¸­å–å‡ºæ•°æ®</span></span><br><span class="line">    _YYLinkedMapNode *node = <span class="built_in">CFDictionaryGetValue</span>(_lru-&gt;_dic, (__bridge <span class="keyword">const</span> <span class="keyword">void</span> *)(key));</span><br><span class="line">    <span class="keyword">if</span> (node) &#123;</span><br><span class="line">        node-&gt;_time = <span class="built_in">CACurrentMediaTime</span>();</span><br><span class="line">        [_lru bringNodeToHead:node];</span><br><span class="line">    &#125;</span><br><span class="line">    pthread_mutex_unlock(&amp;_lock);</span><br><span class="line">    <span class="keyword">return</span> node ? node-&gt;_value : <span class="literal">nil</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><div class="post-copyright"><p class="copyright-item"> <span>Author:</span> <a href="http://yotrolz.com">YotrolZ</a></p><p class="copyright-item"> <span>Link:</span> <a href="http://yotrolz.com/posts/ac25c853/">http://yotrolz.com/posts/ac25c853/</a></p><p class="copyright-item"> <span>License:</span> <a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/" target="_blank">çŸ¥è¯†å…±äº«ç½²å-éå•†ä¸šæ€§ä½¿ç”¨ 4.0 å›½é™…è®¸å¯åè®®</a></p></div><footer class="post-footer"><nav class="post-nav"><a class="prev" href="/posts/cad520f4/"><i class="iconfont icon-left"></i> <span class="prev-text nav-default">iOS @synchronized(object)åº•å±‚åŸç†</span> <span class="prev-text nav-mobile">Prev</span></a> <a class="next" href="/posts/5c5f8fb2/"><span class="next-text nav-default">YYCacheæºç å­¦ä¹ -ç£ç›˜ç¼“å­˜åˆ†æ</span> <span class="prev-text nav-mobile">Next</span><i class="iconfont icon-right"></i></a></nav></footer></article></div><div class="comments" id="comments"></div></div></main><footer id="footer" class="footer"><div class="social-links"></div><div class="copyright"> <span class="power-by">Powered by <a class="hexo-link" target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a></span> <span class="division">|</span> <span class="theme-info">Theme - <a class="theme-link" target="_blank" rel="noopener" href="https://github.com/ahonn/hexo-theme-even">Even</a></span> <span class="copyright-year">&copy;2015 - 2022<span class="heart"><i class="iconfont icon-heart"></i></span> <span class="author">YotrolZ</span></span></div></footer><div class="back-to-top" id="back-to-top"><i class="iconfont icon-up"></i></div></div><script type="text/javascript" src="https://cdn.jsdelivr.net/gh/yotrolz/yotrolz.github.io@gh/lib/jquery/jquery.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/gh/yotrolz/yotrolz.github.io@gh/lib/slideout/slideout.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/gh/yotrolz/yotrolz.github.io@gh/lib/fancybox/jquery.fancybox.pack.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/gh/yotrolz/yotrolz.github.io@gh/js/src/even.js?v=2.11.0"></script></body></html>