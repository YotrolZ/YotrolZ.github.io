<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="theme-color" content="#f8f5ec"><meta name="msapplication-navbutton-color" content="#f8f5ec"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec"><meta name="description" content="YYDiskCache æ˜¯ä¸€ä¸ª`çº¿ç¨‹å®‰å…¨`çš„ï¼Œç”¨äºå­˜å‚¨ç”±`SQLite`æ”¯æŒçš„é”®å€¼å¯¹å’Œ`æ–‡ä»¶ç³»ç»Ÿ`ï¼ˆç±»ä¼¼äº `NSURLCache` çš„ç£ç›˜ç¼“å­˜ï¼‰ã€‚é‡‡ç”¨LRUæ¥ç§»é™¤æ•°æ®ï¼›ä¸åŒæ•°æ®è‡ªåŠ¨é‡‡ç”¨ä¸åŒçš„å­˜å‚¨æœºåˆ¶ï¼š`sqlite` æˆ– `file`ï¼›æ”¯æŒ`åŒæ­¥`ä¸`å¼‚æ­¥`çš„æ–¹å¼è°ƒç”¨ç­‰ç‰¹æ€§ã€‚"><link rel="alternate" href="/atom.xml" title="YotrolZ" type="application/atom+xml"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=2.11.0"><link rel="canonical" href="http://yotrolz.com/posts/5c5f8fb2/"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/yotrolz/yotrolz.github.io@gh/lib/fancybox/jquery.fancybox.css"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/yotrolz/yotrolz.github.io@gh/css/style.css?v=2.11.0"><script async src="https://www.googletagmanager.com/gtag/js?id=UA-138610487-3"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-138610487-3")</script><script id="baidu_push">!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}()</script><script src="//cdn.jsdelivr.net/npm/leancloud-storage@4.10.0/dist/av-min.js"></script><script id="leancloud">AV.init({appId:"mqfPQEKBtui9puAJUkYFY7Jn-MdYXbMMI",appKey:"A6R0T4bEvcBsTU8pB7NhJ6Wl"})</script><script>window.config={leancloud:{show_visits:!1,app_id:"mqfPQEKBtui9puAJUkYFY7Jn-MdYXbMMI",app_key:"A6R0T4bEvcBsTU8pB7NhJ6Wl"},toc:!0,fancybox:!0,pjax:"",latex:!1}</script><title>YYCacheæºç å­¦ä¹ -ç£ç›˜ç¼“å­˜åˆ†æ - YotrolZ</title><meta name="generator" content="Hexo 5.4.1"></head><body><div id="mobile-navbar" class="mobile-navbar"><div class="mobile-header-logo"> <a href="/." class="logo">YotrolZ</a></div><div class="mobile-navbar-icon"><span></span><span></span><span></span></div></div><nav id="mobile-menu" class="mobile-menu slideout-menu"><ul class="mobile-menu-list"><a href="/"><li class="mobile-menu-item">Home</li></a><a href="/archives/"><li class="mobile-menu-item">Archives</li></a><a href="/tags/"><li class="mobile-menu-item">Tags</li></a><a href="/categories/"><li class="mobile-menu-item">Categories</li></a></ul></nav><div class="container" id="mobile-panel"><header id="header" class="header"><div class="logo-wrapper"> <a href="/." class="logo">YotrolZ</a></div><nav class="site-navbar"><ul id="menu" class="menu"><li class="menu-item"> <a class="menu-item-link" href="/">Home</a></li><li class="menu-item"> <a class="menu-item-link" href="/archives/">Archives</a></li><li class="menu-item"> <a class="menu-item-link" href="/tags/">Tags</a></li><li class="menu-item"> <a class="menu-item-link" href="/categories/">Categories</a></li></ul></nav></header><main id="main" class="main"><div class="content-wrapper"><div id="content" class="content"><article class="post"><header class="post-header"><h1 class="post-title">YYCacheæºç å­¦ä¹ -ç£ç›˜ç¼“å­˜åˆ†æ</h1><div class="post-meta"> <span class="post-time">2019-10-22</span> <span class="post-visits" style="display:none" data-url="/posts/5c5f8fb2/" data-title="YYCacheæºç å­¦ä¹ -ç£ç›˜ç¼“å­˜åˆ†æ">Visits 0</span></div></header><div class="post-toc" id="post-toc"><h2 class="post-toc-title">Contents</h2><div class="post-toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#YYDiskCache-%E7%AE%80%E4%BB%8B"><span class="toc-text">YYDiskCache ç®€ä»‹</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#YYDiskCache-%E6%BA%90%E7%A0%81%E6%80%BB%E8%A7%88"><span class="toc-text">YYDiskCache æºç æ€»è§ˆ</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#YYDiskCache-%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-text">YYDiskCache åˆå§‹åŒ–</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%8E%E7%BC%93%E5%AD%98%E4%B8%AD%E8%8E%B7%E5%8F%96YYDiskCache%E5%AF%B9%E8%B1%A1"><span class="toc-text">ä»ç¼“å­˜ä¸­è·å–YYDiskCacheå¯¹è±¡</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#YYDiskCacheInitGlobal"><span class="toc-text">_YYDiskCacheInitGlobal</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#YYDiskCacheGetGlobal"><span class="toc-text">_YYDiskCacheGetGlobal</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#YYDiskCacheSetGlobal"><span class="toc-text">_YYDiskCacheSetGlobal</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%9C%9F%E6%AD%A3%E7%9A%84%E5%88%9B%E5%BB%BAYYDiskCache%E5%AF%B9%E8%B1%A1"><span class="toc-text">çœŸæ­£çš„åˆ›å»ºYYDiskCacheå¯¹è±¡</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#YYDiskCache-%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8"><span class="toc-text">YYDiskCache çº¿ç¨‹å®‰å…¨</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#YYDiskCache-%E5%AD%98%E5%82%A8%E6%93%8D%E4%BD%9C"><span class="toc-text">YYDiskCache å­˜å‚¨æ“ä½œ</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AD%98%E5%82%A8%E6%9C%BA%E5%88%B6%EF%BC%9Ainline-data-file"><span class="toc-text">å­˜å‚¨æœºåˆ¶ï¼šinline_data &#x2F; file</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SQLite-DB-%E6%93%8D%E4%BD%9C"><span class="toc-text">SQLite DB æ“ä½œ</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#sqlite3-stmt"><span class="toc-text">sqlite3_stmt</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%93%E5%AD%98-SQL-%E6%93%8D%E4%BD%9C"><span class="toc-text">ç¼“å­˜ SQL æ“ä½œ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#sqlite3-WAL"><span class="toc-text">sqlite3 WAL</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#YYDiskCache-LRU"><span class="toc-text">YYDiskCache LRU</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#get-%E6%93%8D%E4%BD%9C%EF%BC%9A"><span class="toc-text">get æ“ä½œï¼š</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#trim-%E6%93%8D%E4%BD%9C"><span class="toc-text">trim æ“ä½œ</span></a></li></ol></li></ol></div></div><div class="post-content"><p>åœ¨<a href="https://yotrolz.com/posts/ba9af90f/">ä¸Šä¸€ç¯‡æ–‡ç« </a>ä¸­ï¼Œæˆ‘ä»¬å¯¹<code>YYCache</code>çš„åˆå§‹åŒ–æ“ä½œäº†åšäº†ç®€å•åˆ†æï¼Œå…·ä½“ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// YYCache.m</span></span><br><span class="line">- (<span class="keyword">instancetype</span>)initWithPath:(<span class="built_in">NSString</span> *)path &#123;</span><br><span class="line">    <span class="keyword">if</span> (path.length == <span class="number">0</span>) <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// â‘  åˆå§‹åŒ–ç£ç›˜ç¼“å­˜</span></span><br><span class="line">    YYDiskCache *diskCache = [[YYDiskCache alloc] initWithPath:path];</span><br><span class="line">    <span class="keyword">if</span> (!diskCache) <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    <span class="built_in">NSString</span> *name = [path lastPathComponent];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// â‘¡ åˆå§‹åŒ–å†…å­˜ç¼“å­˜</span></span><br><span class="line">    YYMemoryCache *memoryCache = [YYMemoryCache new];</span><br><span class="line">    memoryCache.name = name;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// â‘¢ åˆå§‹åŒ–æœ¬èº«å¹¶å¯¹å†…éƒ¨çš„ä¸‰ä¸ªåªè¯»å±æ€§è¿›è¡Œèµ‹å€¼</span></span><br><span class="line">    <span class="keyword">self</span> = [<span class="keyword">super</span> init];</span><br><span class="line">    _name = name;</span><br><span class="line">    _diskCache = diskCache;</span><br><span class="line">    _memoryCache = memoryCache;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>æœ¬ç¯‡æ–‡ç« æˆ‘ä»¬ä»‹ç»ä¸€ä¸‹ <code>YYDiskCache</code> ç£ç›˜ç¼“å­˜çš„å®ç°</p></blockquote><h1 id="YYDiskCache-ç®€ä»‹"><a href="#YYDiskCache-ç®€ä»‹" class="headerlink" title="YYDiskCache ç®€ä»‹"></a>YYDiskCache ç®€ä»‹</h1><p>å…ˆæ¥çœ‹ä¸€ä¸‹å®˜æ–¹ä»‹ç»(å¯åœ¨æºç ä¸­æŸ¥é˜…):</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">`YYDiskCache` æ˜¯ä¸€ä¸ª`çº¿ç¨‹å®‰å…¨`çš„ï¼Œç”¨äºå­˜å‚¨ç”±`SQLite`æ”¯æŒçš„é”®å€¼å¯¹å’Œ`æ–‡ä»¶ç³»ç»Ÿ`ï¼ˆç±»ä¼¼äº `NSURLCache` çš„ç£ç›˜ç¼“å­˜ï¼‰</span><br><span class="line"></span><br><span class="line">- ä½¿ç”¨`LRU(least-recently-used)`æ¥ç§»é™¤å¯¹è±¡ï¼›</span><br><span class="line">- å¯ä»¥é€šè¿‡ `cost`ï¼Œ`count` å’Œ `age` æ¥æ§åˆ¶ï¼›</span><br><span class="line">- å¯ä»¥é…ç½®ä¸ºå½“`æ²¡æœ‰ç©ºé—²ç£ç›˜ç©ºé—´`æ—¶`è‡ªåŠ¨åˆ é™¤å¯¹è±¡`ï¼›</span><br><span class="line">- å¯ä»¥`è‡ªåŠ¨å†³å®š`æ¯ä¸ªå¯¹è±¡çš„`å­˜å‚¨ç±»å‹(sqlite/file)`ï¼Œä»¥è·å¾—æ›´å¥½çš„æ€§èƒ½ï¼›</span><br><span class="line"></span><br><span class="line">åœ¨iOSç³»ç»Ÿä¸Šå¯ä»¥ç›´æ¥ä»å®˜ç½‘ä¸‹è½½æœ€æ–°çš„ `SQLite` æºç ç¼–è¯‘ç¼–è¯‘å¹¶å¿½ç•¥ç³»ç»Ÿçš„`libsqlite3.dylib`å¯ä»¥è·å¾—`2x~4x`çš„é€Ÿåº¦ã€‚</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å¯¹ä¸Šé¢çš„ä¿¡æ¯è¿›è¡Œæç‚¼ä¸€ä¸‹å…³é”®ä¿¡æ¯ï¼š</p><ul><li>â‘  çº¿ç¨‹å®‰å…¨ï¼›</li><li>â‘¡ é‡‡ç”¨<code>LRU</code>ç§»é™¤å¯¹è±¡ï¼›</li><li>â‘¢ å¤šç»´åº¦çš„æ§åˆ¶: <code>cost</code>ï¼Œ<code>count</code> å’Œ <code>age</code> ï¼›</li><li>â‘£ ä¸åŒæ•°æ®è‡ªåŠ¨é‡‡ç”¨ä¸åŒçš„å­˜å‚¨æœºåˆ¶ï¼š<code>sqlite</code> æˆ– <code>file</code>ï¼›</li><li>â‘¤ ç£ç›˜ä¸è¶³æ—¶å¯è‡ªåŠ¨åˆ é™¤ï¼›</li><li>â‘¥ æ”¯æŒ<code>åŒæ­¥</code>ä¸<code>å¼‚æ­¥</code>çš„æ–¹å¼è°ƒç”¨(æºç APIå±‚é¢)ï¼›</li></ul><blockquote><p>åœ¨æåˆ°<code>YYCache</code>çš„<code>LRU</code>æ—¶ï¼Œç½‘ä¸Šå¤§éƒ¨åˆ†çš„æ–‡ç« éƒ½æ˜¯å†è°ˆ<code>åŒé“¾è¡¨ + hashè¡¨</code>ï¼Œè¯¥ç»“æ„åªæ˜¯<code>YYCache</code>å†…å­˜ç¼“å­˜(<code>YYMemoryCache</code>) æ‰€é‡‡ç”¨çš„<code>LRU</code>æ–¹æ¡ˆï¼Œæˆ‘ä»¬éœ€è¦çŸ¥é“ï¼šYYCache çš„ç£ç›˜ç¼“å­˜(<code>YYDiskCache</code>)ä¹Ÿæ˜¯æ”¯æŒ<code>LRU</code>çš„;</p></blockquote><h1 id="YYDiskCache-æºç æ€»è§ˆ"><a href="#YYDiskCache-æºç æ€»è§ˆ" class="headerlink" title="YYDiskCache æºç æ€»è§ˆ"></a>YYDiskCache æºç æ€»è§ˆ</h1><h1 id="YYDiskCache-åˆå§‹åŒ–"><a href="#YYDiskCache-åˆå§‹åŒ–" class="headerlink" title="YYDiskCache åˆå§‹åŒ–"></a>YYDiskCache åˆå§‹åŒ–</h1><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">YYDiskCache</span> : <span class="title">NSObject</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Cache name</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nullable</span>, <span class="keyword">copy</span>) <span class="built_in">NSString</span> *name;</span><br><span class="line"><span class="comment">// Cache path</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">readonly</span>) <span class="built_in">NSString</span> *path;</span><br><span class="line"><span class="comment">// ç£ç›˜ç¼“å­˜æ–¹å¼çš„ä¸€ä¸ªé˜ˆå€¼ï¼Œé»˜è®¤æ˜¯20480å­—èŠ‚(20KB)</span></span><br><span class="line"><span class="comment">// ğŸ””â—ï¸â—ï¸â—ï¸å¦‚æœè¦å­˜å‚¨çš„æ•°æ®å¤§å°(ä»¥å­—èŠ‚ä¸ºå•ä½)å¤§äºè¯¥é˜ˆå€¼ï¼Œåˆ™å°†å…¶å­˜å‚¨ä¸ºæ–‡ä»¶ï¼Œå¦åˆ™å°†å…¶å­˜å‚¨åœ¨sqliteä¸­</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">readonly</span>) <span class="built_in">NSUInteger</span> inlineThreshold;</span><br><span class="line"></span><br><span class="line">Â·Â·Â·Â·Â·Â·</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆå§‹åŒ– (NS_DESIGNATED_INITIALIZER)</span></span><br><span class="line">- (<span class="keyword">nullable</span> <span class="keyword">instancetype</span>)initWithPath:(<span class="built_in">NSString</span> *)path</span><br><span class="line">                      inlineThreshold:(<span class="built_in">NSUInteger</span>)threshold <span class="built_in">NS_DESIGNATED_INITIALIZER</span>;</span><br><span class="line"></span><br><span class="line">Â·Â·Â·Â·Â·Â·</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure><p>åˆå§‹åŒ–<code>YYCache</code>æ—¶è°ƒç”¨äº† <code>YYDiskCache</code> çš„ <code>initWithPath</code> æ–¹æ³•</p><ul><li><p>è¿™é‡Œä¸»è¦æ˜¯å¯¹ <code>inlineThreshold</code> é˜ˆå€¼è¿›è¡Œäº†åˆå§‹åŒ–(20KB)</p></li><li><p>è‡³äºä¸ºä½•æ˜¯<code>20KB</code>ï¼Œæˆ‘ä»¬å¯ä»¥å‚çœ‹<a target="_blank" rel="noopener" href="https://blog.ibireme.com/2015/10/26/yycache/">YYCache è®¾è®¡æ€è·¯</a> å’Œ <a target="_blank" rel="noopener" href="https://www.sqlite.org/intern-v-extern-blob.html">SQLiteå®˜æ–¹è¯´æ˜</a></p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">instancetype</span>)initWithPath:(<span class="built_in">NSString</span> *)path &#123;</span><br><span class="line">  <span class="keyword">return</span> [<span class="keyword">self</span> initWithPath:path inlineThreshold:<span class="number">1024</span> * <span class="number">20</span>]; <span class="comment">// 20KB</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>çœŸæ­£çš„åˆå§‹åŒ–æ–¹æ³•<code>NS_DESIGNATED_INITIALIZER</code></p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">instancetype</span>)initWithPath:(<span class="built_in">NSString</span> *)path</span><br><span class="line">            inlineThreshold:(<span class="built_in">NSUInteger</span>)threshold &#123;</span><br><span class="line">    <span class="keyword">self</span> = [<span class="keyword">super</span> init];</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">self</span>) <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// â‘  æ ¹æ®pathåˆ©ç”¨_YYDiskCacheGetGlobalè·å–YYDiskCacheå¯¹è±¡</span></span><br><span class="line">    YYDiskCache *globalCache = _YYDiskCacheGetGlobal(path);</span><br><span class="line">    <span class="comment">// å­˜åœ¨çš„è¯ç›´æ¥è¿”å›ï¼Œä¸éœ€åˆ›å»º</span></span><br><span class="line">    <span class="keyword">if</span> (globalCache) <span class="keyword">return</span> globalCache;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// â‘¡ çœŸæ­£çš„åˆå§‹åŒ–æ“ä½œ</span></span><br><span class="line">    Â·Â·Â·Â·Â·Â· <span class="comment">// ä¸‹æ–‡åˆ†æ</span></span><br><span class="line">    </span><br><span class="line">    [[<span class="built_in">NSNotificationCenter</span> defaultCenter] addObserver:<span class="keyword">self</span> selector:<span class="keyword">@selector</span>(_appWillBeTerminated) name:<span class="built_in">UIApplicationWillTerminateNotification</span> object:<span class="literal">nil</span>];</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><h2 id="ä»ç¼“å­˜ä¸­è·å–YYDiskCacheå¯¹è±¡"><a href="#ä»ç¼“å­˜ä¸­è·å–YYDiskCacheå¯¹è±¡" class="headerlink" title="ä»ç¼“å­˜ä¸­è·å–YYDiskCacheå¯¹è±¡"></a>ä»ç¼“å­˜ä¸­è·å–YYDiskCacheå¯¹è±¡</h2><p>åœ¨ä¸Šæ–‡ä¸­æˆ‘ä»¬å¾—çŸ¥ï¼Œ<code>YYDiskCache</code>åœ¨åˆå§‹åŒ–çš„æ—¶å€™ï¼Œé¦–å…ˆä¼šæ ¹æ®<code>path</code> è°ƒç”¨ <code>_YYDiskCacheGetGlobal</code>æ¥è¿›è¡ŒæŸ¥æ‰¾ï¼Œå¦‚æœæŸ¥åˆ°ï¼Œå°±ç›´æ¥è¿”å›ï¼Œå¦‚æœæ²¡æœ‰æ‰¾åˆ°å°±æ‰§è¡Œä¸€ç³»åˆ—çš„åˆå§‹åŒ–æ“ä½œï¼Œç„¶ååˆè°ƒç”¨ <code>_YYDiskCacheSetGlobal</code> å°†åˆ›å»ºå¥½çš„<code>YYDiskCache</code> å¯¹è±¡å­˜å…¥ï¼Œç°åœ¨æˆ‘ä»¬æ¥åˆ†æä¸€ä¸‹ <code>_YYDiskCacheGetGlobal</code> å’Œ <code>_YYDiskCacheSetGlobal</code>ï¼›</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// weak reference for all instances</span></span><br><span class="line"><span class="type">static</span> NSMapTable *_globalInstances;</span><br><span class="line"><span class="type">static</span> <span class="type">dispatch_semaphore_t</span> _globalInstancesLock;</span><br></pre></td></tr></table></figure><ul><li>å®šä¹‰äº†ä¸€ä¸ªå…¨å±€çš„ <code>NSMapTable</code> ç±»å‹çš„ <code>_globalInstances</code> å’Œ ä¸€ä¸ª <code>dispatch_semaphore_t</code> ç±»å‹çš„ <code>_globalInstancesLock</code>;</li><li><code>_globalInstances</code>ï¼šå­˜æ”¾æ‰€æœ‰çš„ <code>YYDiskCache</code> å¯¹è±¡</li><li><code>dispatch_semaphore_t</code>ï¼šç”¨æ¥ä¿è¯è¯»å†™<code>YYDiskCache</code>å¯¹è±¡çš„<code>çº¿ç¨‹å®‰å…¨</code></li></ul><h3 id="YYDiskCacheInitGlobal"><a href="#YYDiskCacheInitGlobal" class="headerlink" title="_YYDiskCacheInitGlobal"></a>_YYDiskCacheInitGlobal</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> _YYDiskCacheInitGlobal() &#123;</span><br><span class="line">    <span class="type">static</span> <span class="type">dispatch_once_t</span> onceToken;</span><br><span class="line">    <span class="built_in">dispatch_once</span>(&amp;onceToken, ^&#123;</span><br><span class="line">        _globalInstancesLock = <span class="built_in">dispatch_semaphore_create</span>(<span class="number">1</span>);</span><br><span class="line">        _globalInstances = [[NSMapTable alloc] initWithKeyOptions:NSPointerFunctionsStrongMemory valueOptions:NSPointerFunctionsWeakMemory capacity:<span class="number">0</span>];</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>ä½¿ç”¨<code>dispatch_once</code>ä¿è¯åªåˆå§‹åŒ–ä¸€æ¬¡ï¼›</li><li>ğŸ””â—ï¸â—ï¸â—ï¸ <code>_globalInstances</code> ç”¨æ¥å­˜æ”¾æ‰€æœ‰çš„ <code>YYDiskCache</code>å¯¹è±¡ï¼Œ ä½¿ç”¨ <code>NSMapTable</code> + <code>NSPointerFunctionsWeakMemory</code>ï¼Œ <code>å¼±å¼•ç”¨</code> å†…éƒ¨çš„ <code>YYDiskCache</code>å¯¹è±¡ï¼›</li><li>ğŸ””â—ï¸â—ï¸â—ï¸ <code>_globalInstancesLock</code> ç”¨æ¥ä¿è¯è¯»å–<code>YYDiskCache</code>å¯¹è±¡çš„çº¿ç¨‹å®‰å…¨ï¼›</li></ul><h3 id="YYDiskCacheGetGlobal"><a href="#YYDiskCacheGetGlobal" class="headerlink" title="_YYDiskCacheGetGlobal"></a>_YYDiskCacheGetGlobal</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> YYDiskCache *_YYDiskCacheGetGlobal(NSString *path) &#123;</span><br><span class="line">    <span class="keyword">if</span> (path.length == <span class="number">0</span>) <span class="keyword">return</span> nil;</span><br><span class="line">    _YYDiskCacheInitGlobal();</span><br><span class="line">    <span class="built_in">dispatch_semaphore_wait</span>(_globalInstancesLock, DISPATCH_TIME_FOREVER);</span><br><span class="line">    id cache = [_globalInstances objectForKey:path];</span><br><span class="line">    <span class="built_in">dispatch_semaphore_signal</span>(_globalInstancesLock);</span><br><span class="line">    <span class="keyword">return</span> cache;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="YYDiskCacheSetGlobal"><a href="#YYDiskCacheSetGlobal" class="headerlink" title="_YYDiskCacheSetGlobal"></a>_YYDiskCacheSetGlobal</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> _YYDiskCacheSetGlobal(YYDiskCache *cache) &#123;</span><br><span class="line">    <span class="keyword">if</span> (cache.path.length == <span class="number">0</span>) <span class="keyword">return</span>;</span><br><span class="line">    _YYDiskCacheInitGlobal();</span><br><span class="line">    <span class="built_in">dispatch_semaphore_wait</span>(_globalInstancesLock, DISPATCH_TIME_FOREVER);</span><br><span class="line">    [_globalInstances setObject:cache forKey:cache.path];</span><br><span class="line">    <span class="built_in">dispatch_semaphore_signal</span>(_globalInstancesLock);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>åœ¨è°ƒç”¨<code>_YYDiskCacheGetGlobal</code> æˆ– <code>_YYDiskCacheSetGlobal</code> æ—¶ä¼šè°ƒç”¨<code>_YYDiskCacheInitGlobal</code> è¿›è¡Œåˆå§‹åŒ–ï¼›</li><li>ç”±äº<code>_YYDiskCacheInitGlobal</code>å†…éƒ¨ä½¿ç”¨<code>dispatch_once</code>ï¼Œå¯ä¿è¯åªåˆå§‹åŒ–äº†ä¸€æ¬¡ï¼›</li></ul><blockquote><p>dispatch_semaphore_t çº¿ç¨‹åŒæ­¥æ–¹æ¡ˆ</p></blockquote><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// creatï¼šåˆå§‹åŒ–ï¼Œä¿¡å·é‡åˆå§‹å€¼ 1</span></span><br><span class="line">_globalInstancesLock = dispatch_semaphore_create(<span class="number">1</span>);</span><br><span class="line"><span class="comment">// waitï¼šå¯¹ä¿¡å·é‡æ•°å€¼å‡1ï¼Œå¦‚æœç»“æœå€¼`å°äº0`ï¼Œåˆ™è¯¥å‡½æ•°å¤„äºç­‰å¾…çŠ¶æ€ï¼Œ ç›´åˆ°è¶…æ—¶æˆ–ç­‰å¾…ä¸€ä¸ª`å”¤é†’ä¿¡å·`ã€‚</span></span><br><span class="line">dispatch_semaphore_wait(_globalInstancesLock, DISPATCH_TIME_FOREVER);</span><br><span class="line"><span class="comment">// signalï¼šå¯¹ä¿¡å·é‡æ•°å€¼åŠ 1ã€‚å¦‚æœ`å‰ä¸€ä¸ªå€¼å°äº0`ï¼Œè¿™ä¸ªå‡½æ•°åœ¨è¿”å›ä¹‹å‰`å”¤é†’`ä¸€ä¸ªç­‰å¾…çš„çº¿ç¨‹(ä¸»è¦æ˜¯é’ˆå¯¹ä¸Šé¢çš„wait)ã€‚</span></span><br><span class="line">dispatch_semaphore_signal(_globalInstancesLock);</span><br></pre></td></tr></table></figure><h2 id="çœŸæ­£çš„åˆ›å»ºYYDiskCacheå¯¹è±¡"><a href="#çœŸæ­£çš„åˆ›å»ºYYDiskCacheå¯¹è±¡" class="headerlink" title="çœŸæ­£çš„åˆ›å»ºYYDiskCacheå¯¹è±¡"></a>çœŸæ­£çš„åˆ›å»ºYYDiskCacheå¯¹è±¡</h2><ul><li>æ ¹æ®<code>path</code> å’Œå­˜å‚¨æ–¹å¼ <code>YYKVStorageType</code> åˆå§‹åŒ– <code>YYKVStorage</code>ï¼›</li><li>åˆå§‹åŒ–äº†ä¸€ä¸ª <code>dispatch_semaphore</code> ä¿¡å·é‡ï¼›</li><li>åˆå§‹åŒ–äº†ä¸€ä¸ª <code>dispatch_queue</code> è‡ªå®šä¹‰çš„<code>å¹¶å‘é˜Ÿåˆ—</code>ï¼›</li><li>åˆå§‹åŒ–ä¸€äº›é¢å¤–çš„æ§åˆ¶å±æ€§ï¼›</li><li>å°†ä¸Šè¿°åˆå§‹åŒ–å¥½çš„æ•°æ®æŒ‚è½½åˆ° <code>YYDiskCache</code> å¯¹è±¡ä¸Šï¼Œå¹¶å­˜å…¥å…¨å±€çš„ <code>_globalInstances</code> ä¸­ï¼›</li></ul><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">instancetype</span>)initWithPath:(<span class="built_in">NSString</span> *)path</span><br><span class="line">            inlineThreshold:(<span class="built_in">NSUInteger</span>)threshold &#123;</span><br><span class="line">    <span class="keyword">self</span> = [<span class="keyword">super</span> init];</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">self</span>) <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// â‘  æ ¹æ®pathåˆ©ç”¨_YYDiskCacheGetGlobalè·å–YYDiskCacheå¯¹è±¡</span></span><br><span class="line">    YYDiskCache *globalCache = _YYDiskCacheGetGlobal(path);</span><br><span class="line">    <span class="comment">// å­˜åœ¨çš„è¯ç›´æ¥è¿”å›ï¼Œä¸éœ€åˆ›å»º</span></span><br><span class="line">    <span class="keyword">if</span> (globalCache) <span class="keyword">return</span> globalCache;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// â‘¡ YYDiskCache çœŸæ­£çš„åˆå§‹åŒ–æ“ä½œ</span></span><br><span class="line">    YYKVStorageType type;</span><br><span class="line">    <span class="keyword">if</span> (threshold == <span class="number">0</span>) &#123;</span><br><span class="line">        type = YYKVStorageTypeFile;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (threshold == <span class="built_in">NSUIntegerMax</span>) &#123;</span><br><span class="line">        type = YYKVStorageTypeSQLite;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        type = YYKVStorageTypeMixed;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// çœŸæ­£å®ç°æ•°æ®å­˜å–çš„å¯¹è±¡</span></span><br><span class="line">    YYKVStorage *kv = [[YYKVStorage alloc] initWithPath:path type:type];</span><br><span class="line">    <span class="keyword">if</span> (!kv) <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    </span><br><span class="line">    _kv = kv;</span><br><span class="line">    _path = path;</span><br><span class="line">    <span class="comment">// ä½¿ç”¨GCD ä¿¡å·é‡ åˆ›å»ºäº†ä¸€æŠŠé”ï¼Œä¿è¯çº¿ç¨‹å®‰å…¨</span></span><br><span class="line">    _lock = dispatch_semaphore_create(<span class="number">1</span>);</span><br><span class="line">    <span class="comment">// åˆ›å»ºäº†ä¸€ä¸ªè‡ªå®šä¹‰çš„å¹¶å‘é˜Ÿåˆ—</span></span><br><span class="line">    _queue = dispatch_queue_create(<span class="string">&quot;com.ibireme.cache.disk&quot;</span>, DISPATCH_QUEUE_CONCURRENT);</span><br><span class="line">    _inlineThreshold = threshold;</span><br><span class="line">    _countLimit = <span class="built_in">NSUIntegerMax</span>;</span><br><span class="line">    _costLimit = <span class="built_in">NSUIntegerMax</span>;</span><br><span class="line">    _ageLimit = DBL_MAX;</span><br><span class="line">    _freeDiskSpaceLimit = <span class="number">0</span>;</span><br><span class="line">    _autoTrimInterval = <span class="number">60</span>;</span><br><span class="line">    </span><br><span class="line">    [<span class="keyword">self</span> _trimRecursively];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// â‘¢ å­˜å…¥ï¼š_YYDiskCacheSetGlobal</span></span><br><span class="line">    _YYDiskCacheSetGlobal(<span class="keyword">self</span>);</span><br><span class="line">    </span><br><span class="line">    [[<span class="built_in">NSNotificationCenter</span> defaultCenter] addObserver:<span class="keyword">self</span> selector:<span class="keyword">@selector</span>(_appWillBeTerminated) name:<span class="built_in">UIApplicationWillTerminateNotification</span> object:<span class="literal">nil</span>];</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="YYDiskCache-çº¿ç¨‹å®‰å…¨"><a href="#YYDiskCache-çº¿ç¨‹å®‰å…¨" class="headerlink" title="YYDiskCache çº¿ç¨‹å®‰å…¨"></a>YYDiskCache çº¿ç¨‹å®‰å…¨</h1><p>åœ¨ä¸Šæ–‡ <code>YYDiskCache</code> åˆå§‹åŒ–çš„æ—¶å€™ï¼Œåˆ›å»ºäº†ä¸€ä¸ª <code>dispatch_semaphore</code> ä¿¡å·é‡ï¼›æˆ‘ä»¬ä»APIæ¥åˆ†æ <code>YYDiskCache</code> çš„çº¿ç¨‹å®‰å…¨ï¼›</p><blockquote><p>ä»¥ <code>- (void)removeObjectForKey:(NSString *)key</code> ä¸ºä¾‹:</p></blockquote><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// self-&gt;_lockï¼šåˆå§‹åŒ– YYDiskCache æ—¶ï¼Œåˆ›å»ºçš„ dispatch_semaphore</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> Lock()   dispatch_semaphore_wait(self-&gt;_lock, DISPATCH_TIME_FOREVER)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> Unlock() dispatch_semaphore_signal(self-&gt;_lock)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// åŒæ­¥åˆ é™¤æ–¹å¼</span></span><br><span class="line">- (<span class="keyword">void</span>)removeObjectForKey:(<span class="built_in">NSString</span> *)key &#123;</span><br><span class="line">    <span class="keyword">if</span> (!key) <span class="keyword">return</span>;</span><br><span class="line">    Lock();</span><br><span class="line">    [_kv removeItemForKey:key]; <span class="comment">// çº¿ç¨‹å®‰å…¨</span></span><br><span class="line">    Unlock();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// å¼‚æ­¥åˆ é™¤æ–¹å¼</span></span><br><span class="line">- (<span class="keyword">void</span>)removeObjectForKey:(<span class="built_in">NSString</span> *)key withBlock:(<span class="keyword">void</span>(^)(<span class="built_in">NSString</span> *key))block &#123;</span><br><span class="line">    __<span class="keyword">weak</span> <span class="keyword">typeof</span>(<span class="keyword">self</span>) _<span class="keyword">self</span> = <span class="keyword">self</span>;</span><br><span class="line">    <span class="comment">// _queueï¼šåˆå§‹åŒ– YYDiskCache æ—¶ï¼Œåˆ›å»ºçš„å¹¶å‘é˜Ÿåˆ—</span></span><br><span class="line">    <span class="built_in">dispatch_async</span>(_queue, ^&#123;</span><br><span class="line">        __<span class="keyword">strong</span> <span class="keyword">typeof</span>(_<span class="keyword">self</span>) <span class="keyword">self</span> = _<span class="keyword">self</span>;</span><br><span class="line">        [<span class="keyword">self</span> removeObjectForKey:key];</span><br><span class="line">        <span class="keyword">if</span> (block) block(key);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>å¯ä»¥çœ‹å‡ºçœŸæ­£åœ¨æ“ä½œæ•°æ®çš„å…¶å®æ˜¯<code>[_kv removeItemForKey:key];</code></li><li><code>_kv</code> å°±æ˜¯åœ¨åˆå§‹åŒ– <code>YYDiskCache</code> æ—¶ï¼Œåˆ›å»ºçš„ <code>YYKVStorage</code> å¯¹è±¡;</li></ul><blockquote><p>åˆå§‹åŒ– <code>YYDiskCache</code> æ—¶ï¼Œåˆ›å»ºçš„ <code>dispatch_semaphore</code> å’Œ <code>dispatch_queue</code> ä½œç”¨:</p></blockquote><ul><li><code>dispatch_semaphore</code> ç”¨æ¥ä¿è¯<code>æ“ä½œç¼“å­˜æ•°æ®</code>æ—¶çš„<code>çº¿ç¨‹å®‰å…¨</code>ï¼›</li><li>å¹¶å‘çš„<code>dispatch_queue</code> ç”¨æ¥å®ç°<code>æ“ä½œç¼“å­˜æ•°æ®</code>æ—¶çš„<code>åŒæ­¥</code>è¿˜æ˜¯<code>å¼‚æ­¥</code>æ–¹å¼ï¼›</li></ul><p>æˆ‘ä»¬åªæ˜¯ä»¥<code>åˆ é™¤æ“ä½œ</code>ä¸ºä¾‹è¿›è¡Œäº†è¯´æ˜ï¼šåˆ«çš„<code>æ“ä½œ</code>ç±»ä¼¼ï¼›</p><h1 id="YYDiskCache-å­˜å‚¨æ“ä½œ"><a href="#YYDiskCache-å­˜å‚¨æ“ä½œ" class="headerlink" title="YYDiskCache å­˜å‚¨æ“ä½œ"></a>YYDiskCache å­˜å‚¨æ“ä½œ</h1><blockquote><p>ä»¥ <code>- (void)setObject:(id&lt;NSCoding&gt;)object forKey:(NSString *)key;</code> ä¸ºä¾‹:</p></blockquote><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// YYDiskCache.m</span></span><br><span class="line">- (<span class="keyword">void</span>)setObject:(<span class="keyword">id</span>&lt;<span class="built_in">NSCoding</span>&gt;)object forKey:(<span class="built_in">NSString</span> *)key &#123;</span><br><span class="line">    <span class="keyword">if</span> (!key) <span class="keyword">return</span>;</span><br><span class="line">    <span class="comment">// å¦‚æœ object ä¸º nil å°±æ‰§è¡Œåˆ é™¤æ“ä½œ</span></span><br><span class="line">    <span class="keyword">if</span> (!object) &#123;</span><br><span class="line">        [<span class="keyword">self</span> removeObjectForKey:key];</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// extendedData: å…¶å®ä¹Ÿå°±æ˜¯ object çš„ä¸€ä¸ªé™„åŠ æ•°æ®ï¼›</span></span><br><span class="line">    <span class="comment">// åœ¨ä¿å­˜ object ä¹‹å‰ï¼Œå¦‚æœç»™objectè®¾ç½®äº†è¿™ä¸ªé™„åŠ æ•°æ®ï¼ŒYYDiskCache ä¹Ÿä¼šä¸€å¹¶å­˜å‚¨ï¼›</span></span><br><span class="line">    <span class="comment">// è·å– object ç»‘å®šçš„ extendedData æ•°æ®</span></span><br><span class="line">    <span class="built_in">NSData</span> *extendedData = [YYDiskCache getExtendedDataFromObject:object];</span><br><span class="line">    <span class="comment">// object å¯¹åº”çš„ NSData æ•°æ®</span></span><br><span class="line">    <span class="comment">// å¯ä»¥è‡ªå®šä¹‰å½’æ¡£æ–¹å¼ æˆ– ä½¿ç”¨é»˜è®¤çš„ NSKeyedArchiver</span></span><br><span class="line">    <span class="built_in">NSData</span> *value = <span class="literal">nil</span>;</span><br><span class="line">    <span class="keyword">if</span> (_customArchiveBlock) &#123;</span><br><span class="line">        value = _customArchiveBlock(object);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">@try</span> &#123;</span><br><span class="line">            value = [<span class="built_in">NSKeyedArchiver</span> archivedDataWithRootObject:object];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">@catch</span> (<span class="built_in">NSException</span> *exception) &#123;</span><br><span class="line">            <span class="comment">// nothing to do...</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!value) <span class="keyword">return</span>;</span><br><span class="line">    <span class="built_in">NSString</span> *filename = <span class="literal">nil</span>;</span><br><span class="line">    <span class="keyword">if</span> (_kv.type != YYKVStorageTypeSQLite) &#123;</span><br><span class="line">        <span class="comment">// ğŸ””â—ï¸â—ï¸â—ï¸</span></span><br><span class="line">        <span class="comment">// å¦‚æœæ²¡æœ‰æ˜ç¡®æ ‡æ˜å­˜å‚¨æ–¹å¼ä¸º SQLite è‡ªåŠ¨è¿›è¡Œä¸åŒæ–¹å¼çš„å­˜å‚¨æœºåˆ¶ SQLite / File</span></span><br><span class="line">        <span class="comment">// æ ¹æ®å­˜å‚¨æ•°æ®çš„å­—èŠ‚æ•°åŠé˜ˆå€¼è¿›è¡ŒåŒºåˆ†</span></span><br><span class="line">        <span class="keyword">if</span> (value.length &gt; _inlineThreshold) &#123;</span><br><span class="line">            <span class="comment">// å­˜å‚¨æ•°æ®çš„å¤§å°è¶…è¿‡äº†é˜ˆå€¼ è·å–ä¸€ä¸ª filename ç”¨äºå­˜å‚¨æ–‡ä»¶æ—¶ä½¿ç”¨</span></span><br><span class="line">            <span class="comment">// filenameçš„ç”Ÿæˆè§„åˆ™ï¼Œé»˜è®¤ï¼šMD5(key)ï¼›ä¹Ÿå¯ä»¥é€šè¿‡ `customFileNameBlock(key)` è‡ªå®šä¹‰</span></span><br><span class="line">            filename = [<span class="keyword">self</span> _filenameForKey:key];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// åŠ è§£é”æ“ä½œï¼Œä¿è¯æ•°æ®è®¿é—®æ—¶çš„çº¿ç¨‹å®‰å…¨</span></span><br><span class="line">    Lock();</span><br><span class="line">    <span class="comment">// æ­£çœŸçš„å­˜å‚¨æ“ä½œ</span></span><br><span class="line">    [_kv saveItemWithKey:key value:value filename:filename extendedData:extendedData];</span><br><span class="line">    Unlock();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>æœ‰ä¸Šè¿°å¾—çŸ¥ï¼š<code>æ•°æ®é‡è¶…è¿‡é˜ˆå€¼</code>åï¼Œä¼šç”Ÿæˆä¸€ä¸ª <code>filename</code>ï¼Œæˆ‘ä»¬æ¥ç€åˆ†æï¼›</li></ul><h2 id="å­˜å‚¨æœºåˆ¶ï¼šinline-data-file"><a href="#å­˜å‚¨æœºåˆ¶ï¼šinline-data-file" class="headerlink" title="å­˜å‚¨æœºåˆ¶ï¼šinline_data / file"></a>å­˜å‚¨æœºåˆ¶ï¼šinline_data / file</h2><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// YYKVStorage.m</span></span><br><span class="line">- (<span class="built_in">BOOL</span>)saveItemWithKey:(<span class="built_in">NSString</span> *)key value:(<span class="built_in">NSData</span> *)value filename:(<span class="built_in">NSString</span> *)filename extendedData:(<span class="built_in">NSData</span> *)extendedData &#123;</span><br><span class="line">    <span class="keyword">if</span> (key.length == <span class="number">0</span> || value.length == <span class="number">0</span>) <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">    <span class="keyword">if</span> (_type == YYKVStorageTypeFile &amp;&amp; filename.length == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ğŸ””â—ï¸â—ï¸â—ï¸ ğŸ””â—ï¸â—ï¸â—ï¸</span></span><br><span class="line">    <span class="keyword">if</span> (filename.length) &#123;</span><br><span class="line">    <span class="comment">// â‘  è‹¥filenameå­˜åœ¨(æ•°æ®é‡è¶…è¿‡äº†é˜ˆå€¼) --&gt; é‡‡ç”¨`File`çš„æ–¹å¼</span></span><br><span class="line">        <span class="comment">// â‘ -â‘  å†™å…¥ æ–‡ä»¶ çš„æ“ä½œ</span></span><br><span class="line">        <span class="keyword">if</span> (![<span class="keyword">self</span> _fileWriteWithName:filename data:value]) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// â‘ -â‘¡ å†™å…¥ SQLite çš„æ“ä½œ</span></span><br><span class="line">        <span class="keyword">if</span> (![<span class="keyword">self</span> _dbSaveWithKey:key value:value fileName:filename extendedData:extendedData]) &#123;</span><br><span class="line">            <span class="comment">// æ“ä½œå¤±è´¥åè¦å°†â‘ -â‘ ä¸­å†™å…¥çš„æ–‡ä»¶åˆ é™¤</span></span><br><span class="line">            [<span class="keyword">self</span> _fileDeleteWithName:filename];</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// â‘¡ è‹¥filenameä¸å­˜åœ¨(æ•°æ®é‡å°äºé˜ˆå€¼) --&gt; é‡‡ç”¨`inline_data`çš„æ–¹å¼</span></span><br><span class="line">        <span class="keyword">if</span> (_type != YYKVStorageTypeSQLite) &#123;</span><br><span class="line">            <span class="built_in">NSString</span> *filename = [<span class="keyword">self</span> _dbGetFilenameWithKey:key];</span><br><span class="line">            <span class="keyword">if</span> (filename) &#123;</span><br><span class="line">                [<span class="keyword">self</span> _fileDeleteWithName:filename];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// â‘¡-â‘  å†™å…¥ SQLite çš„æ“ä½œ</span></span><br><span class="line">        <span class="keyword">return</span> [<span class="keyword">self</span> _dbSaveWithKey:key value:value fileName:<span class="literal">nil</span> extendedData:extendedData];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>ğŸ””â—ï¸â—ï¸â—ï¸ä¸ç®¡æ•°æ®é‡è¶…æ²¡è¶…è¿‡é˜ˆå€¼ï¼Œéƒ½ä¼šåœ¨ <code>SQLite</code> ä¸­å†™å…¥ä¸€æ¡æ•°æ®çš„</p></blockquote><ul><li>è¶…è¿‡é˜ˆå€¼ï¼š<code>SQLite</code> + <code>File</code>ï¼›(ä¸å°†<code>data</code>æ•°æ®å†™å…¥<code>SQLite</code>)</li><li>æ²¡è¶…è¿‡é˜ˆå€¼ï¼š<code>SQLite</code> + <code>inline_data</code>ï¼›</li><li>æé«˜å­˜å‚¨æ•ˆç‡ï¼›</li></ul><p>æˆ‘ä»¬çœ‹ä¸€ä¸‹å…·ä½“æºç å®ç°ï¼š</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// YYKVStorage.m (ç§æœ‰æ–¹æ³•)</span></span><br><span class="line">- (<span class="built_in">BOOL</span>)_dbSaveWithKey:(<span class="built_in">NSString</span> *)key value:(<span class="built_in">NSData</span> *)value fileName:(<span class="built_in">NSString</span> *)fileName extendedData:(<span class="built_in">NSData</span> *)extendedData &#123;</span><br><span class="line">    <span class="built_in">NSString</span> *sql = <span class="string">@&quot;insert or replace into manifest (key, filename, size, inline_data, modification_time, last_access_time, extended_data) values (?1, ?2, ?3, ?4, ?5, ?6, ?7);&quot;</span>;</span><br><span class="line"></span><br><span class="line">    ğŸ””â—ï¸â—ï¸â—ï¸ğŸ””â—ï¸â—ï¸â—ï¸ğŸ””â—ï¸â—ï¸â—ï¸ <span class="comment">// ä¸‹æ–‡åˆ†æ</span></span><br><span class="line">    sqlite3_stmt *stmt = [<span class="keyword">self</span> _dbPrepareStmt:sql];</span><br><span class="line">    <span class="keyword">if</span> (!stmt) <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">int</span> timestamp = (<span class="keyword">int</span>)time(<span class="literal">NULL</span>);</span><br><span class="line">    sqlite3_bind_text(stmt, <span class="number">1</span>, key.UTF8String, <span class="number">-1</span>, <span class="literal">NULL</span>);</span><br><span class="line">    sqlite3_bind_text(stmt, <span class="number">2</span>, fileName.UTF8String, <span class="number">-1</span>, <span class="literal">NULL</span>);</span><br><span class="line">    sqlite3_bind_int(stmt, <span class="number">3</span>, (<span class="keyword">int</span>)value.length);</span><br><span class="line">    ğŸ””â—ï¸â—ï¸â—ï¸ğŸ””â—ï¸â—ï¸â—ï¸ğŸ””â—ï¸â—ï¸â—ï¸</span><br><span class="line">    <span class="comment">// fileName å­˜åœ¨æ—¶ï¼Œä¿å­˜çš„æ•°æ®å…¶å®æ˜¯ NULL</span></span><br><span class="line">    <span class="keyword">if</span> (fileName.length == <span class="number">0</span>) &#123;</span><br><span class="line">        sqlite3_bind_blob(stmt, <span class="number">4</span>, value.bytes, (<span class="keyword">int</span>)value.length, <span class="number">0</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        sqlite3_bind_blob(stmt, <span class="number">4</span>, <span class="literal">NULL</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    sqlite3_bind_int(stmt, <span class="number">5</span>, timestamp);</span><br><span class="line">    sqlite3_bind_int(stmt, <span class="number">6</span>, timestamp);</span><br><span class="line">    sqlite3_bind_blob(stmt, <span class="number">7</span>, extendedData.bytes, (<span class="keyword">int</span>)extendedData.length, <span class="number">0</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">int</span> result = sqlite3_step(stmt);</span><br><span class="line">    <span class="keyword">if</span> (result != SQLITE_DONE) &#123;</span><br><span class="line">        <span class="keyword">if</span> (_errorLogsEnabled) <span class="built_in">NSLog</span>(<span class="string">@&quot;%s line:%d sqlite insert error (%d): %s&quot;</span>, __FUNCTION__, __LINE__, result, sqlite3_errmsg(_db));</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="SQLite-DB-æ“ä½œ"><a href="#SQLite-DB-æ“ä½œ" class="headerlink" title="SQLite DB æ“ä½œ"></a>SQLite DB æ“ä½œ</h2><p>çœ‹åˆ°è¿™é‡Œï¼Œå¤§å®¶å¯èƒ½ä¼šæƒ³ï¼Œ<code>SQLite DB</code>æ“ä½œæ— éå°±æ˜¯å†™å‡ è¡Œ<code>SQL</code> è·‘ä¸€ä¸‹è€Œå·²ï¼Œæœ‰ä»€ä¹ˆå¯è¯´çš„ã€‚ç„¶è€Œå¹¶éå¦‚æ­¤ï¼Œ<code>YYCache</code> åŒæ ·åšäº†å¾ˆå¤š<code>æé«˜æ€§èƒ½</code>çš„äº‹æƒ…!</p><h3 id="sqlite3-stmt"><a href="#sqlite3-stmt" class="headerlink" title="sqlite3_stmt"></a>sqlite3_stmt</h3><p>å¤§å®¶éƒ½çŸ¥é“<code>sqlite3</code> æœ‰ä¸€ä¸ª æ‰§è¡Œçš„ <code>SQL</code> è¯­å¥çš„å‡½æ•°<code>sqlite3_exec</code>:</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">SQLITE_API <span class="type">int</span> <span class="title">sqlite3_exec</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  sqlite3*,                                  <span class="comment">/* An open database */</span></span></span></span><br><span class="line"><span class="params"><span class="function">  <span class="type">const</span> <span class="type">char</span> *sql,                           <span class="comment">/* SQL to be evaluated */</span></span></span></span><br><span class="line"><span class="params"><span class="function">  <span class="type">int</span> (*callback)(<span class="type">void</span>*,<span class="type">int</span>,<span class="type">char</span>**,<span class="type">char</span>**),  <span class="comment">/* Callback function */</span></span></span></span><br><span class="line"><span class="params"><span class="function">  <span class="type">void</span> *,                                    <span class="comment">/* 1st argument to callback */</span></span></span></span><br><span class="line"><span class="params"><span class="function">  <span class="type">char</span> **errmsg                              <span class="comment">/* Error msg written here */</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure><p>å…¶å®å‘¢ï¼š<code>SQL</code>è¯­å¥å¯ä»¥ç†è§£ä¸ºä¸€ç§<code>ç¼–ç¨‹è¯­è¨€</code>çš„<code>æºä»£ç </code>ï¼Œè€Œæƒ³è¦æ‰§è¡Œè¿™ä¸ª<code>æºä»£ç </code>å°±å¿…é¡»è¦è¿›è¡Œ<code>ç¼–è¯‘/è§£æ</code>ï¼Œè€Œ<code>sqlite3_stmt</code>æ˜¯ä¸€ä¸ª<code>é¢„ç¼–è¯‘è¯­å¥å¯¹è±¡</code>, è¯¥å¯¹è±¡çš„ä¸€ä¸ª<code>å®ä¾‹</code>è¡¨ç¤ºä¸€æ¡<code>SQL</code>è¯­å¥ï¼Œå¹¶ä¸”<code>å·²ç»è¢«ç¼–è¯‘æˆäºŒè¿›åˆ¶</code>å½¢å¼ï¼Œå¯ä»¥<code>ç›´æ¥è¿è¡Œ</code>ï¼›</p><p><code>sqlite3_stmt</code> çš„ä½¿ç”¨æµç¨‹ï¼š</p><ul><li>â‘  ä½¿ç”¨<code>sqlite3_prepare_v2()</code>åˆ›å»ºé¢„å¤„ç†è¯­å¥å¯¹è±¡ï¼›</li><li>â‘¡ ä½¿ç”¨<code>sqlite3_bind()</code>å°†å€¼ç»‘å®šåˆ°<code>SQL</code>ä¸Šï¼›</li><li>â‘¢ é€šè¿‡è°ƒç”¨<code>sqlite3_step()</code>ä¸€æ¬¡æˆ–å¤šæ¬¡è¿è¡Œ<code>SQL</code>;</li><li>â‘£ ä½¿ç”¨<code>sqlite3_reset()</code>é‡ç½®å‡†å¤‡å¥½çš„è¯­å¥ï¼Œç„¶åè¿”å›åˆ°æ­¥éª¤2ã€‚è¿™æ ·åš0æ¬¡æˆ–æ›´å¤šæ¬¡ã€‚</li><li>â‘¤ ä½¿ç”¨<code>sqlite3_finalize()</code>é”€æ¯å¯¹è±¡ã€‚</li></ul><blockquote><p>YYCache åªæœ‰åœ¨åˆå§‹åŒ–DB(<code>- (BOOL)_dbInitialize;</code>)æ—¶ä½¿ç”¨äº†<code>sqlite3_exec</code>æ‰§è¡Œ<code>SQL</code>ï¼Œè€Œ<code>é‡å¤æ€§</code>çš„å¢åˆ æ”¹æŸ¥æ“ä½œéƒ½æ˜¯ä½¿ç”¨<code>sqlite3_stmt</code>æ¥æ‰§è¡Œ<code>SQL</code>;</p></blockquote><h3 id="ç¼“å­˜-SQL-æ“ä½œ"><a href="#ç¼“å­˜-SQL-æ“ä½œ" class="headerlink" title="ç¼“å­˜ SQL æ“ä½œ"></a>ç¼“å­˜ <code>SQL</code> æ“ä½œ</h3><p>æ¥ç€å›åˆ°æˆ‘ä»¬çš„æºç ï¼š</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ¥ä¸Šæ–‡</span></span><br><span class="line">sqlite3_stmt *stmt = [<span class="keyword">self</span> _dbPrepareStmt:sql];</span><br></pre></td></tr></table></figure><blockquote><p>é‡‡ç”¨ <code>CFMutableDictionaryRef</code> ç¼“å­˜ <code>sqlite3_stmt</code> å¯¹è±¡</p></blockquote><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// YYKVStorage.m (ç§æœ‰æ–¹æ³•)</span></span><br><span class="line">- (sqlite3_stmt *)_dbPrepareStmt:(<span class="built_in">NSString</span> *)sql &#123;</span><br><span class="line">    <span class="keyword">if</span> (![<span class="keyword">self</span> _dbCheck] || sql.length == <span class="number">0</span> || !_dbStmtCache) <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    <span class="comment">// â‘  ä»ç¼“å­˜ä¸­æŸ¥æ‰¾ sqlite3_stmt å¯¹è±¡</span></span><br><span class="line">    sqlite3_stmt *stmt = (sqlite3_stmt *)<span class="built_in">CFDictionaryGetValue</span>(_dbStmtCache, (__bridge <span class="keyword">const</span> <span class="keyword">void</span> *)(sql));</span><br><span class="line">    <span class="keyword">if</span> (!stmt) &#123;</span><br><span class="line">        <span class="comment">// â‘¡-â‘  ç¼“å­˜ä¸­æ²¡æœ‰ --&gt; è°ƒç”¨ sqlite3_prepare_v2 åˆ›å»º</span></span><br><span class="line">        <span class="keyword">int</span> result = sqlite3_prepare_v2(_db, sql.UTF8String, <span class="number">-1</span>, &amp;stmt, <span class="literal">NULL</span>);</span><br><span class="line">        <span class="keyword">if</span> (result != SQLITE_OK) &#123;</span><br><span class="line">            <span class="keyword">if</span> (_errorLogsEnabled) <span class="built_in">NSLog</span>(<span class="string">@&quot;%s line:%d sqlite stmt prepare error (%d): %s&quot;</span>, __FUNCTION__, __LINE__, result, sqlite3_errmsg(_db));</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// â‘¡-â‘¡ å°†æ–°åˆ›å»ºçš„ sqlite3_stmt å¯¹è±¡ å­˜å…¥ç¼“å­˜</span></span><br><span class="line">        <span class="built_in">CFDictionarySetValue</span>(_dbStmtCache, (__bridge <span class="keyword">const</span> <span class="keyword">void</span> *)(sql), stmt);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// â‘¢ ç¼“å­˜ä¸­å­˜åœ¨ --&gt; è°ƒç”¨ sqlite3_reset é‡ç½®ä¸€ä¸‹ï¼Œä¾›å¤–ç•Œä½¿ç”¨</span></span><br><span class="line">        sqlite3_reset(stmt);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> stmt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>[self _dbCheck]</code>å…¶å®æ˜¯å¯¹DBæ•°æ®åº“çš„ä¸€ä¸ªæ ¡éªŒä¸<code>é‡è¯•</code>å¤„ç†ï¼š</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="built_in">NSUInteger</span> kMaxErrorRetryCount = <span class="number">8</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="built_in">NSTimeInterval</span> kMinRetryTimeInterval = <span class="number">2.0</span>;</span><br><span class="line">- (<span class="built_in">BOOL</span>)_dbCheck &#123;</span><br><span class="line">    <span class="keyword">if</span> (!_db) &#123;</span><br><span class="line">        <span class="comment">// _dbOpenErrorCount: `sqlite3_open` å¤±è´¥å°±ä¼šåŠ ä¸€</span></span><br><span class="line">        <span class="keyword">if</span> (_dbOpenErrorCount &lt; kMaxErrorRetryCount &amp;&amp;</span><br><span class="line">            <span class="built_in">CACurrentMediaTime</span>() - _dbLastOpenErrorTime &gt; kMinRetryTimeInterval) &#123;</span><br><span class="line">            <span class="comment">// é‡æ–°æ‰“å¼€ åŠ åˆå§‹åŒ–</span></span><br><span class="line">            <span class="keyword">return</span> [<span class="keyword">self</span> _dbOpen] &amp;&amp; [<span class="keyword">self</span> _dbInitialize];</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>[self _dbOpen]</code>å†…éƒ¨ä¼šè°ƒç”¨<code>sqlite3_open</code>æ‰“å¼€æ•°æ®åº“ï¼Œæ‰“å¼€æˆåŠŸåä¼šåˆ›å»ºäº†ä¸€ä¸ª<code>_dbStmtCache</code>ï¼Œç”¨æ¥ç¼“å­˜<code>sqlite3_stmt</code>å¯¹è±¡ï¼›</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="built_in">BOOL</span>)_dbOpen &#123;</span><br><span class="line">    <span class="keyword">if</span> (_db) <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">int</span> result = sqlite3_open(_dbPath.UTF8String, &amp;_db);</span><br><span class="line">    <span class="keyword">if</span> (result == SQLITE_OK) &#123;</span><br><span class="line">        <span class="built_in">CFDictionaryKeyCallBacks</span> keyCallbacks = kCFCopyStringDictionaryKeyCallBacks;</span><br><span class="line">        <span class="built_in">CFDictionaryValueCallBacks</span> valueCallbacks = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">        _dbStmtCache = <span class="built_in">CFDictionaryCreateMutable</span>(<span class="built_in">CFAllocatorGetDefault</span>(), <span class="number">0</span>, &amp;keyCallbacks, &amp;valueCallbacks);</span><br><span class="line">        _dbLastOpenErrorTime = <span class="number">0</span>;</span><br><span class="line">        _dbOpenErrorCount = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        _db = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="keyword">if</span> (_dbStmtCache) <span class="built_in">CFRelease</span>(_dbStmtCache);</span><br><span class="line">        _dbStmtCache = <span class="literal">NULL</span>;</span><br><span class="line">        _dbLastOpenErrorTime = <span class="built_in">CACurrentMediaTime</span>();</span><br><span class="line">        _dbOpenErrorCount++;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (_errorLogsEnabled) &#123;</span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@&quot;%s line:%d sqlite open failed (%d).&quot;</span>, __FUNCTION__, __LINE__, result);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="sqlite3-WAL"><a href="#sqlite3-WAL" class="headerlink" title="sqlite3 WAL"></a>sqlite3 WAL</h3><ul><li><code>WAL</code>çš„å…¨ç§°æ˜¯<code>Write Ahead Logging</code>ï¼Œå®ƒæ˜¯å¾ˆå¤šæ•°æ®åº“ä¸­ç”¨äºå®ç°<code>åŸå­äº‹åŠ¡</code>çš„ä¸€ç§æœºåˆ¶ï¼Œ<code>SQLite</code>åœ¨<code>3.7.0</code>ç‰ˆæœ¬å¼•å…¥äº†è¯¥ç‰¹æ€§ã€‚</li><li>åœ¨å¼•å…¥<code>WAL</code>æœºåˆ¶ä¹‹å‰ï¼Œ<code>SQLite</code>ä½¿ç”¨<code>rollback journal</code>æœºåˆ¶å®ç°<code>åŸå­äº‹åŠ¡</code>ã€‚</li></ul><blockquote><p><code>rollback journal</code> VS <code>WAL</code></p></blockquote><ul><li><code>rollback journal</code>æœºåˆ¶ï¼šä¿®æ”¹æ•°æ®ä¹‹å‰ï¼Œå…ˆå¯¹è¦ä¿®æ”¹çš„æ•°æ®è¿›è¡Œ<code>å¤‡ä»½</code>ï¼Œå¦‚æœäº‹åŠ¡æˆåŠŸï¼Œå°±æäº¤ä¿®æ”¹å¹¶åˆ é™¤å¤‡ä»½ï¼›å¦‚æœäº‹åŠ¡å¤±è´¥ï¼šå°±å°†å¤‡ä»½æ•°æ®æ‹·è´å›å»ï¼Œæ’¤é”€ä¿®æ”¹ï¼›</li><li><code>WAL</code>æœºåˆ¶ï¼šå½“ä¿®æ”¹æ•°æ®æ—¶ï¼Œå¹¶ä¸ç›´æ¥å†™å…¥æ•°æ®åº“ï¼Œè€Œæ˜¯å†™å…¥åˆ°å¦å¤–ä¸€ä¸ª<code>WAL</code>æ–‡ä»¶ä¸­ï¼›å¦‚æœäº‹åŠ¡æˆåŠŸï¼šå°†ä¼šåœ¨éšåçš„<code>æŸä¸ªæ—¶é—´èŠ‚ç‚¹</code>å†™å›åˆ°æ•°æ®åº“ï¼›å¦‚æœäº‹åŠ¡å¤±è´¥ï¼š<code>WAL</code>æ–‡ä»¶ä¸­çš„è®°å½•ä¼šè¢«å¿½ç•¥ï¼›<ul><li>åŒæ­¥<code>WAL</code>æ–‡ä»¶å’Œæ•°æ®åº“æ–‡ä»¶çš„è¡Œä¸ºç§°ä¸º<code>checkpoint</code>ï¼Œå®ƒæœ‰<code>SQLite</code>è‡ªåŠ¨æ‰§è¡Œï¼Œé»˜è®¤ï¼š<code>WAL</code>æ–‡ä»¶ç´¯è®¡åˆ°<code>1000é¡µ</code>ä¿®æ”¹ï¼›</li><li>ä¹Ÿå¯ä»¥é€šè¿‡<code>SQLITE_API int sqlite3_wal_checkpoint(sqlite3 *db, const char *zDb);</code>æ‰‹åŠ¨æ‰§è¡Œå¹¶é‡ç½®<code>WAL</code>ï¼›</li></ul></li></ul><blockquote><p>å¯ä»¥åœ¨ <a target="_blank" rel="noopener" href="https://www.sqlite.org/pragma.html#pragma_wal_checkpoint">SQLiteå®˜æ–¹æ–‡æ¡£</a> æŸ¥é˜…ç›¸å…³ä½¿ç”¨ä»‹ç»ï¼š</p></blockquote><ul><li><p><code>SQL</code>è¯­å¥ä¸­ä½¿ç”¨</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator">/</span><span class="operator">/</span> journal_mode æ¨¡å¼ï¼›</span><br><span class="line"><span class="operator">/</span><span class="operator">/</span> æ¯”å¦‚ï¼šPRAGMA journal_mode <span class="operator">=</span> wal;</span><br><span class="line">PRAGMA journal_mode</span><br></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PRAGMA wal_checkpoint</span><br></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PRAGMA wal_autocheckpoint</span><br></pre></td></tr></table></figure></li><li><p>å‡½æ•°è°ƒç”¨</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å°†WALä¸­çš„é¢„å†™æ—¥å¿—è½¬ç§»åˆ°æ•°æ®åº“æ–‡ä»¶ä¸­ï¼Œå¹¶è¢«é‡ç½®WALé¢„å†™æ—¥å¿—</span></span><br><span class="line"><span class="function">SQLITE_API <span class="type">int</span> <span class="title">sqlite3_wal_checkpoint</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    sqlite3 *db, </span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> <span class="type">char</span> *zDb</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// é…ç½® autocheckpoint</span></span><br><span class="line"><span class="comment">// æ¯ä¸ªæ–°çš„[database connection] é»˜è®¤å¼€å¯ auto-checkpointï¼Œé»˜è®¤å€¼ï¼š1000</span></span><br><span class="line"><span class="function">SQLITE_API <span class="type">int</span> <span class="title">sqlite3_wal_autocheckpoint</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    sqlite3 *db, </span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">int</span> N</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ³¨å†Œä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œåœ¨walæ¨¡å¼ä¸‹ï¼Œæ¯æ¬¡æ•°æ®æäº¤åˆ°æ•°æ®åº“æ—¶éƒ½ä¼šè°ƒç”¨è¿™ä¸ªå›è°ƒå‡½æ•°</span></span><br><span class="line">SQLITE_API <span class="keyword">void</span> *sqlite3_wal_hook(</span><br><span class="line">    sqlite3*, </span><br><span class="line">    <span class="keyword">int</span>(*)(<span class="keyword">void</span> *,sqlite3*,<span class="keyword">const</span> <span class="keyword">char</span>*,<span class="keyword">int</span>),</span><br><span class="line">    <span class="keyword">void</span>*</span><br><span class="line">);</span><br></pre></td></tr></table></figure></li></ul><blockquote><p><code>YYDiskCache</code> ä¸­çš„ <code>SQLite WAL</code></p></blockquote><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="built_in">BOOL</span>)_dbInitialize &#123;</span><br><span class="line">    <span class="built_in">NSString</span> *sql = <span class="string">@&quot;pragma journal_mode = wal; pragma synchronous = normal; create table if not exists manifest (key text, filename text, size integer, inline_data blob, modification_time integer, last_access_time integer, extended_data blob, primary key(key)); create index if not exists last_access_time_idx on manifest(last_access_time);&quot;</span>;</span><br><span class="line">    <span class="keyword">return</span> [<span class="keyword">self</span> _dbExecute:sql];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)_dbCheckpoint &#123;</span><br><span class="line">    <span class="keyword">if</span> (![<span class="keyword">self</span> _dbCheck]) <span class="keyword">return</span>;</span><br><span class="line">    <span class="comment">// Cause a checkpoint to occur, merge `sqlite-wal` file to `sqlite` file.</span></span><br><span class="line">    sqlite3_wal_checkpoint(_db, <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>åœ¨<code>YYKVStorage.m</code>ä¸­çš„éƒ¨åˆ†<code>remove</code>æ“ä½œä¸­ä½¿ç”¨åˆ°äº†<code>_dbCheckpoint</code></li></ul><h1 id="YYDiskCache-LRU"><a href="#YYDiskCache-LRU" class="headerlink" title="YYDiskCache LRU"></a>YYDiskCache LRU</h1><blockquote><p>ä»¥ <code>- (void)trimToCount:(NSUInteger)count;</code> ä¸ºä¾‹:</p></blockquote><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// YYDiskCache.m</span></span><br><span class="line">- (<span class="keyword">void</span>)trimToCount:(<span class="built_in">NSUInteger</span>)count &#123;</span><br><span class="line">    Lock(); <span class="comment">// åŠ é”</span></span><br><span class="line">    [<span class="keyword">self</span> _trimToCount:count]; <span class="comment">// ç§»é™¤æ“ä½œ</span></span><br><span class="line">    Unlock(); <span class="comment">// è§£é”</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// YYDiskCache.m</span></span><br><span class="line">- (<span class="keyword">void</span>)_trimToCount:(<span class="built_in">NSUInteger</span>)countLimit &#123;</span><br><span class="line">    <span class="keyword">if</span> (countLimit &gt;= INT_MAX) <span class="keyword">return</span>;</span><br><span class="line">    [_kv removeItemsToFitCount:(<span class="keyword">int</span>)countLimit];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>çœŸæ­£çš„ç§»é™¤æ“ä½œå…¶å®è¿˜æ˜¯ <code>_kv</code>;</li></ul><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// YYKVStorage.m</span></span><br><span class="line">- (<span class="built_in">BOOL</span>)removeItemsToFitCount:(<span class="keyword">int</span>)maxCount &#123;</span><br><span class="line">    <span class="keyword">if</span> (maxCount == INT_MAX) <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">    <span class="keyword">if</span> (maxCount &lt;= <span class="number">0</span>) <span class="keyword">return</span> [<span class="keyword">self</span> removeAllItems];</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">int</span> total = [<span class="keyword">self</span> _dbGetTotalItemCount];</span><br><span class="line">    <span class="keyword">if</span> (total &lt; <span class="number">0</span>) <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">    <span class="keyword">if</span> (total &lt;= maxCount) <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSArray</span> *items = <span class="literal">nil</span>;</span><br><span class="line">    <span class="built_in">BOOL</span> suc = <span class="literal">NO</span>;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="comment">// â‘  å®šä¹‰æ¯æ¬¡ä» SQLite DB å–å‡ºçš„æ•°æ®é‡ä¸ºï¼š16ä¸ª</span></span><br><span class="line">        <span class="keyword">int</span> perCount = <span class="number">16</span>;</span><br><span class="line">        <span class="comment">// â‘¡ ä» SQLite DB å–å‡ºç›¸åº”æ•°é‡çš„æ•°æ®</span></span><br><span class="line">        items = [<span class="keyword">self</span> _dbGetItemSizeInfoOrderByTimeAscWithLimit:perCount];</span><br><span class="line">        <span class="comment">// â‘¢ å¯¹å–å‡ºçš„æ•°æ®è¿›è¡Œéå†åˆ é™¤æ“ä½œï¼Œç›´åˆ°ç¬¦åˆåˆ å‡çš„è¦æ±‚</span></span><br><span class="line">        <span class="keyword">for</span> (YYKVStorageItem *item <span class="keyword">in</span> items) &#123;</span><br><span class="line">            <span class="keyword">if</span> (total &gt; maxCount) &#123;</span><br><span class="line">                <span class="comment">// â‘¢-â‘  å¦‚æœæ˜¯Fileæ–¹å¼ï¼Œè¿˜éœ€è¦å°†Fileä¸€å¹¶åˆ é™¤</span></span><br><span class="line">                <span class="keyword">if</span> (item.filename) &#123;</span><br><span class="line">                    [<span class="keyword">self</span> _fileDeleteWithName:item.filename];</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// â‘¢-â‘¡ åˆ é™¤SQLite DBä¸­çš„æ•°æ®</span></span><br><span class="line">                suc = [<span class="keyword">self</span> _dbDeleteItemWithKey:item.key];</span><br><span class="line">                total--;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (!suc) <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">while</span> (total &gt; maxCount &amp;&amp; items.count &gt; <span class="number">0</span> &amp;&amp; suc);</span><br><span class="line">    <span class="keyword">if</span> (suc) [<span class="keyword">self</span> _dbCheckpoint];</span><br><span class="line">    <span class="keyword">return</span> suc;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>â‘  å®šä¹‰æ¯æ¬¡ä» SQLite DB å–å‡ºçš„æ•°æ®é‡ä¸ºï¼š16ä¸ª</li><li>â‘¡ ä» SQLite DB å–å‡ºç›¸åº”æ•°é‡çš„æ•°æ®</li><li>â‘¢ å¯¹å–å‡ºçš„æ•°æ®è¿›è¡Œéå†åˆ é™¤æ“ä½œï¼Œç›´åˆ°ç¬¦åˆåˆ å‡çš„è¦æ±‚<ul><li>â‘¢-â‘  å¦‚æœæ˜¯Fileæ–¹å¼ï¼Œè¿˜éœ€è¦å°†Fileä¸€å¹¶åˆ é™¤</li><li>â‘¢-â‘¡ åˆ é™¤SQLite DBä¸­çš„æ•°æ®</li></ul></li></ul><blockquote><p>ç”±ä¸Šå¯çŸ¥ï¼šLRU åº”è¯¥åœ¨ <code>â‘¡ ä» SQLite DB å–å‡ºç›¸åº”æ•°é‡çš„æ•°æ®ï¼›</code> ä¸­æœ‰æ‰€ä½“ç°ï¼›</p></blockquote><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// YYKVStorage.m</span></span><br><span class="line">- (<span class="built_in">NSMutableArray</span> *)_dbGetItemSizeInfoOrderByTimeAscWithLimit:(<span class="keyword">int</span>)count &#123;</span><br><span class="line">    <span class="built_in">NSString</span> *sql = <span class="string">@&quot;select key, filename, size from manifest order by last_access_time asc limit ?1;&quot;</span>;</span><br><span class="line">    sqlite3_stmt *stmt = [<span class="keyword">self</span> _dbPrepareStmt:sql];</span><br><span class="line">    <span class="keyword">if</span> (!stmt) <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    sqlite3_bind_int(stmt, <span class="number">1</span>, count);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSMutableArray</span> *items = [<span class="built_in">NSMutableArray</span> new];</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="keyword">int</span> result = sqlite3_step(stmt);</span><br><span class="line">        <span class="keyword">if</span> (result == SQLITE_ROW) &#123;</span><br><span class="line">            <span class="keyword">char</span> *key = (<span class="keyword">char</span> *)sqlite3_column_text(stmt, <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">char</span> *filename = (<span class="keyword">char</span> *)sqlite3_column_text(stmt, <span class="number">1</span>);</span><br><span class="line">            <span class="keyword">int</span> size = sqlite3_column_int(stmt, <span class="number">2</span>);</span><br><span class="line">            <span class="built_in">NSString</span> *keyStr = key ? [<span class="built_in">NSString</span> stringWithUTF8String:key] : <span class="literal">nil</span>;</span><br><span class="line">            <span class="keyword">if</span> (keyStr) &#123;</span><br><span class="line">                YYKVStorageItem *item = [YYKVStorageItem new];</span><br><span class="line">                item.key = key ? [<span class="built_in">NSString</span> stringWithUTF8String:key] : <span class="literal">nil</span>;</span><br><span class="line">                item.filename = filename ? [<span class="built_in">NSString</span> stringWithUTF8String:filename] : <span class="literal">nil</span>;</span><br><span class="line">                item.size = size;</span><br><span class="line">                [items addObject:item];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (result == SQLITE_DONE) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (_errorLogsEnabled) <span class="built_in">NSLog</span>(<span class="string">@&quot;%s line:%d sqlite query error (%d): %s&quot;</span>, __FUNCTION__, __LINE__, result, sqlite3_errmsg(_db));</span><br><span class="line">            items = <span class="literal">nil</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">while</span> (<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> items;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œçš„<code>SQL</code>è¯­å¥æ˜¯ï¼š<br><code>select key, filename, size from manifest order by last_access_time asc limit ?1;</code></p><ul><li>æŒ‰ç…§<code>last_access_time</code>å‡åºæ’åˆ—ä¾æ¬¡å–å‡ºï¼›</li><li>åŒæ ·ä½¿ç”¨<code>sqlite3_stmt</code>æ‰§è¡Œ<code>SQL</code>ï¼›</li></ul><blockquote><p>é‚£ä¹ˆ<code>last_access_time</code>å‡åºå’Œ<code>LRU</code>æœ‰ä»€ä¹ˆå…³ç³»å‘¢ï¼Ÿ</p></blockquote><p>é‚£æˆ‘ä»¬å°±ä¸å¾—ä¸åœ¨æä¸€ä¸ªAPï¼Œä»¥<code>- (nullable id&lt;NSCoding&gt;)objectForKey:(NSString *)key;</code>ä¸ºä¾‹ï¼š</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// YYDiskCache.m</span></span><br><span class="line">- (<span class="keyword">id</span>&lt;<span class="built_in">NSCoding</span>&gt;)objectForKey:(<span class="built_in">NSString</span> *)key &#123;</span><br><span class="line">    <span class="keyword">if</span> (!key) <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    Lock(); <span class="comment">// åŠ é”</span></span><br><span class="line">    YYKVStorageItem *item = [_kv getItemForKey:key]; <span class="comment">// get æ“ä½œ(è¿™é‡Œä¸»è¦åˆ†æ)</span></span><br><span class="line">    Unlock();<span class="comment">// è§£é”</span></span><br><span class="line">    <span class="keyword">if</span> (!item.value) <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">id</span> object = <span class="literal">nil</span>;</span><br><span class="line">    <span class="keyword">if</span> (_customUnarchiveBlock) &#123;</span><br><span class="line">        object = _customUnarchiveBlock(item.value);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">@try</span> &#123;</span><br><span class="line">            object = [<span class="built_in">NSKeyedUnarchiver</span> unarchiveObjectWithData:item.value];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">@catch</span> (<span class="built_in">NSException</span> *exception) &#123;</span><br><span class="line">            <span class="comment">// nothing to do...</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (object &amp;&amp; item.extendedData) &#123;</span><br><span class="line">        [YYDiskCache setExtendedData:item.extendedData toObject:object];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> object;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>çœŸæ­£çš„è¯»å–æ“ä½œå…¶å®è¿˜æ˜¯ <code>_kv</code>;</li></ul><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// YYKVStorage.m</span></span><br><span class="line">- (YYKVStorageItem *)getItemForKey:(<span class="built_in">NSString</span> *)key &#123;</span><br><span class="line">    <span class="keyword">if</span> (key.length == <span class="number">0</span>) <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    YYKVStorageItem *item = [<span class="keyword">self</span> _dbGetItemWithKey:key excludeInlineData:<span class="literal">NO</span>];</span><br><span class="line">    <span class="keyword">if</span> (item) &#123;</span><br><span class="line">        <span class="comment">// ğŸ””â—ï¸â—ï¸â—ï¸ğŸ””â—ï¸â—ï¸â—ï¸ğŸ””â—ï¸â—ï¸â—ï¸</span></span><br><span class="line">        <span class="comment">// æ›´æ–°SQLite DB ä¸­æœ¬æ¡æ•°æ®çš„ AccessTime</span></span><br><span class="line">        [<span class="keyword">self</span> _dbUpdateAccessTimeWithKey:key];</span><br><span class="line">        <span class="keyword">if</span> (item.filename) &#123;</span><br><span class="line">            item.value = [<span class="keyword">self</span> _fileReadWithName:item.filename];</span><br><span class="line">            <span class="keyword">if</span> (!item.value) &#123;</span><br><span class="line">                [<span class="keyword">self</span> _dbDeleteItemWithKey:key];</span><br><span class="line">                item = <span class="literal">nil</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> item;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// YYKVStorage.m</span></span><br><span class="line">- (<span class="built_in">BOOL</span>)_dbUpdateAccessTimeWithKey:(<span class="built_in">NSString</span> *)key &#123;</span><br><span class="line">    <span class="built_in">NSString</span> *sql = <span class="string">@&quot;update manifest set last_access_time = ?1 where key = ?2;&quot;</span>;</span><br><span class="line">    sqlite3_stmt *stmt = [<span class="keyword">self</span> _dbPrepareStmt:sql];</span><br><span class="line">    <span class="keyword">if</span> (!stmt) <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">    sqlite3_bind_int(stmt, <span class="number">1</span>, (<span class="keyword">int</span>)time(<span class="literal">NULL</span>));</span><br><span class="line">    sqlite3_bind_text(stmt, <span class="number">2</span>, key.UTF8String, <span class="number">-1</span>, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">int</span> result = sqlite3_step(stmt);</span><br><span class="line">    <span class="keyword">if</span> (result != SQLITE_DONE) &#123;</span><br><span class="line">        <span class="keyword">if</span> (_errorLogsEnabled) <span class="built_in">NSLog</span>(<span class="string">@&quot;%s line:%d sqlite update error (%d): %s&quot;</span>, __FUNCTION__, __LINE__, result, sqlite3_errmsg(_db));</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œçš„<code>SQL</code>è¯­å¥æ˜¯ï¼š<br><code>update manifest set last_access_time = ?1 where key = ?2;</code></p><ul><li>æ›´æ–°æœ¬æ¡æ•°æ®çš„ <code>last_access_time</code>ï¼›</li><li>åŒæ ·ä½¿ç”¨<code>sqlite3_stmt</code>æ‰§è¡Œ<code>SQL</code>ï¼›</li></ul><blockquote><p>è‡³æ­¤ï¼šYYDiskCache ä¸­å…³äº LRU çš„å®ç°ä¹Ÿå°±æ˜æœ—äº†~</p></blockquote><h2 id="get-æ“ä½œï¼š"><a href="#get-æ“ä½œï¼š" class="headerlink" title="get æ“ä½œï¼š"></a>get æ“ä½œï¼š</h2><ul><li>æ¯æ¬¡åœ¨è¯»å–æ•°æ®çš„æ—¶å€™ï¼Œéƒ½ä¼šæ›´æ–°æ•°æ®çš„<code>last_access_time</code>ï¼›</li></ul><h2 id="trim-æ“ä½œ"><a href="#trim-æ“ä½œ" class="headerlink" title="trim æ“ä½œ"></a>trim æ“ä½œ</h2><ul><li>â‘  å½“æˆ‘ä»¬åˆ å‡æ•°æ®æ—¶ï¼Œæ ¹æ®<code>last_access_time</code>å‡åºå–å‡º<code>ä¸€å®šæ•°é‡(æ¯æ¬¡16ä¸ª)</code>çš„æ•°æ®ï¼›</li><li>â‘¡ å¯¹å–å‡ºçš„æ•°æ®åˆ†åˆ«è¿›è¡Œåˆ é™¤æ“ä½œï¼›<ul><li>å¯¹äº<code>File</code>ï¼Œè¿˜éœ€è¦ä¸€å¹¶å°†<code>File</code>åˆ é™¤ï¼›</li></ul></li><li>â‘¢ åˆ é™¤è¿‡ç¨‹ä¸­ï¼Œåˆ¤æ–­æ˜¯å¦å·²ç»æ»¡è¶³åˆ å‡è¦æ±‚ï¼›æœªæ»¡è¶³çš„è¯ç»§ç»­ä»â‘ å¼€å§‹ï¼Œç›´åˆ°æ»¡è¶³åˆ å‡è¦æ±‚ï¼›</li></ul></div><div class="post-copyright"><p class="copyright-item"> <span>Author:</span> <a href="http://yotrolz.com">YotrolZ</a></p><p class="copyright-item"> <span>Link:</span> <a href="http://yotrolz.com/posts/5c5f8fb2/">http://yotrolz.com/posts/5c5f8fb2/</a></p><p class="copyright-item"> <span>License:</span> <a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/" target="_blank">çŸ¥è¯†å…±äº«ç½²å-éå•†ä¸šæ€§ä½¿ç”¨ 4.0 å›½é™…è®¸å¯åè®®</a></p></div><footer class="post-footer"><nav class="post-nav"><a class="prev" href="/posts/ac25c853/"><i class="iconfont icon-left"></i> <span class="prev-text nav-default">YYCacheæºç å­¦ä¹ -å†…å­˜ç¼“å­˜åˆ†æ</span> <span class="prev-text nav-mobile">Prev</span></a> <a class="next" href="/posts/ba9af90f/"><span class="next-text nav-default">YYCacheæºç å­¦ä¹ -åˆå§‹åŒ–åˆ†æ</span> <span class="prev-text nav-mobile">Next</span><i class="iconfont icon-right"></i></a></nav></footer></article></div><div class="comments" id="comments"></div></div></main><footer id="footer" class="footer"><div class="social-links"></div><div class="copyright"> <span class="power-by">Powered by <a class="hexo-link" target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a></span> <span class="division">|</span> <span class="theme-info">Theme - <a class="theme-link" target="_blank" rel="noopener" href="https://github.com/ahonn/hexo-theme-even">Even</a></span> <span class="copyright-year">&copy;2015 - 2022<span class="heart"><i class="iconfont icon-heart"></i></span> <span class="author">YotrolZ</span></span></div></footer><div class="back-to-top" id="back-to-top"><i class="iconfont icon-up"></i></div></div><script type="text/javascript" src="https://cdn.jsdelivr.net/gh/yotrolz/yotrolz.github.io@gh/lib/jquery/jquery.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/gh/yotrolz/yotrolz.github.io@gh/lib/slideout/slideout.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/gh/yotrolz/yotrolz.github.io@gh/lib/fancybox/jquery.fancybox.pack.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/gh/yotrolz/yotrolz.github.io@gh/js/src/even.js?v=2.11.0"></script></body></html>