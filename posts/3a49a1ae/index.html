<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="theme-color" content="#f8f5ec"><meta name="msapplication-navbutton-color" content="#f8f5ec"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec"><meta name="description" content="在上文《iOS 引用计数中惊艳的原子操作(一)》我们对底层实现进行了剖析，本篇文章我们进行一个案例进行测试"><link rel="alternate" href="/atom.xml" title="YotrolZ" type="application/atom+xml"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=2.11.0"><link rel="canonical" href="http://yotrolz.com/posts/3a49a1ae/"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/yotrolz/yotrolz.github.io@gh/lib/fancybox/jquery.fancybox.css"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/yotrolz/yotrolz.github.io@gh/css/style.css?v=2.11.0"><script async src="https://www.googletagmanager.com/gtag/js?id=UA-138610487-3"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-138610487-3")</script><script id="baidu_push">!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}()</script><script src="//cdn.jsdelivr.net/npm/leancloud-storage@4.10.0/dist/av-min.js"></script><script id="leancloud">AV.init({appId:"mqfPQEKBtui9puAJUkYFY7Jn-MdYXbMMI",appKey:"A6R0T4bEvcBsTU8pB7NhJ6Wl"})</script><script>window.config={leancloud:{show_visits:!1,app_id:"mqfPQEKBtui9puAJUkYFY7Jn-MdYXbMMI",app_key:"A6R0T4bEvcBsTU8pB7NhJ6Wl"},toc:!0,fancybox:!0,pjax:"",latex:!1}</script><title>iOS 引用计数中惊艳的原子操作(二) - YotrolZ</title><meta name="generator" content="Hexo 5.4.1"></head><body><div id="mobile-navbar" class="mobile-navbar"><div class="mobile-header-logo"> <a href="/." class="logo">YotrolZ</a></div><div class="mobile-navbar-icon"><span></span><span></span><span></span></div></div><nav id="mobile-menu" class="mobile-menu slideout-menu"><ul class="mobile-menu-list"><a href="/"><li class="mobile-menu-item">Home</li></a><a href="/archives/"><li class="mobile-menu-item">Archives</li></a><a href="/tags/"><li class="mobile-menu-item">Tags</li></a><a href="/categories/"><li class="mobile-menu-item">Categories</li></a></ul></nav><div class="container" id="mobile-panel"><header id="header" class="header"><div class="logo-wrapper"> <a href="/." class="logo">YotrolZ</a></div><nav class="site-navbar"><ul id="menu" class="menu"><li class="menu-item"> <a class="menu-item-link" href="/">Home</a></li><li class="menu-item"> <a class="menu-item-link" href="/archives/">Archives</a></li><li class="menu-item"> <a class="menu-item-link" href="/tags/">Tags</a></li><li class="menu-item"> <a class="menu-item-link" href="/categories/">Categories</a></li></ul></nav></header><main id="main" class="main"><div class="content-wrapper"><div id="content" class="content"><article class="post"><header class="post-header"><h1 class="post-title">iOS 引用计数中惊艳的原子操作(二)</h1><div class="post-meta"> <span class="post-time">2021-01-22</span> <span class="post-visits" style="display:none" data-url="/posts/3a49a1ae/" data-title="iOS 引用计数中惊艳的原子操作(二)">Visits 0</span></div></header><div class="post-toc" id="post-toc"><h2 class="post-toc-title">Contents</h2><div class="post-toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A8%A1%E6%8B%9F%E5%A4%9A%E7%BA%BF%E7%A8%8B%E6%95%B0%E6%8D%AE%E7%AB%9E%E4%BA%89"><span class="toc-text">模拟多线程数据竞争</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E8%AF%B4%E6%98%8E"><span class="toc-text">测试说明</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E5%B7%A5%E7%A8%8B"><span class="toc-text">测试工程</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B1%EF%BC%9A-%E7%9B%B4%E6%8E%A5%E8%BF%9B%E8%A1%8C%E6%93%8D%E4%BD%9C"><span class="toc-text">案例1： 直接进行操作</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81"><span class="toc-text">代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%90%E8%A1%8C%E7%BB%93%E6%9E%9C"><span class="toc-text">运行结果</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%93%E6%9E%9C%E5%88%86%E6%9E%90"><span class="toc-text">结果分析</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B2%EF%BC%9A-%E4%BD%BF%E7%94%A8-ldxr-stxr-%E5%AE%9E%E7%8E%B0%E5%8E%9F%E5%AD%90%E6%93%8D%E4%BD%9C"><span class="toc-text">案例2： 使用 ldxr stxr 实现原子操作</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81-1"><span class="toc-text">代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%90%E8%A1%8C%E7%BB%93%E6%9E%9C-1"><span class="toc-text">运行结果</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%93%E6%9E%9C%E5%88%86%E6%9E%90-1"><span class="toc-text">结果分析</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B3%EF%BC%9A-CAS-Compare-And-Swap"><span class="toc-text">案例3： CAS-Compare And Swap</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81-2"><span class="toc-text">代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%90%E8%A1%8C%E7%BB%93%E6%9E%9C-2"><span class="toc-text">运行结果</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%93%E6%9E%9C%E5%88%86%E6%9E%90-2"><span class="toc-text">结果分析</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B4%EF%BC%9A-sync-fetch-and-add"><span class="toc-text">案例4： __sync_fetch_and_add</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81-3"><span class="toc-text">代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%90%E8%A1%8C%E7%BB%93%E6%9E%9C-3"><span class="toc-text">运行结果</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%93%E6%9E%9C%E5%88%86%E6%9E%90-3"><span class="toc-text">结果分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A1%A5%E5%85%85"><span class="toc-text">补充</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%8E%E7%BB%AD"><span class="toc-text">后续</span></a></li></ol></div></div><div class="post-content"><h2 id="模拟多线程数据竞争"><a href="#模拟多线程数据竞争" class="headerlink" title="模拟多线程数据竞争"></a>模拟多线程数据竞争</h2><h3 id="测试说明"><a href="#测试说明" class="headerlink" title="测试说明"></a>测试说明</h3><ul><li>引用计数变量<code>rc</code>初始值为<code>0</code></li><li>开启<code>多条线程</code>，分别对引用计数<code>rc</code>进行<code>100000</code>次的循环<code>+1</code>操作，执行<code>6次</code><ul><li><code>100000次循环</code>只是为了适当的增加操作消耗，便于突出数据竞争(是否为原子操作)</li><li>我们可以把<code>100000次循环+1</code>的操作视为一个整体操作</li><li>然后开启<code>多条线程</code> <code>并行</code>执行6次</li></ul></li><li>期望结果: <code>rc = 600000</code>, 即：这个<code>100000次循环+1</code>操作不可分割(原子性)，避免了多线程对<code>rc</code>的数据竞争</li></ul><h3 id="测试工程"><a href="#测试工程" class="headerlink" title="测试工程"></a>测试工程</h3><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">ViewController</span> ()</span></span><br><span class="line"><span class="comment">// uintptr_t 本质就是 unsigned long</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) uintptr_t rc; <span class="comment">// 存放引用计数</span></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">ViewController</span></span></span><br><span class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</span><br><span class="line">    [<span class="keyword">super</span> viewDidLoad];</span><br><span class="line">    </span><br><span class="line">    [<span class="keyword">self</span> test]; <span class="comment">// 运行测试</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)test &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">self</span>.rc = <span class="number">0</span>; <span class="comment">// 初始化</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 多线程操作</span></span><br><span class="line">    <span class="built_in">dispatch_queue_t</span> queue = dispatch_queue_create(<span class="string">&quot;com.rc.test&quot;</span>, DISPATCH_QUEUE_CONCURRENT);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">6</span>; i++) &#123;</span><br><span class="line">        <span class="built_in">dispatch_async</span>(queue, ^&#123;</span><br><span class="line">            <span class="comment">// 我们在这里进行相应的模拟测试</span></span><br><span class="line">            [<span class="keyword">self</span> rc_add_x]; <span class="comment">//  x: 测试案例编号</span></span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="案例1：-直接进行操作"><a href="#案例1：-直接进行操作" class="headerlink" title="案例1： 直接进行操作"></a>案例1： 直接进行操作</h2><h3 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h3><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)rc_add_1 &#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100000</span>; i++) &#123;</span><br><span class="line">        _rc++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%@ --- 当前引用计数：%ld&quot;</span>, [<span class="built_in">NSThread</span> currentThread], (<span class="keyword">long</span>)<span class="keyword">self</span>.rc);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="运行结果"><a href="#运行结果" class="headerlink" title="运行结果"></a>运行结果</h3><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="built_in">NSThread</span>: <span class="number">0x283ca03c0</span>&gt;&#123;number = <span class="number">3</span>, name = (null)&#125; --- 当前引用计数：<span class="number">68046</span></span><br><span class="line">&lt;<span class="built_in">NSThread</span>: <span class="number">0x283cb4a00</span>&gt;&#123;number = <span class="number">6</span>, name = (null)&#125; --- 当前引用计数：<span class="number">156790</span></span><br><span class="line">&lt;<span class="built_in">NSThread</span>: <span class="number">0x283ca4140</span>&gt;&#123;number = <span class="number">7</span>, name = (null)&#125; --- 当前引用计数：<span class="number">222358</span></span><br><span class="line">&lt;<span class="built_in">NSThread</span>: <span class="number">0x283ca03c0</span>&gt;&#123;number = <span class="number">3</span>, name = (null)&#125; --- 当前引用计数：<span class="number">233080</span></span><br><span class="line">&lt;<span class="built_in">NSThread</span>: <span class="number">0x283ce34c0</span>&gt;&#123;number = <span class="number">4</span>, name = (null)&#125; --- 当前引用计数：<span class="number">261210</span></span><br><span class="line">&lt;<span class="built_in">NSThread</span>: <span class="number">0x283ca9100</span>&gt;&#123;number = <span class="number">5</span>, name = (null)&#125; --- 当前引用计数：<span class="number">288438</span></span><br></pre></td></tr></table></figure><h3 id="结果分析"><a href="#结果分析" class="headerlink" title="结果分析"></a>结果分析</h3><ul><li><code>rc != 600000</code></li><li>出现了线程间的数据竞争</li></ul><h2 id="案例2：-使用-ldxr-stxr-实现原子操作"><a href="#案例2：-使用-ldxr-stxr-实现原子操作" class="headerlink" title="案例2： 使用 ldxr stxr 实现原子操作"></a>案例2： 使用 ldxr stxr 实现原子操作</h2><ul><li>需要在 <code>arm64</code> 设备上运行，原因可以看下面的代码<h3 id="代码-1"><a href="#代码-1" class="headerlink" title="代码"></a>代码</h3><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)rc_add_2 &#123;</span><br><span class="line">    </span><br><span class="line">    uintptr_t old = <span class="number">0</span>;</span><br><span class="line">    uintptr_t new = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        old = LoadExclusive(&amp;_rc);</span><br><span class="line">        new = old;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">1000000</span>; i++) &#123;</span><br><span class="line">            new++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">while</span> (!StoreExclusive(&amp;_rc, old, new));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// Pointer-size register prefix for inline asm</span></span><br><span class="line"><span class="meta"># <span class="keyword">if</span> __LP64__</span></span><br><span class="line"><span class="meta">#   <span class="keyword">define</span> p <span class="string">&quot;x&quot;</span>  <span class="comment">// true arm64</span></span></span><br><span class="line"><span class="meta"># <span class="keyword">else</span></span></span><br><span class="line"><span class="meta">#   <span class="keyword">define</span> p <span class="string">&quot;w&quot;</span>  <span class="comment">// arm64_32</span></span></span><br><span class="line"><span class="meta"># <span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/// 下面两个方法 其实就是 objc-object 引用计数操作 中的源码(只是加了一些打印)</span></span><br><span class="line"><span class="keyword">static</span> uintptr_t LoadExclusive(uintptr_t *src) &#123;</span><br><span class="line">    uintptr_t result;</span><br><span class="line">    <span class="keyword">asm</span>(<span class="string">&quot;ldxr %&quot;</span> p <span class="string">&quot;0, [%x1]&quot;</span></span><br><span class="line">        : <span class="string">&quot;=r&quot;</span> (result)</span><br><span class="line">        : <span class="string">&quot;r&quot;</span> (src), <span class="string">&quot;m&quot;</span> (*src));</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">bool</span> StoreExclusive(uintptr_t *dst, uintptr_t oldvalue __unused, uintptr_t value) &#123;</span><br><span class="line">    uint32_t result;</span><br><span class="line">    <span class="keyword">asm</span>(<span class="string">&quot;stxr %w0, %&quot;</span> p <span class="string">&quot;2, [%x3]&quot;</span></span><br><span class="line">        : <span class="string">&quot;=&amp;r&quot;</span> (result), <span class="string">&quot;=m&quot;</span> (*dst)</span><br><span class="line">        : <span class="string">&quot;r&quot;</span> (value), <span class="string">&quot;r&quot;</span> (dst));</span><br><span class="line"></span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%@ --- 引用计数：%ld --- !result: %d&quot;</span>, [<span class="built_in">NSThread</span> currentThread], *dst, !result);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> !result; <span class="comment">// 注意这里的取反操作(源码中就是这样)，stxr指令写入成功时 result 其实是 0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><h3 id="运行结果-1"><a href="#运行结果-1" class="headerlink" title="运行结果"></a>运行结果</h3><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="built_in">NSThread</span>: <span class="number">0x281dd8440</span>&gt;&#123;number = <span class="number">3</span>, name = (null)&#125; --- 引用计数：<span class="number">0</span> --- !result: <span class="number">0</span></span><br><span class="line">&lt;<span class="built_in">NSThread</span>: <span class="number">0x281dd8440</span>&gt;&#123;number = <span class="number">3</span>, name = (null)&#125; --- 引用计数：<span class="number">0</span> --- !result: <span class="number">0</span></span><br><span class="line">&lt;<span class="built_in">NSThread</span>: <span class="number">0x281dd8c00</span>&gt;&#123;number = <span class="number">6</span>, name = (null)&#125; --- 引用计数：<span class="number">0</span> --- !result: <span class="number">0</span></span><br><span class="line">&lt;<span class="built_in">NSThread</span>: <span class="number">0x281dd8440</span>&gt;&#123;number = <span class="number">3</span>, name = (null)&#125; --- 引用计数：<span class="number">0</span> --- !result: <span class="number">0</span></span><br><span class="line">&lt;<span class="built_in">NSThread</span>: <span class="number">0x281dd8c00</span>&gt;&#123;number = <span class="number">6</span>, name = (null)&#125; --- 引用计数：<span class="number">0</span> --- !result: <span class="number">0</span></span><br><span class="line">&lt;<span class="built_in">NSThread</span>: <span class="number">0x281db7e00</span>&gt;&#123;number = <span class="number">4</span>, name = (null)&#125; --- 引用计数：<span class="number">0</span> --- !result: <span class="number">0</span></span><br><span class="line">&lt;<span class="built_in">NSThread</span>: <span class="number">0x281db6540</span>&gt;&#123;number = <span class="number">5</span>, name = (null)&#125; --- 引用计数：<span class="number">0</span> --- !result: <span class="number">0</span></span><br><span class="line">&lt;<span class="built_in">NSThread</span>: <span class="number">0x281db7e00</span>&gt;&#123;number = <span class="number">4</span>, name = (null)&#125; --- 引用计数：<span class="number">1000000</span> --- !result: <span class="number">1</span></span><br><span class="line">&lt;<span class="built_in">NSThread</span>: <span class="number">0x281dc4040</span>&gt;&#123;number = <span class="number">8</span>, name = (null)&#125; --- 引用计数：<span class="number">1000000</span> --- !result: <span class="number">0</span></span><br><span class="line">&lt;<span class="built_in">NSThread</span>: <span class="number">0x281db6540</span>&gt;&#123;number = <span class="number">5</span>, name = (null)&#125; --- 引用计数：<span class="number">1000000</span> --- !result: <span class="number">0</span></span><br><span class="line">&lt;<span class="built_in">NSThread</span>: <span class="number">0x281dda500</span>&gt;&#123;number = <span class="number">9</span>, name = (null)&#125; --- 引用计数：<span class="number">1000000</span> --- !result: <span class="number">0</span></span><br><span class="line">&lt;<span class="built_in">NSThread</span>: <span class="number">0x281dda500</span>&gt;&#123;number = <span class="number">9</span>, name = (null)&#125; --- 引用计数：<span class="number">1000000</span> --- !result: <span class="number">0</span></span><br><span class="line">&lt;<span class="built_in">NSThread</span>: <span class="number">0x281dc4040</span>&gt;&#123;number = <span class="number">8</span>, name = (null)&#125; --- 引用计数：<span class="number">1000000</span> --- !result: <span class="number">0</span></span><br><span class="line">&lt;<span class="built_in">NSThread</span>: <span class="number">0x281db6540</span>&gt;&#123;number = <span class="number">5</span>, name = (null)&#125; --- 引用计数：<span class="number">1000000</span> --- !result: <span class="number">0</span></span><br><span class="line">&lt;<span class="built_in">NSThread</span>: <span class="number">0x281dda500</span>&gt;&#123;number = <span class="number">9</span>, name = (null)&#125; --- 引用计数：<span class="number">1000000</span> --- !result: <span class="number">0</span></span><br><span class="line">&lt;<span class="built_in">NSThread</span>: <span class="number">0x281dd8c00</span>&gt;&#123;number = <span class="number">6</span>, name = (null)&#125; --- 引用计数：<span class="number">1000000</span> --- !result: <span class="number">0</span></span><br><span class="line">&lt;<span class="built_in">NSThread</span>: <span class="number">0x281db6540</span>&gt;&#123;number = <span class="number">5</span>, name = (null)&#125; --- 引用计数：<span class="number">1000000</span> --- !result: <span class="number">0</span></span><br><span class="line">&lt;<span class="built_in">NSThread</span>: <span class="number">0x281dd8440</span>&gt;&#123;number = <span class="number">3</span>, name = (null)&#125; --- 引用计数：<span class="number">1000000</span> --- !result: <span class="number">0</span></span><br><span class="line">&lt;<span class="built_in">NSThread</span>: <span class="number">0x281db6540</span>&gt;&#123;number = <span class="number">5</span>, name = (null)&#125; --- 引用计数：<span class="number">1000000</span> --- !result: <span class="number">0</span></span><br><span class="line">&lt;<span class="built_in">NSThread</span>: <span class="number">0x281dda500</span>&gt;&#123;number = <span class="number">9</span>, name = (null)&#125; --- 引用计数：<span class="number">1000000</span> --- !result: <span class="number">0</span></span><br><span class="line">&lt;<span class="built_in">NSThread</span>: <span class="number">0x281dc4040</span>&gt;&#123;number = <span class="number">8</span>, name = (null)&#125; --- 引用计数：<span class="number">1000000</span> --- !result: <span class="number">0</span></span><br><span class="line">&lt;<span class="built_in">NSThread</span>: <span class="number">0x281dd8440</span>&gt;&#123;number = <span class="number">3</span>, name = (null)&#125; --- 引用计数：<span class="number">1000000</span> --- !result: <span class="number">0</span></span><br><span class="line">&lt;<span class="built_in">NSThread</span>: <span class="number">0x281dd8c00</span>&gt;&#123;number = <span class="number">6</span>, name = (null)&#125; --- 引用计数：<span class="number">1000000</span> --- !result: <span class="number">0</span></span><br><span class="line">&lt;<span class="built_in">NSThread</span>: <span class="number">0x281dda500</span>&gt;&#123;number = <span class="number">9</span>, name = (null)&#125; --- 引用计数：<span class="number">1000000</span> --- !result: <span class="number">0</span></span><br><span class="line">&lt;<span class="built_in">NSThread</span>: <span class="number">0x281dd8c00</span>&gt;&#123;number = <span class="number">6</span>, name = (null)&#125; --- 引用计数：<span class="number">1000000</span> --- !result: <span class="number">0</span></span><br><span class="line">&lt;<span class="built_in">NSThread</span>: <span class="number">0x281dda500</span>&gt;&#123;number = <span class="number">9</span>, name = (null)&#125; --- 引用计数：<span class="number">2000000</span> --- !result: <span class="number">1</span></span><br><span class="line">&lt;<span class="built_in">NSThread</span>: <span class="number">0x281db6540</span>&gt;&#123;number = <span class="number">5</span>, name = (null)&#125; --- 引用计数：<span class="number">2000000</span> --- !result: <span class="number">0</span></span><br><span class="line">&lt;<span class="built_in">NSThread</span>: <span class="number">0x281dd8440</span>&gt;&#123;number = <span class="number">3</span>, name = (null)&#125; --- 引用计数：<span class="number">2000000</span> --- !result: <span class="number">0</span></span><br><span class="line">&lt;<span class="built_in">NSThread</span>: <span class="number">0x281db6540</span>&gt;&#123;number = <span class="number">5</span>, name = (null)&#125; --- 引用计数：<span class="number">3000000</span> --- !result: <span class="number">1</span></span><br><span class="line">&lt;<span class="built_in">NSThread</span>: <span class="number">0x281dd8c00</span>&gt;&#123;number = <span class="number">6</span>, name = (null)&#125; --- 引用计数：<span class="number">3000000</span> --- !result: <span class="number">0</span></span><br><span class="line">&lt;<span class="built_in">NSThread</span>: <span class="number">0x281dd8440</span>&gt;&#123;number = <span class="number">3</span>, name = (null)&#125; --- 引用计数：<span class="number">3000000</span> --- !result: <span class="number">0</span></span><br><span class="line">&lt;<span class="built_in">NSThread</span>: <span class="number">0x281dc4040</span>&gt;&#123;number = <span class="number">8</span>, name = (null)&#125; --- 引用计数：<span class="number">3000000</span> --- !result: <span class="number">0</span></span><br><span class="line">&lt;<span class="built_in">NSThread</span>: <span class="number">0x281dd8440</span>&gt;&#123;number = <span class="number">3</span>, name = (null)&#125; --- 引用计数：<span class="number">4000000</span> --- !result: <span class="number">1</span></span><br><span class="line">&lt;<span class="built_in">NSThread</span>: <span class="number">0x281dc4040</span>&gt;&#123;number = <span class="number">8</span>, name = (null)&#125; --- 引用计数：<span class="number">4000000</span> --- !result: <span class="number">0</span></span><br><span class="line">&lt;<span class="built_in">NSThread</span>: <span class="number">0x281dd8c00</span>&gt;&#123;number = <span class="number">6</span>, name = (null)&#125; --- 引用计数：<span class="number">4000000</span> --- !result: <span class="number">0</span></span><br><span class="line">&lt;<span class="built_in">NSThread</span>: <span class="number">0x281dc4040</span>&gt;&#123;number = <span class="number">8</span>, name = (null)&#125; --- 引用计数：<span class="number">4000000</span> --- !result: <span class="number">0</span></span><br><span class="line">&lt;<span class="built_in">NSThread</span>: <span class="number">0x281dd8c00</span>&gt;&#123;number = <span class="number">6</span>, name = (null)&#125; --- 引用计数：<span class="number">4000000</span> --- !result: <span class="number">0</span></span><br><span class="line">&lt;<span class="built_in">NSThread</span>: <span class="number">0x281dc4040</span>&gt;&#123;number = <span class="number">8</span>, name = (null)&#125; --- 引用计数：<span class="number">4000000</span> --- !result: <span class="number">0</span></span><br><span class="line">&lt;<span class="built_in">NSThread</span>: <span class="number">0x281dd8c00</span>&gt;&#123;number = <span class="number">6</span>, name = (null)&#125; --- 引用计数：<span class="number">4000000</span> --- !result: <span class="number">0</span></span><br><span class="line">&lt;<span class="built_in">NSThread</span>: <span class="number">0x281dc4040</span>&gt;&#123;number = <span class="number">8</span>, name = (null)&#125; --- 引用计数：<span class="number">4000000</span> --- !result: <span class="number">0</span></span><br><span class="line">&lt;<span class="built_in">NSThread</span>: <span class="number">0x281dd8c00</span>&gt;&#123;number = <span class="number">6</span>, name = (null)&#125; --- 引用计数：<span class="number">4000000</span> --- !result: <span class="number">0</span></span><br><span class="line">&lt;<span class="built_in">NSThread</span>: <span class="number">0x281dc4040</span>&gt;&#123;number = <span class="number">8</span>, name = (null)&#125; --- 引用计数：<span class="number">5000000</span> --- !result: <span class="number">1</span></span><br><span class="line">&lt;<span class="built_in">NSThread</span>: <span class="number">0x281dd8c00</span>&gt;&#123;number = <span class="number">6</span>, name = (null)&#125; --- 引用计数：<span class="number">5000000</span> --- !result: <span class="number">0</span></span><br><span class="line">&lt;<span class="built_in">NSThread</span>: <span class="number">0x281dd8c00</span>&gt;&#123;number = <span class="number">6</span>, name = (null)&#125; --- 引用计数：<span class="number">6000000</span> --- !result: <span class="number">1</span></span><br></pre></td></tr></table></figure><h3 id="结果分析-1"><a href="#结果分析-1" class="headerlink" title="结果分析"></a>结果分析</h3><ul><li><code>rc == 600000</code><ul><li>确实解决了线程间数据竞争的问题，原子操作</li></ul></li><li>当数据发生变更(写入成功)时，<code>!result = 1</code>；</li><li>否则写入失败(保持不变)， <code>!result = 0</code>；</li></ul><p><em>过滤出 <code>!result == 1</code> 的 log</em></p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="built_in">NSThread</span>: <span class="number">0x281db7e00</span>&gt;&#123;number = <span class="number">4</span>, name = (null)&#125; --- 引用计数：<span class="number">1000000</span> --- !result: <span class="number">1</span></span><br><span class="line">&lt;<span class="built_in">NSThread</span>: <span class="number">0x281dda500</span>&gt;&#123;number = <span class="number">9</span>, name = (null)&#125; --- 引用计数：<span class="number">2000000</span> --- !result: <span class="number">1</span></span><br><span class="line">&lt;<span class="built_in">NSThread</span>: <span class="number">0x281db6540</span>&gt;&#123;number = <span class="number">5</span>, name = (null)&#125; --- 引用计数：<span class="number">3000000</span> --- !result: <span class="number">1</span></span><br><span class="line">&lt;<span class="built_in">NSThread</span>: <span class="number">0x281dd8440</span>&gt;&#123;number = <span class="number">3</span>, name = (null)&#125; --- 引用计数：<span class="number">4000000</span> --- !result: <span class="number">1</span></span><br><span class="line">&lt;<span class="built_in">NSThread</span>: <span class="number">0x281dc4040</span>&gt;&#123;number = <span class="number">8</span>, name = (null)&#125; --- 引用计数：<span class="number">5000000</span> --- !result: <span class="number">1</span></span><br><span class="line">&lt;<span class="built_in">NSThread</span>: <span class="number">0x281dd8c00</span>&gt;&#123;number = <span class="number">6</span>, name = (null)&#125; --- 引用计数：<span class="number">6000000</span> --- !result: <span class="number">1</span></span><br></pre></td></tr></table></figure><ul><li><code>return !result</code> 即:<code>return true</code><ul><li>也就是 <code>do &#123; ...... &#125; while ( false )</code>, 此时循环就退出了</li></ul></li></ul><h2 id="案例3：-CAS-Compare-And-Swap"><a href="#案例3：-CAS-Compare-And-Swap" class="headerlink" title="案例3： CAS-Compare And Swap"></a>案例3： CAS-Compare And Swap</h2><h3 id="代码-2"><a href="#代码-2" class="headerlink" title="代码"></a>代码</h3><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)rc_add_3 &#123;</span><br><span class="line">    </span><br><span class="line">    uintptr_t old = <span class="number">0</span>;</span><br><span class="line">    uintptr_t new = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        old = LoadExclusive(&amp;_rc);</span><br><span class="line">        new = old;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">1000000</span>; i++) &#123;</span><br><span class="line">            new++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">while</span> (!StoreExclusive(&amp;_rc, old, new));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">uintptr_t LoadExclusive(uintptr_t *src) &#123;</span><br><span class="line">    <span class="keyword">return</span> *src;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">bool</span> StoreExclusive(uintptr_t *dst, uintptr_t oldvalue, uintptr_t value) &#123;</span><br><span class="line">    <span class="keyword">bool</span> result = __sync_bool_compare_and_swap((<span class="keyword">void</span> **)dst, (<span class="keyword">void</span> *)oldvalue, (<span class="keyword">void</span> *)value);</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%@ --- 引用计数：%ld --- result: %d&quot;</span>, [<span class="built_in">NSThread</span> currentThread], *dst, result);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="运行结果-2"><a href="#运行结果-2" class="headerlink" title="运行结果"></a>运行结果</h3><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="built_in">NSThread</span>: <span class="number">0x2829ce200</span>&gt;&#123;number = <span class="number">6</span>, name = (null)&#125; --- 引用计数：<span class="number">1000000</span> --- result: <span class="number">1</span></span><br><span class="line">&lt;<span class="built_in">NSThread</span>: <span class="number">0x2829cce40</span>&gt;&#123;number = <span class="number">3</span>, name = (null)&#125; --- 引用计数：<span class="number">1000000</span> --- result: <span class="number">0</span></span><br><span class="line">&lt;<span class="built_in">NSThread</span>: <span class="number">0x2829ce200</span>&gt;&#123;number = <span class="number">6</span>, name = (null)&#125; --- 引用计数：<span class="number">2000000</span> --- result: <span class="number">1</span></span><br><span class="line">&lt;<span class="built_in">NSThread</span>: <span class="number">0x2829cce40</span>&gt;&#123;number = <span class="number">3</span>, name = (null)&#125; --- 引用计数：<span class="number">2000000</span> --- result: <span class="number">0</span></span><br><span class="line">&lt;<span class="built_in">NSThread</span>: <span class="number">0x2829cd200</span>&gt;&#123;number = <span class="number">5</span>, name = (null)&#125; --- 引用计数：<span class="number">2000000</span> --- result: <span class="number">0</span></span><br><span class="line">&lt;<span class="built_in">NSThread</span>: <span class="number">0x2829cce40</span>&gt;&#123;number = <span class="number">3</span>, name = (null)&#125; --- 引用计数：<span class="number">3000000</span> --- result: <span class="number">1</span></span><br><span class="line">&lt;<span class="built_in">NSThread</span>: <span class="number">0x2829cd200</span>&gt;&#123;number = <span class="number">5</span>, name = (null)&#125; --- 引用计数：<span class="number">3000000</span> --- result: <span class="number">0</span></span><br><span class="line">&lt;<span class="built_in">NSThread</span>: <span class="number">0x2829ca200</span>&gt;&#123;number = <span class="number">8</span>, name = (null)&#125; --- 引用计数：<span class="number">3000000</span> --- result: <span class="number">0</span></span><br><span class="line">&lt;<span class="built_in">NSThread</span>: <span class="number">0x282984f00</span>&gt;&#123;number = <span class="number">9</span>, name = (null)&#125; --- 引用计数：<span class="number">3000000</span> --- result: <span class="number">0</span></span><br><span class="line">&lt;<span class="built_in">NSThread</span>: <span class="number">0x2829ca200</span>&gt;&#123;number = <span class="number">8</span>, name = (null)&#125; --- 引用计数：<span class="number">4000000</span> --- result: <span class="number">1</span></span><br><span class="line">&lt;<span class="built_in">NSThread</span>: <span class="number">0x2829cd200</span>&gt;&#123;number = <span class="number">5</span>, name = (null)&#125; --- 引用计数：<span class="number">4000000</span> --- result: <span class="number">0</span></span><br><span class="line">&lt;<span class="built_in">NSThread</span>: <span class="number">0x282984f00</span>&gt;&#123;number = <span class="number">9</span>, name = (null)&#125; --- 引用计数：<span class="number">4000000</span> --- result: <span class="number">0</span></span><br><span class="line">&lt;<span class="built_in">NSThread</span>: <span class="number">0x2829cd200</span>&gt;&#123;number = <span class="number">5</span>, name = (null)&#125; --- 引用计数：<span class="number">5000000</span> --- result: <span class="number">1</span></span><br><span class="line">&lt;<span class="built_in">NSThread</span>: <span class="number">0x282984f00</span>&gt;&#123;number = <span class="number">9</span>, name = (null)&#125; --- 引用计数：<span class="number">5000000</span> --- result: <span class="number">0</span></span><br><span class="line">&lt;<span class="built_in">NSThread</span>: <span class="number">0x282984f00</span>&gt;&#123;number = <span class="number">9</span>, name = (null)&#125; --- 引用计数：<span class="number">6000000</span> --- result: <span class="number">1</span></span><br></pre></td></tr></table></figure><h3 id="结果分析-2"><a href="#结果分析-2" class="headerlink" title="结果分析"></a>结果分析</h3><ul><li><code>rc == 600000</code><ul><li>确实解决了线程间数据竞争的问题，原子操作</li></ul></li><li>当数据发生变更(写入成功)时，<code>result = 1</code>；</li><li>否则写入失败(保持不变)， <code>result = 0</code>；</li></ul><p><em>过滤出 <code>result == 1</code> 的 log</em></p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="built_in">NSThread</span>: <span class="number">0x2829ce200</span>&gt;&#123;number = <span class="number">6</span>, name = (null)&#125; --- 引用计数：<span class="number">1000000</span> --- result: <span class="number">1</span></span><br><span class="line">&lt;<span class="built_in">NSThread</span>: <span class="number">0x2829ce200</span>&gt;&#123;number = <span class="number">6</span>, name = (null)&#125; --- 引用计数：<span class="number">2000000</span> --- result: <span class="number">1</span></span><br><span class="line">&lt;<span class="built_in">NSThread</span>: <span class="number">0x2829cce40</span>&gt;&#123;number = <span class="number">3</span>, name = (null)&#125; --- 引用计数：<span class="number">3000000</span> --- result: <span class="number">1</span></span><br><span class="line">&lt;<span class="built_in">NSThread</span>: <span class="number">0x2829ca200</span>&gt;&#123;number = <span class="number">8</span>, name = (null)&#125; --- 引用计数：<span class="number">4000000</span> --- result: <span class="number">1</span></span><br><span class="line">&lt;<span class="built_in">NSThread</span>: <span class="number">0x2829cd200</span>&gt;&#123;number = <span class="number">5</span>, name = (null)&#125; --- 引用计数：<span class="number">5000000</span> --- result: <span class="number">1</span></span><br><span class="line">&lt;<span class="built_in">NSThread</span>: <span class="number">0x282984f00</span>&gt;&#123;number = <span class="number">9</span>, name = (null)&#125; --- 引用计数：<span class="number">6000000</span> --- result: <span class="number">1</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><ul><li><code>return result</code> 即:<code>return true</code><ul><li>也就是 <code>do &#123; ...... &#125; while ( false )</code>, 此时循环就退出了</li></ul></li></ul><h2 id="案例4：-sync-fetch-and-add"><a href="#案例4：-sync-fetch-and-add" class="headerlink" title="案例4： __sync_fetch_and_add"></a>案例4： __sync_fetch_and_add</h2><h3 id="代码-3"><a href="#代码-3" class="headerlink" title="代码"></a>代码</h3><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)rc_add_4 &#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100000</span>; i++) &#123;</span><br><span class="line">        <span class="comment">// _rc++; // 案例1 ++ 操作 非原子操作，我们可以使用下面的进行`原子+1`操作</span></span><br><span class="line">        __sync_fetch_and_add(&amp;_rc, <span class="number">1</span>); <span class="comment">// 原子+1 操作</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%@ --- 当前引用计数：%ld&quot;</span>, [<span class="built_in">NSThread</span> currentThread], (<span class="keyword">long</span>)<span class="keyword">self</span>.rc);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="运行结果-3"><a href="#运行结果-3" class="headerlink" title="运行结果"></a>运行结果</h3><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="built_in">NSThread</span>: <span class="number">0x2837cc8c0</span>&gt;&#123;number = <span class="number">6</span>, name = (null)&#125; --- 当前引用计数：<span class="number">213804</span></span><br><span class="line">&lt;<span class="built_in">NSThread</span>: <span class="number">0x28379efc0</span>&gt;&#123;number = <span class="number">3</span>, name = (null)&#125; --- 当前引用计数：<span class="number">430096</span></span><br><span class="line">&lt;<span class="built_in">NSThread</span>: <span class="number">0x28379c4c0</span>&gt;&#123;number = <span class="number">5</span>, name = (null)&#125; --- 当前引用计数：<span class="number">476835</span></span><br><span class="line">&lt;<span class="built_in">NSThread</span>: <span class="number">0x2837c1140</span>&gt;&#123;number = <span class="number">8</span>, name = (null)&#125; --- 当前引用计数：<span class="number">518255</span></span><br><span class="line">&lt;<span class="built_in">NSThread</span>: <span class="number">0x2837ccf40</span>&gt;&#123;number = <span class="number">9</span>, name = (null)&#125; --- 当前引用计数：<span class="number">571700</span></span><br><span class="line">&lt;<span class="built_in">NSThread</span>: <span class="number">0x2837cc8c0</span>&gt;&#123;number = <span class="number">6</span>, name = (null)&#125; --- 当前引用计数：<span class="number">600000</span></span><br></pre></td></tr></table></figure><h3 id="结果分析-3"><a href="#结果分析-3" class="headerlink" title="结果分析"></a>结果分析</h3><ul><li><code>rc != 600000</code></li><li>确实解决了线程间数据竞争的问题，原子操作</li></ul><h3 id="补充"><a href="#补充" class="headerlink" title="补充"></a>补充</h3><p><a target="_blank" rel="noopener" href="https://gcc.gnu.org/onlinedocs/gcc-4.1.1/gcc/Atomic-Builtins.html">5.44 Built-in functions for atomic memory access</a></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">type __sync_fetch_and_add (type *ptr, type value, ...)</span><br><span class="line">type __sync_fetch_and_sub (type *ptr, type value, ...)</span><br><span class="line">type __sync_fetch_and_or (type *ptr, type value, ...)</span><br><span class="line">type __sync_fetch_and_and (type *ptr, type value, ...)</span><br><span class="line">type __sync_fetch_and_xor (type *ptr, type value, ...)</span><br><span class="line">type __sync_fetch_and_nand (type *ptr, type value, ...)</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">type __sync_add_and_fetch (type *ptr, type value, ...)</span><br><span class="line">type __sync_sub_and_fetch (type *ptr, type value, ...)</span><br><span class="line">type __sync_or_and_fetch (type *ptr, type value, ...)</span><br><span class="line">type __sync_and_and_fetch (type *ptr, type value, ...)</span><br><span class="line">type __sync_xor_and_fetch (type *ptr, type value, ...)</span><br><span class="line">type __sync_nand_and_fetch (type *ptr, type value, ...)</span><br></pre></td></tr></table></figure><ul><li><code>__sync_fetch_and_add</code>: 先<code>fetch</code> 再 <code>add</code></li><li><code>__sync_add_and_fetch</code>: 先<code>add</code> 再 <code>fetch</code></li></ul><h2 id="后续"><a href="#后续" class="headerlink" title="后续"></a>后续</h2><ul><li>上述我们主要是针对<code>objc源码</code>中 <code>引用计数</code> 部分<code>原子操作</code>的实现及其延伸进行了演示；</li><li>当然了，我们依然可以采用常见的<code>锁</code>及<code>信号量</code>来实现；</li></ul></div><div class="post-copyright"><p class="copyright-item"> <span>Author:</span> <a href="http://yotrolz.com">YotrolZ</a></p><p class="copyright-item"> <span>Link:</span> <a href="http://yotrolz.com/posts/3a49a1ae/">http://yotrolz.com/posts/3a49a1ae/</a></p><p class="copyright-item"> <span>License:</span> <a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/" target="_blank">知识共享署名-非商业性使用 4.0 国际许可协议</a></p></div><footer class="post-footer"><nav class="post-nav"><a class="prev" href="/posts/993b4752/"><i class="iconfont icon-left"></i> <span class="prev-text nav-default">再说iOS中的Class</span> <span class="prev-text nav-mobile">Prev</span></a> <a class="next" href="/posts/5013a5ee/"><span class="next-text nav-default">iOS 引用计数中惊艳的原子操作(一)</span> <span class="prev-text nav-mobile">Next</span><i class="iconfont icon-right"></i></a></nav></footer></article></div><div class="comments" id="comments"></div></div></main><footer id="footer" class="footer"><div class="social-links"></div><div class="copyright"> <span class="power-by">Powered by <a class="hexo-link" target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a></span> <span class="division">|</span> <span class="theme-info">Theme - <a class="theme-link" target="_blank" rel="noopener" href="https://github.com/ahonn/hexo-theme-even">Even</a></span> <span class="copyright-year">&copy;2015 - 2022<span class="heart"><i class="iconfont icon-heart"></i></span> <span class="author">YotrolZ</span></span></div></footer><div class="back-to-top" id="back-to-top"><i class="iconfont icon-up"></i></div></div><script type="text/javascript" src="https://cdn.jsdelivr.net/gh/yotrolz/yotrolz.github.io@gh/lib/jquery/jquery.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/gh/yotrolz/yotrolz.github.io@gh/lib/slideout/slideout.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/gh/yotrolz/yotrolz.github.io@gh/lib/fancybox/jquery.fancybox.pack.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/gh/yotrolz/yotrolz.github.io@gh/js/src/even.js?v=2.11.0"></script></body></html>